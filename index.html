<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
<link rel="icon" type="image/png" href="favicon.png">
    <title>Proyección Expensas - Barrio El Centauro</title>
    <!-- Librería SheetJS (js-xlsx) para leer/escribir Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Librería Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plugin doughnut 3D shadow -->
<script>
/* Plugin: doughnutShadow3D
   Añade una sombra suave debajo de cada porción para simular profundidad 3 D.
   Seguro para todos los datasets (evita NaN en createRadialGradient). */
const doughnutShadow3D = {
  id: 'doughnutShadow3D',
  afterDatasetDraw(chart, args, opts) {
    const {ctx} = chart;
    if (args.meta.type !== 'doughnut') return;

    args.meta.data.forEach(segment => {
      const {x, y, startAngle, endAngle, innerRadius, outerRadius} = segment;
      if (!isFinite(x) || !isFinite(y) || !isFinite(innerRadius) || !isFinite(outerRadius)) return;

      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.15)';      // shadow color
      ctx.translate(0, 4);                     // vertical offset
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.arc(x, y, outerRadius, startAngle, endAngle);
      ctx.arc(x, y, innerRadius, endAngle, startAngle, true);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    });
  }
};
// Registrar plugin globalmente
if (window.Chart && !Chart.registry.plugins.get('doughnutShadow3D')) {
  Chart.register(doughnutShadow3D);
}
</script>

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Reset Básico y Fuentes --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; /* Base font size */ }
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.7; /* Improved readability */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Variables de Color (Paleta Refinada) --- */
        :root {
            --bg-color: #f8f9fa;              /* Slightly off-white */
            --text-color: #343a40;            /* Darker gray */
            --primary-color: #007bff;          /* Classic blue */
            --primary-color-darker: #0056b3;   /* Darker blue for hover */
            --secondary-color: #6c757d;        /* Standard gray */
            --secondary-color-darker: #5a6268; /* Darker gray for hover */
            --accent-color: #28a745;           /* Vibrant green */
            --accent-color-darker: #218838;    /* Darker green for hover */
            --danger-color: #dc3545;           /* Red */
            --danger-color-darker: #c82333;    /* Darker red */
            --warning-color: #ffc107;           /* Yellow */
            --warning-color-darker: #e0a800;   /* Darker yellow */
            --info-color: #17a2b8;             /* Teal */
            --info-color-darker: #138496;      /* Darker teal */
            --success-color: var(--accent-color); /* Alias for consistency */
            --success-color-darker: var(--accent-color-darker); /* Alias */

            --border-color: #dee2e6;           /* Light gray border */
            --header-bg: #ffffff;              /* White header */
            --card-bg: #ffffff;                /* White cards */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Softer shadow */
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-focus-border: var(--primary-color);
            --input-focus-shadow: rgba(0, 123, 255, 0.25);
            --button-text: #ffffff;
            --button-warning-text: #212529; /* Dark text for yellow button */
            --table-header-bg: #eef2f7;        /* Lighter table header */
            --table-row-hover: #f1f3f5;        /* Subtle hover */
            --expandable-row-bg: #f8f9fa;      /* Same as body bg for subtle diff */
            --clickable-row-hover: #e9ecef;    /* Slightly darker hover for clickable rows */
            --disabled-bg: #e9ecef;
            --disabled-text: #6c757d;
            --disabled-border: #ced4da;

            /* >>> COLORES REAL/ESTIMADO <<< */
            --real-month-bg: #d1f7d9; /* Light, fresh green */
            --estimated-month-bg: #fff3cd; /* Soft Yellow */
             --estimated-month-border: #ffda6a; /* Yellow border for input */
        }

        body.dark-mode {
            --bg-color: #1a1a1a;              /* Very dark gray */
            --text-color: #e0e0e0;            /* Light gray text */
            --primary-color: #58a6ff;          /* Brighter blue */
            --primary-color-darker: #79b8ff;   /* Lighter blue for hover */
            --secondary-color: #8b949e;        /* Lighter gray */
            --secondary-color-darker: #a0a8b0; /* Lighter gray hover */
            --accent-color: #56d364;           /* Brighter green */
            --accent-color-darker: #6bde7a;    /* Lighter green hover */
            --danger-color: #f85149;           /* Bright red */
            --danger-color-darker: #fa6a61;    /* Lighter red */
            --warning-color: #f0b41e;          /* Bright yellow */
            --warning-color-darker: #f2c037;   /* Lighter yellow */
            --info-color: #6cb6f1;             /* Bright teal */
            --info-color-darker: #85c3f4;      /* Lighter teal */
            --success-color: var(--accent-color);
            --success-color-darker: var(--accent-color-darker);

            --border-color: #444c56;           /* Darker border */
            --header-bg: #2c2c2c;              /* Dark card background */
            --card-bg: #2c2c2c;                /* Dark card background */
            --shadow-color: rgba(255, 255, 255, 0.05); /* Subtle white shadow */
            --input-bg: #3a3f44;
            --input-border: #5a6268;
            --input-focus-border: var(--primary-color);
            --input-focus-shadow: rgba(88, 166, 255, 0.25);
            --button-text: #1a1a1a; /* Dark text on bright buttons */
            --button-warning-text: #1a1a1a;
            --table-header-bg: #343a40;        /* Darker header */
            --table-row-hover: #3e444a;        /* Subtle dark hover */
            --expandable-row-bg: #343a40;      /* Darker expandable row bg */
            --clickable-row-hover: #495057;    /* Darker hover for clickable */
            --disabled-bg: #495057;
            --disabled-text: #adb5bd;
            --disabled-border: #5a6268;

            /* >>> COLORES REAL/ESTIMADO OSCURO <<< */
            --real-month-bg: #1c4a2b; /* Darker Green */
            --estimated-month-bg: #5a4a1d; /* Dark Yellow/Brown */
            --estimated-month-border: #f0b41e; /* Brighter Yellow border for input */
        }

        /* --- Estilos Generales --- */
        .container { width: 95%; max-width: 1700px; margin: 0 auto; padding: 25px 20px; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 1em; font-weight: 600; }
        h1 { font-size: 2.2rem; text-align: center; }
        h2 { font-size: 1.8rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 0.4em; }
        h3 { font-size: 1.4rem; margin-top: 1.8em; }
        h4 { font-size: 1.15rem; color: var(--secondary-color); margin-top: 1.2em; margin-bottom: 0.6em; }
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: var(--primary-color-darker); text-decoration: underline; }

        button {
            padding: 12px 22px;
            border: 1px solid transparent; /* Added border for consistency */
            border-radius: 6px;
            background-color: var(--primary-color);
            color: var(--button-text);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.5; /* Ensure consistent height */
            text-align: center; /* Ensure text aligns center */
        }
        button:hover {
            background-color: var(--primary-color-darker);
            border-color: var(--primary-color-darker);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem var(--input-focus-shadow);
        }
        button:disabled {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            border-color: var(--disabled-border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button i { margin-right: 2px; /* Keep small margin */ }

        /* Button variants */
        .button-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--button-text); }
        .button-primary:hover { background-color: var(--primary-color-darker); border-color: var(--primary-color-darker); }
        .button-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: var(--button-text); }
        .button-secondary:hover { background-color: var(--secondary-color-darker); border-color: var(--secondary-color-darker); }
        .button-success { background-color: var(--success-color); border-color: var(--success-color); color: var(--button-text); }
        .button-success:hover { background-color: var(--success-color-darker); border-color: var(--success-color-darker); }
        .button-danger { background-color: var(--danger-color); border-color: var(--danger-color); color: var(--button-text); }
        .button-danger:hover { background-color: var(--danger-color-darker); border-color: var(--danger-color-darker); }
        .button-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--button-warning-text); }
        .button-warning:hover { background-color: var(--warning-color-darker); border-color: var(--warning-color-darker); }
        .button-info { background-color: var(--info-color); border-color: var(--info-color); color: var(--button-text); }
        .button-info:hover { background-color: var(--info-color-darker); border-color: var(--info-color-darker); }
        .button-sm { padding: 6px 12px; font-size: 0.85rem; gap: 6px;}

        /* --- Header --- */
        header {
            background-color: var(--header-bg);
            padding: 15px 0;
            box-shadow: 0 2px 5px var(--shadow-color);
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        header .container { display: flex; justify-content: space-between; align-items: center; padding-top: 0; padding-bottom: 0; }
        .app-title { font-size: 1.6rem; font-weight: 700; color: var(--primary-color); }
        #theme-toggle { font-size: 1.3rem; background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s;}
        #theme-toggle:hover { background-color: var(--table-row-hover); }

        /* --- Navegación / Pestañas --- */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 5px;
        }
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px; /* Overlap bottom border */
            background-color: transparent;
            color: var(--secondary-color);
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 8px;
        }
        .tab-link:hover {
             color: var(--primary-color);
             background-color: var(--table-row-hover);
        }
        .tab-link.active {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-bottom-color: var(--card-bg); /* Hide bottom border part */
            color: var(--primary-color);
            font-weight: 700;
        }
        .tab-content {
            display: none;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-top: none;
            background-color: var(--card-bg);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Formularios y Entradas --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 0.95rem;}
        input[type="text"], input[type="number"], input[type="file"], select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--input-focus-border);
            outline: 0;
            box-shadow: 0 0 0 0.25rem var(--input-focus-shadow);
        }
        input:disabled, select:disabled, textarea:disabled {
             background-color: var(--disabled-bg);
             color: var(--disabled-text);
             border-color: var(--disabled-border);
             cursor: not-allowed;
        }
        input[type="number"] { text-align: right; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { margin: 0; }
        input[type="file"] { padding: 8px; line-height: 1.5; } /* Adjust file input padding */
        .input-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .input-group label { margin-bottom: 0; font-weight: normal;}
        .input-group input[type="radio"] { width: auto; margin-right: 5px; }
        .input-small { width: 150px; display: inline-block; margin-left: 10px; }

        /* --- Tablas --- */
        .table-container { overflow-x: auto; margin-top: 25px; border: 1px solid var(--border-color); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); font-size: 0.9rem; }
        th, td {
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
        }
        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            position: sticky; top: 0; z-index: 10;
            border-bottom-width: 2px;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--table-row-hover); }
        th:first-child, td:first-child { border-left: none; padding-left: 20px; /* More padding for first col */ }
        th:last-child, td:last-child { border-right: none; padding-right: 20px; /* More padding for last col */}

        /* Cell specific styles */
        td.real-month-cell { background-color: var(--real-month-bg) !important; /* Use important to override hover */ }
        td.estimated-month-cell { background-color: var(--estimated-month-bg) !important; }
        td.number-cell { text-align: right; font-variant-numeric: tabular-nums; }
        td.input-cell input { width: 100px; padding: 6px; font-size: 0.9rem; text-align: right; }
        td.input-cell input:disabled { background-color: transparent; border: none; color: var(--disabled-text);}
        .text-muted { color: var(--secondary-color); font-style: italic; font-size: 0.9em;}

        /* --- Tablas Desplegables --- */
        .collapsible-table tbody tr.rubro-total-row { font-weight: bold; cursor: pointer; background-color: var(--expandable-row-bg); transition: background-color 0.2s; }
        .collapsible-table tbody tr.rubro-total-row:hover { background-color: var(--clickable-row-hover); }
        .collapsible-table tbody tr.rubro-total-row td:first-child::before {
            content: '\f078'; /* fa-chevron-down */
            font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 12px; display: inline-block; transition: transform 0.2s ease-in-out; color: var(--primary-color);
        }
        .collapsible-table tbody tr.rubro-total-row.collapsed td:first-child::before { transform: rotate(-90deg); }
        .collapsible-table tbody tr.detail-row { display: table-row; background-color: var(--card-bg); transition: background-color 0.3s; }
        .collapsible-table tbody tr.detail-row.hidden { display: none; }
        .collapsible-table tbody tr.detail-row td { font-size: 0.85rem; color: var(--secondary-color); border-color: var(--border-color); }
        .collapsible-table tbody tr.detail-row td:first-child { padding-left: 40px; /* Indent details more */ }
        body.dark-mode .collapsible-table tbody tr.detail-row { background-color: #353535; }
        .collapsible-table tfoot tr { font-weight: bold; background-color: var(--table-header-bg); border-top: 2px solid var(--border-color); }

         /* Styles for Group/Ungroup All buttons */
        .table-actions {
            margin-bottom: 15px;
             display: flex;
             justify-content: flex-end; /* Align buttons to the right */
             gap: 10px;
             flex-wrap: wrap;
        }


        /* --- Componentes UI Específicos --- */
        #dashboard-summary { border-collapse: separate; border-spacing: 0; }
        #dashboard-summary th, #dashboard-summary td { text-align: center; white-space: normal; }
        #dashboard-summary tbody td, #dashboard-summary tfoot td { padding: 10px 8px; }
        #dashboard-summary .month-header { font-weight: bold; }

        .chart-container {
            margin-top: 35px; padding: 30px;
            background-color: var(--card-bg); border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            position: relative; min-height: 200px; /* Adjusted min height */
        }
        .chart-container canvas { max-width: 100%; height: 380px !important; }
        .chart-no-data { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-color); font-style: italic; font-size: 1.1rem; text-align: center; }

        #file-upload-area {
            border: 2px dashed var(--primary-color);
            padding: 45px; text-align: center; background-color: var(--bg-color);
            border-radius: 8px; margin-bottom: 25px; transition: background-color 0.2s ease, border-color 0.2s ease; cursor: pointer;
        }
        #file-upload-area:hover { background-color: var(--table-row-hover); border-color: var(--primary-color-darker); }
        #file-upload-area p { margin-bottom: 15px; font-size: 1.1rem; color: var(--secondary-color); }
        #file-upload-area i.fa-file-excel { font-size: 3rem; margin-bottom: 10px; color: var(--accent-color); }
        #file-upload-feedback { margin-top: 15px; font-weight: bold; white-space: pre-wrap; font-size: 0.95rem; min-height: 2em; }

        #reserve-fund-panel { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px;} /* MODIFICADO: Usar grid como IPC */
        #reserve-fund-panel .month-config { /* Removed flex styles, grid handles layout */ padding: 0; border-radius: 0; background-color: transparent; transition: none; }
        #reserve-fund-panel .month-config label { width: 100%; margin-bottom: 5px; font-weight: 600;}
        #reserve-fund-panel .month-config input { width: 100%; }
        #reserve-fund-panel .month-config span { margin-left: 5px; color: var(--secondary-color); font-size: 0.9em; } /* Style the unit */


        .config-section {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 25px;
            margin-bottom: 30px; background-color: var(--card-bg);
            box-shadow: 0 3px 7px var(--shadow-color);
        }
        .config-section h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.6em; margin-bottom: 1.2em;}
        .management-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: var(--bg-color); }
        body.dark-mode .management-list { background-color: #3a3f44; }
        .management-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .management-list li:last-child { border-bottom: none;}
        .management-list li:hover { background-color: var(--table-row-hover); }
        .management-list li span { flex-grow: 1; margin-right: 15px; font-weight: 500; }
        .management-list li select { width: 200px; font-size: 0.88rem; padding: 6px 8px; flex-shrink: 0; }
        .management-list li button { flex-shrink: 0; }

         /* Styles for the NEW Coefficient Editor */
         #coefficient-editor { margin-top: 25px; }
         #coefficient-editor h4 { margin-bottom: 15px;}
         #coefficient-values-editor {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Similar grid to IPC */
             gap: 20px;
             padding: 20px; /* Add padding */
             border: 1px solid var(--border-color); /* Add border */
             border-radius: 6px; /* Add border-radius */
             background-color: var(--bg-color); /* Background like other lists/panels */
         }
         body.dark-mode #coefficient-values-editor { background-color: #3a3f44; }

         #coefficient-values-editor .form-group { margin-bottom: 0; } /* Adjust form-group margin inside grid */
         #coefficient-values-editor .form-group label { margin-bottom: 5px; font-weight: 600; width: 100%;} /* Adjust label */
         #coefficient-values-editor .form-group input { width: 100%; max-width: none; } /* Allow input to fill grid cell */
         #coefficient-values-editor .text-muted { grid-column: 1 / -1; text-align: center; padding: 20px; } /* Center and span info message */


        /* --- Snackbar --- */
        #snackbar {
            visibility: hidden; min-width: 300px; max-width: 90%;
            background-color: var(--success-color); /* Default to success */
            color: var(--button-text); text-align: center;
            border-radius: 6px; padding: 18px 25px; position: fixed; z-index: 1001;
            left: 50%; transform: translateX(-50%); bottom: 30px;
            font-size: 1.05rem; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; transition: visibility 0s 0.5s, opacity 0.5s ease-out, bottom 0.5s ease-out;
        }
        #snackbar.show {
            visibility: visible; opacity: 1; bottom: 60px;
            transition: opacity 0.5s ease-in, bottom 0.5s ease-in;
        }
        #snackbar.error { background-color: var(--danger-color); color: var(--button-text); }
        #snackbar.warning { background-color: var(--warning-color); color: var(--button-warning-text); }
        #snackbar.info { background-color: var(--info-color); color: var(--button-text); }


        /* --- Footer --- */
        footer {
            margin-top: auto; padding: 20px 0; text-align: center; font-size: 0.95em;
            color: var(--secondary-color); background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) { .container { width: 98%; } .chart-container canvas { height: 320px !important; } }
        @media (max-width: 992px) {
             h1 { font-size: 2rem; } h2 { font-size: 1.6rem; } h3 { font-size: 1.3rem; }
             .tabs { justify-content: flex-start; }
             .tab-link { padding: 10px 18px; font-size: 0.95rem;}
             table { font-size: 0.88rem; } th,td {padding: 10px 12px;}
             .management-list li select { width: 150px; } /* Reduce select width */
        }
        @media (max-width: 768px) {
            body { line-height: 1.6; }
            .app-title { font-size: 1.3rem;} #theme-toggle { font-size: 1.1rem;}
            .chart-container { padding: 20px;} .chart-container canvas { height: 280px !important; }
            .input-group { flex-direction: column; align-items: stretch; gap: 10px;}
            .input-small { margin-left: 0; margin-top: 8px; width: 100%; }
            /* Adjust Reserve Fund and Coefficient Editor grid columns */
            #reserve-fund-panel, #coefficient-values-editor, #ipc-inputs { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;}
            #reserve-fund-panel .month-config label { width: 100%; text-align: left; margin-bottom: 5px; }
            #reserve-fund-panel .month-config input { width: 100%; }
            table { font-size: 0.85rem; } th, td { padding: 9px 8px; white-space: normal; } /* Allow wrap */
            th:first-child, td:first-child { padding-left: 15px; }
            th:last-child, td:last-child { padding-right: 15px; }
            td.input-cell input { width: 80px; padding: 5px; }
            .management-list li { flex-wrap: wrap; gap: 8px; }
            .management-list li span { flex-basis: 100%; margin-right: 0; } /* Name takes full width */
            .management-list li select { width: calc(100% - 50px); margin-top: 5px; } /* Select almost full width */
            .management-list li button { margin-left: auto; } /* Push button right */
            button { font-size: 0.95rem; padding: 10px 18px;}
            .tabs { gap: 2px; }
            .tab-link { padding: 8px 10px; font-size: 0.85rem;}
             .table-actions { justify-content: center; }
        }
        @media (max-width: 576px) {
            h1 { font-size: 1.7rem; } .app-title { display: none; } header .container { justify-content: flex-end; }
            .tab-link { padding: 8px 10px; font-size: 0.85rem;}
            th, td { padding: 8px 6px; }
            th:first-child, td:first-child { padding-left: 10px; }
            th:last-child, td:last-child { padding-right: 10px; }
            .chart-container canvas { height: 220px !important; }
            #snackbar { min-width: 90%; bottom: 20px; font-size: 1rem; padding: 15px 20px; }
            #snackbar.show { bottom: 40px; }
            #file-upload-area { padding: 30px; }
            .management-list li select { width: 100%; } /* Select full width on smallest screens */
             /* Adjust Reserve Fund and Coefficient Editor grid columns */
             #reserve-fund-panel, #coefficient-values-editor, #ipc-inputs { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <span class="app-title">Proyección Expensas - El Centauro</span>
            <button id="theme-toggle" title="Cambiar tema"><i class="fas fa-moon"></i></button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="tab-link" onclick="openTab(event, 'upload')"><i class="fas fa-upload"></i> Cargar Datos</button>
            <button class="tab-link" onclick="openTab(event, 'reserve')"><i class="fas fa-piggy-bank"></i> Fondo Reserva</button>
            <button class="tab-link" onclick="openTab(event, 'settings')"><i class="fas fa-cog"></i> Configuración</button>
            <button class="tab-link" onclick="openTab(event, 'reports')"><i class="fas fa-download"></i> Reportes</button>
        </div>

        <!-- ==================== DASHBOARD ==================== -->
        <div id="dashboard" class="tab-content active">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Anual - <span id="dashboard-year"></span> (<span id="dashboard-scenario">Base</span>)</h2>
            <div class="form-group input-group">
                <label for="scenario-selector" style="flex-shrink: 0;">Escenario:</label>
                <select id="scenario-selector" style="flex-grow: 1;"></select>
                <button onclick="createScenario()" class="button-primary button-sm" title="Crear Escenario Nuevo"><i class="fas fa-plus"></i> Crear</button>
                <button onclick="cloneScenario()" class="button-secondary button-sm" title="Clonar Escenario Actual"><i class="fas fa-clone"></i> Clonar</button>
                <button onclick="deleteScenario()" class="button-danger button-sm" title="Eliminar Escenario Actual"><i class="fas fa-trash"></i> Eliminar</button>
                <button id="btnBorrarDatos" class="button-warning button-sm" title="Borrar Datos del Escenario Actual (Gastos, Ingresos, Status)" onclick="clearScenarioData()" ><i class="fas fa-broom"></i> Borrar Datos</button>
                <button onclick="recalculateEstimates()" class="button-info button-sm" title="Proyectar meses estimados basados en último mes real y coeficientes (acumulativo)"><i class="fas fa-calculator"></i> Calcular Estimados</button>
            </div>

            <h4>Resumen Mensual General</h4>
            <div class="table-container">
                <table id="dashboard-summary">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Gasto ($)</th>
                            <th>Fondo ($)</th>
                            <th>Cuota s/Gs ($/UF)</th> <!-- Basado en Gasto+Fondo / UF -->
                            <th>IPC (%)</th>
                            <th>Cuota IPC ($/UF)</th>   <!-- NUEVO: Cuota s/Gs * (1 + IPC%) -->
                            <!-- MODIFICACIÓN INICIO - Encabezado de tabla -->
                            <th>Expensa Real ($/UF)</th> <!-- Ahora muestra el valor del rubro Expensas Ordinarias / UF -->
                            <!-- MODIFICACIÓN FIN -->
                        </tr>
                    </thead>
                    <tbody><!-- Contenido generado por JS --></tbody>
                    <tfoot><!-- Contenido generado por JS --></tfoot>
                </table>
            </div>

            <h4 style="margin-top: 30px;">Detalle de Gastos Proyectados ($)</h4>
             <p class="text-muted" style="font-size: 0.9em;">Haga clic en una fila de rubro para expandir/colapsar los detalles. Las celdas mensuales de detalle se colorean según su origen: <span style="background-color: var(--real-month-bg); padding: 1px 4px; border-radius: 3px;">REAL</span> (cargado desde Excel con número) o <span style="background-color: var(--estimated-month-bg); padding: 1px 4px; border-radius: 3px;">ESTIMADO</span> (cargado sin número o proyectado/calculado).</p>

            <!-- Added Group/Ungroup Buttons for Gastos -->
            <div class="table-actions">
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('gastos', false)" title="Expandir todos los detalles de gastos"><i class="fas fa-expand"></i> Expandir Todo</button>
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('gastos', true)" title="Colapsar todos los detalles de gastos"><i class="fas fa-compress"></i> Colapsar Todo</button>
            </div>

            <div class="table-container">
                <table id="gastos-detail-table" class="collapsible-table">
                     <thead>
                        <tr>
                            <th>Rubro / Detalle</th>
                            <th>Coef. Aplicado</th> <!-- Add Coef. column header -->
                            <!-- Meses y Total Anual generados por JS -->
                         </tr>
                     </thead>
                     <tbody><!-- Contenido generado por JS --></tbody>
                     <tfoot><!-- Contenido generado por JS --></tfoot>
                </table>
            </div>

            <h4 style="margin-top: 30px;">Detalle de Ingresos Proyectados ($)</h4>
             <p class="text-muted" style="font-size: 0.9em;">Haga clic en una fila de rubro para expandir/colapsar. Los valores aquí son la base de cálculo (valor individual o por UF). El Total de Ingresos en el Resumen General puede incluir la multiplicación por UF.</p>

             <!-- Added Group/Ungroup Buttons for Ingresos -->
             <div class="table-actions">
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('ingresos', false)" title="Expandir todos los detalles de ingresos"><i class="fas fa-expand"></i> Expandir Todo</button>
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('ingresos', true)" title="Colapsar todos los detalles de ingresos"><i class="fas fa-compress"></i> Colapsar Todo</button>
            </div>

            <div class="table-container">
                 <table id="ingresos-detail-table" class="collapsible-table">
                      <thead>
                         <tr>
                            <th>Rubro / Detalle</th>
                             <!-- Meses y Total Anual generados por JS -->
                         </tr>
                       </thead>
                      <tbody><!-- Contenido generado por JS --></tbody>
                      <tfoot><!-- Contenido generado por JS --></tfoot>
                 </table>
            </div>

            <div class="chart-container">
                 <h3>Evolutivo Expensa Mensual ($/UF)</h3> <!-- MODIFICADO -->
                 <canvas id="evolutivoCuotaChart"></canvas>
                 <div class="chart-no-data" style="display: none;">No hay datos suficientes para graficar.</div>
            </div>

            <div style="display: flex; gap: 25px; flex-wrap: wrap; margin-top: 35px;">
                <div class="chart-container" style="flex: 1; min-width: 320px;">
                    <h3>Participación Gastos (%)</h3>
                    <canvas id="participacionGastosChart"></canvas>
                    <div class="chart-no-data" style="display: none;">No hay datos de gastos<br>para mostrar el gráfico.</div>
                </div>
                <div class="chart-container" style="flex: 1; min-width: 320px;">
                    <h3>Participación Ingresos (%)</h3>
                    <canvas id="participacionIngresosChart"></canvas>
                    <div class="chart-no-data" style="display: none;">No hay datos de ingresos<br>para mostrar el gráfico.</div>
                </div>
            </div>
        </div>

        <!-- ==================== UPLOAD ==================== -->
        <div id="upload" class="tab-content">
            <h2><i class="fas fa-upload"></i> Cargar Datos Reales / Base</h2>
            <div class="form-group input-group">
                <label for="exercise-year">Año del Ejercicio:</label>
                <input type="number" id="exercise-year" min="2020" max="2099" value="2024" style="width: 120px;">
                <button onclick="createNewExercise()" class="button-success"><i class="fas fa-calendar-plus"></i> Crear/Seleccionar Año</button>
             </div>
            <p>Sube tu archivo Excel con las hojas <strong>"Gastos"</strong> e <strong>"Ingresos"</strong>. Los rubros nuevos se añadirán automáticamente a la sección de Configuración.</p>
            <p><strong>Importante:</strong>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Las celdas con **números** en la hoja "Gastos" marcarán ese mes/detalle como '<strong style="color: var(--accent-color)">REAL</strong>' (fondo verde claro en detalle). Las celdas vacías o con texto se considerarán '<strong style="color: var(--warning-color)">ESTIMADO</strong>'.</li>
                    <li>Los rubros de Ingreso llamados "<strong id="cuota-rubro-name-info">Expensas Ordinarias</strong>" y "<strong>Expensas Extraordinarias</strong>" tendrán sus valores base multiplicados por la cantidad de UF (definida en Configuración) al calcular el *total* de ingresos en el Resumen General. La columna "Expensa Real ($/UF)" en el resumen muestra el valor del rubro "<strong id="cuota-rubro-name-info2">Expensas Ordinarias</strong>" <strong style="color: var(--primary-color)">dividido por la cantidad de UF</strong>.</li>
                </ul>
            </p>
            <div id="file-upload-area" onclick="document.getElementById('excel-file-input').click()">
                 <p><i class="fas fa-file-excel"></i><br>Arrastra tu archivo Excel aquí (.xlsx, .xls) o haz clic para seleccionar</p>
                 <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(this.files)">
                 <button type="button" class="button-primary" onclick="event.stopPropagation(); document.getElementById('excel-file-input').click()" style="pointer-events: auto;"><i class="fas fa-folder-open"></i> Seleccionar Archivo</button>
                 <button type="button" onclick="event.stopPropagation(); loadSampleData()" style="margin-left: 10px; pointer-events: auto;" class="button-secondary"><i class="fas fa-database"></i> Cargar Datos Ejemplo</button>
            </div>
            <div id="file-upload-feedback"></div>
            <a href="#" onclick="event.preventDefault(); downloadTemplate();" title="Descargar archivo Excel con estructura de ejemplo"><i class="fas fa-download"></i> Descargar Plantilla Ejemplo</a>
        </div>

        <!-- ==================== RESERVE FUND ==================== -->
        <div id="reserve" class="tab-content">
             <h2><i class="fas fa-piggy-bank"></i> Configurar Fondo de Reserva - <span class="current-year"></span> (<span class="current-scenario">Base</span>)</h2>
             <div class="form-group">
                 <label>Método de Cálculo del Fondo:</label>
                 <div class="input-group">
                     <input type="radio" id="reserve-type-percent" name="reserve-type" value="percent" checked onchange="updateReserveUI()">
                     <label for="reserve-type-percent">Porcentaje (%) sobre Gastos Mensuales</label>
                     <input type="radio" id="reserve-type-fixed" name="reserve-type" value="fixed" onchange="updateReserveUI()">
                     <label for="reserve-type-fixed">Valor Fijo Mensual ($)</label>
                 </div>
             </div>
             <div id="reserve-fund-panel">
                 <!-- Inputs generados por JS -->
             </div>
             <button onclick="saveReserveFund()" style="margin-top: 25px; width: 100%; padding: 15px;" class="button-success button-lg" title="Guardar los valores mensuales y el tipo de cálculo del fondo">
                 <i class="fas fa-save"></i> GUARDAR FONDO DE RESERVA Y RECALCULAR
            </button>
        </div>

        <!-- ==================== SETTINGS ==================== -->
        <div id="settings" class="tab-content">
             <h2><i class="fas fa-cog"></i> Configuración General y de Cálculo</h2>

             <div class="config-section">
                 <h4><i class="fas fa-building"></i> Ajustes Generales del Barrio</h4>
                 <div class="form-group">
                     <label for="cantidad-unidades">Cantidad Total de Unidades Funcionales (UF):</label>
                     <input type="number" id="cantidad-unidades" min="1" value="100" style="width: 180px;" title="Número total de UF para calcular cuotas base">
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-list-alt"></i> Gestión de Rubros (Categorías)</h4>
                 <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                     <div style="flex: 1; min-width: 320px;">
                         <h5><i class="fas fa-arrow-down" style="color:var(--danger-color)"></i> Rubros de GASTOS</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-gasto-rubro-name" placeholder="Nombre nuevo rubro de gasto" style="flex-grow: 1;">
                             <button onclick="addRubro('gastos')" class="button-sm button-success" title="Añadir este nuevo rubro a la lista de gastos"><i class="fas fa-plus"></i> Añadir</button>
                         </div>
                         <ul id="gasto-rubro-list" class="management-list"></ul>
                     </div>
                     <div style="flex: 1; min-width: 320px;">
                          <h5><i class="fas fa-arrow-up" style="color:var(--success-color)"></i> Rubros de INGRESOS</h5>
                          <div class="form-group input-group">
                              <input type="text" id="new-ingreso-rubro-name" placeholder="Nombre nuevo rubro de ingreso" style="flex-grow: 1;">
                              <button onclick="addRubro('ingresos')" class="button-sm button-success" title="Añadir este nuevo rubro a la lista de ingresos"><i class="fas fa-plus"></i> Añadir</button>
                          </div>
                          <ul id="ingreso-rubro-list" class="management-list"></ul>
                     </div>
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-percentage"></i> Gestión de Coeficientes de Ajuste (para Gastos Estimados)</h4>
                 <p class="text-muted" style="font-size: 0.9em;">Define tipos de coeficientes (ej. Inflación, Aumento Gremial) y asigna uno a cada rubro de Gasto. Al usar "Calcular Estimados" en el Dashboard, el sistema proyectará los meses sin datos '<strong style="color: var(--accent-color)">REAL</strong>' (marcados en amarillo) multiplicando el último valor '<strong style="color: var(--accent-color)">REAL</strong>' por el coeficiente acumulado correspondiente a cada mes futuro.</p>
                 <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                     <div style="flex: 1; min-width: 280px;">
                         <h5>Tipos de Coeficientes Disponibles</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-coefficient-type-name" placeholder="Nuevo tipo (ej: Aumento Sindicato)" style="flex-grow: 1;">
                             <button onclick="addCoefficientType()" class="button-sm button-success" title="Añadir este nuevo tipo de coeficiente a la lista"><i class="fas fa-plus"></i> Añadir Tipo</button>
                         </div>
                         <ul id="coefficient-type-list" class="management-list"></ul>
                     </div>
                     <div id="coefficient-editor" style="flex: 2; min-width: 450px;">
                          <h5><i class="fas fa-edit"></i> Editar Valores Mensuales para: <span id="editing-coefficient-name" style="color: var(--primary-color); font-weight: bold;"></span></h5>
                           <!-- MODIFICACIÓN FIX: Reemplazar tabla por grid similar a IPC -->
                          <div id="coefficient-values-editor">
                              <p class="text-muted">Selecciona un tipo de coeficiente (que no sea "Sin Coeficiente" o "IPC") de la lista de la izquierda para editar sus valores porcentuales (%) mes a mes.</p>
                          </div>
                         <!-- END MODIFICACIÓN FIX -->
                     </div>
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-chart-line"></i> Índices IPC Mensuales de Referencia (%)</h4>
                 <p class="text-muted">Introduce el porcentaje (%) de IPC estimado o real para cada mes. Se usa únicamente para calcular la columna "Cuota IPC ($/UF)" como referencia en el Dashboard y está disponible como tipo de coeficiente ("IPC"). Sus valores son gestionados en esta sección y se reflejan en la lista de tipos de coeficientes.</p> <!-- MODIFICACIÓN FIX: Clarify IPC usage -->
                 <div id="ipc-inputs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px;">
                     <!-- Inputs generados por JS -->
                 </div>
             </div>

             <button onclick="saveSettings()" style="margin-top: 20px; width: 100%; padding: 15px;" class="button-success button-lg" title="Guardar todos los cambios realizados en esta pestaña (UF, Rubros, Coeficientes, IPC) y recalcular el escenario actual">
                 <i class="fas fa-save"></i> GUARDAR TODA LA CONFIGURACIÓN Y RECALCULAR
             </button>
        </div>

        <!-- ==================== REPORTS ==================== -->
        <div id="reports" class="tab-content">
             <h2><i class="fas fa-download"></i> Descargar Reportes - <span class="current-year"></span> (<span class="current-scenario">Base</span>)</h2>
             <p>Genera y descarga los datos del ejercicio y escenario actual en formato Excel, incluyendo detalles y resumen.</p>
             <button onclick="exportToExcel()" class="button-success" title="Descargar un archivo .xlsx con el detalle y resumen del escenario actual"><i class="fas fa-file-excel"></i> Descargar Reporte Completo (.xlsx)</button>

             <h3 style="margin-top: 35px;">Exportar Gráficos Individuales</h3>
             <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                 <button onclick="exportChart('evolutivoCuotaChart', 'evolutivo_expensa.png')" class="button-secondary" title="Descargar el gráfico de evolución de expensas como imagen PNG"><i class="fas fa-chart-line"></i> Gráfico Evolutivo (PNG)</button> <!-- MODIFICADO -->
                 <button onclick="exportChart('participacionGastosChart', 'participacion_gastos.png')" class="button-secondary" title="Descargar el gráfico de torta de gastos como imagen PNG"><i class="fas fa-chart-pie"></i> Gráfico Gastos (PNG)</button>
                 <button onclick="exportChart('participacionIngresosChart', 'participacion_ingresos.png')" class="button-secondary" title="Descargar el gráfico de torta de ingresos como imagen PNG"><i class="fas fa-chart-pie"></i> Gráfico Ingresos (PNG)</button>
             </div>
        </div>
    </div> <!-- /container -->

    <footer>
        <div class="container">
            &copy; <span id="footer-year"></span> Proyección Expensas El Centauro. v2.9 (Rubros Fix)
        </div>
    </footer>
    <div id="snackbar">Mensaje</div>

    <!-- ==================== SCRIPT PRINCIPAL ==================== -->
    <script>
        // --- Constantes y Estado Global ---
        const MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const FULL_MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        const GASTOS_SHEET_NAME = "Gastos";
        const INGRESOS_SHEET_NAME = "Ingresos";
        const STORAGE_KEY = 'expensasAppCentauroState_v2.9_RubrosFix';
        const CUOTA_RUBRO_NAME = "Expensas Ordinarias";
        const EXTRA_CUOTA_RUBRO_NAME = "Expensas Extraordinarias";
        const SPECIAL_INGRESO_RUBROS = [CUOTA_RUBRO_NAME, EXTRA_CUOTA_RUBRO_NAME];

        let appState = getDefaultAppState();

        let evolutivoCuotaChart_instance = null;
        let participacionGastosChart_instance = null;
        let participacionIngresosChart_instance = null;

        // --- Gestión de Estado ---
        function getDefaultAppState() {
            const defaultYear = new Date().getFullYear();
            const baseScenarioStructure = {
                year: defaultYear,
                scenarioName: 'Base',
                rubroOrder: { gastos: [], ingresos: [] },
                data: { gastos: {}, ingresos: {} },
                monthStatus: { gastos: {}, ingresos: {} },
                reserveFund: { type: 'percent', values: Array(12).fill(5) },
                calculated: {
                    gastoAjustado: {}, totalGastoRubroMes: {}, totalGastoProyectadoMes: Array(12).fill(0),
                    ingresoAjustado: {}, totalIngresoRubroMes: {}, totalIngresoProyectadoMes: Array(12).fill(0),
                    fondoReservaMes: Array(12).fill(0),
                    cuotaSobreGastosMes: Array(12).fill(0),
                    ipcManual: Array(12).fill(0),
                    cuotaIpcMes: Array(12).fill(0),
                    cuotaRealBaseMes: Array(12).fill(0),
                    annualTotals: { gastos: {__TOTAL__:0}, ingresos: {__TOTAL__:0}, fondoReserva: 0, cuotaSobreGastos: 0, cuotaIpc: 0, cuotaRealBase: 0 }
                }
            };
            const defaultSettings = {
                 cantidadUnidades: 100,
                 rubros: { gastos: [], ingresos: [] },
                 rubroConfig: {},
                 coefficientTypes: {
                     "None": { name: "Sin Coeficiente", values: Array(12).fill(1), isDefault: true },
                     "IPC": { name: "IPC", values: Array(12).fill(0), isDefault: true },
                     "UTEDYC": { name: "UTEDYC (Ejemplo)", values: [0, 0, 10, 0, 0, 8, 0, 0, 7, 0, 0, 5], isDefault: true },
                 },
                 ipcManual: [5, 4, 6, 3, 4, 5, 3, 4, 5, 6, 4, 5]
            };
            return {
                 currentYear: defaultYear,
                 scenarios: {},
                 activeScenarioKey: null,
                 settings: defaultSettings,
                 uiState: { editingCoefficientType: null },
                 darkMode: false,
                 BaseScenarioStructureTemplate: baseScenarioStructure
             };
         }

        function loadState() {
             try {
                 const savedState = localStorage.getItem(STORAGE_KEY);
                 if (savedState) {
                     const loadedState = JSON.parse(savedState);
                     appState = deepMerge(getDefaultAppState(), loadedState);
                    if (!appState.settings) appState.settings = getDefaultAppState().settings;
                    if (!appState.settings.rubros || typeof appState.settings.rubros !== 'object' || appState.settings.rubros === null) appState.settings.rubros = { gastos: [], ingresos: [] };
                    if (!Array.isArray(appState.settings.rubros.gastos)) appState.settings.rubros.gastos = [];
                    if (!Array.isArray(appState.settings.rubros.ingresos)) appState.settings.rubros.ingresos = [];
                 } else {
                     appState = getDefaultAppState();
                 }
             } catch (e) {
                 console.error(`Error cargando estado desde localStorage con key "${STORAGE_KEY}":`, e);
                 showSnackbar(`Error cargando estado guardado. Usando valores por defecto.`, true, 'error', 8000);
                 appState = getDefaultAppState();
             }
        }

        function saveState() {
             try {
                 const stateToSave = {
                     currentYear: appState.currentYear,
                     scenarios: appState.scenarios,
                     activeScenarioKey: appState.activeScenarioKey,
                     settings: appState.settings,
                     darkMode: appState.darkMode,
                 };
                 localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
             } catch (e) {
                 console.error(`Error guardando estado a localStorage con key "${STORAGE_KEY}":`, e);
                 showSnackbar("Error al guardar estado en el navegador.", true, 'error', 6000);
             }
         }

        function deepMerge(target, source) {
             const output = { ...target };
             if (isObject(target) && isObject(source)) {
                 Object.keys(source).forEach(key => {
                     const targetValue = target[key];
                     const sourceValue = source[key];
                     if (isObject(sourceValue) && isObject(targetValue)) {
                         output[key] = deepMerge(targetValue, sourceValue);
                     } else if (Array.isArray(sourceValue)) {
                         output[key] = [...sourceValue];
                     } else {
                           output[key] = sourceValue;
                     }
                 });
             }
             return output;
         }

        function isObject(item) {
             return (item !== null && typeof item === 'object' && !Array.isArray(item));
        }

        // --- Utilidades Generales y de UI Pequeñas ---
        function formatCurrency(value) {
             const num = Number(value);
             if (isNaN(num) || !isFinite(num)) return "$ 0,00";
             try {
                 return `$ ${num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
             } catch (e) { return `$ ${num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`; }
        }

        function hexToRgba(hex, alpha) {
            hex = String(hex || '#000000').trim().replace('#', '');
            if (!/^[0-9A-F]{3,6}$/i.test(hex)) hex = '000000';
            if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            if (isNaN(r) || isNaN(g) || isNaN(b)) return `rgba(0,0,0,${alpha})`;
            const validAlpha = typeof alpha === 'number' ? Math.max(0, Math.min(1, alpha)) : 1;
            return `rgba(${r}, ${g}, ${b}, ${validAlpha})`;
        }

        function showSnackbar(message, isError = false, level = null, duration = 4000) {
             const snackbar = document.getElementById('snackbar');
             if (!snackbar) return;
             snackbar.textContent = message;
             let effectiveLevel = level ?? (isError ? 'error' : 'success');
             snackbar.className = 'show';
             snackbar.classList.remove('error', 'warning', 'info');
             if (effectiveLevel === 'error') snackbar.classList.add('error');
             else if (effectiveLevel === 'warning') snackbar.classList.add('warning');
             else if (effectiveLevel === 'info') snackbar.classList.add('info');
             if (snackbar.timer) clearTimeout(snackbar.timer);
             snackbar.timer = setTimeout(() => { snackbar.className = ''; snackbar.timer = null; }, duration);
         }

        function destroyChart(canvasId) {
             if (window[`${canvasId}_instance`]) {
                window[`${canvasId}_instance`].destroy();
                window[`${canvasId}_instance`] = null;
             }
         }

        function displayChartNoData(canvasId, show) {
            const container = document.getElementById(canvasId)?.parentElement;
            const noDataElement = container?.querySelector('.chart-no-data');
            if (noDataElement) noDataElement.style.display = show ? 'block' : 'none';
            const canvasElement = document.getElementById(canvasId);
            if (canvasElement) canvasElement.style.display = show ? 'none' : 'block';
        }

        function generateColors(count, palette, alpha = 1) {
            const colors = [];
            for (let i = 0; i < count; i++) colors.push(hexToRgba(palette[i % palette.length], alpha));
            return colors;
         }

        function commonChartOptions(mainYAxisID = 'y', additionalScales = {}) {
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    [mainYAxisID]: { beginAtZero: true, ticks: { color: textColor, padding: 10, callback: value => formatCurrency(value).replace(",00", "") }, grid: { color: borderColor, drawTicks: false }, border: { color: borderColor } },
                    x: { ticks: { color: textColor, padding: 10 }, grid: { display: false }, border: { color: borderColor } },
                    ...additionalScales
                },
                plugins: {
                    legend: { position: 'bottom', labels: { color: textColor, boxWidth: 15, padding: 20 } },
                    tooltip: {
                        backgroundColor: hexToRgba(getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim(), 0.9),
                        titleColor: textColor, bodyColor: textColor, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(), borderWidth: 1, padding: 10,
                        callbacks: {
                             title: tooltipItems => tooltipItems[0]?.label ? FULL_MONTHS[MONTHS.indexOf(tooltipItems[0].label)] : '',
                             label: context => `${context.dataset.label || ''}${context.dataset.label ? ': ' : ''}${formatCurrency(context.parsed.y)}`
                        }
                    }
                },
                interaction: { mode: 'index', intersect: false },
            };
         }

        function pieChartOptions(labelPrefix = '') {
             const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
             const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
             const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
             const legendFontSize = Math.round(parseFloat(getComputedStyle(document.body).fontSize) * 1.2);
             return {
                 responsive: true, maintainAspectRatio: false, cutout: '30%',
                 plugins: {
                     legend: {
                         position: 'right',
                         labels: {
                            color: textColor, boxWidth: 15, padding: 15, font: { size: legendFontSize },
                             generateLabels: chart => {
                                const data = chart.data; if (!data.labels.length || !data.datasets.length) return [];
                                const { labels } = data; const dataset = data.datasets[0];
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                return labels.map((label, i) => ({
                                    text: `${label} (${total > 0 ? ((dataset.data[i] / total) * 100).toFixed(1) + '%' : '0.0%'})`,
                                    fillStyle: dataset.backgroundColor[i], strokeStyle: dataset.borderColor || dataset.backgroundColor[i],
                                    lineWidth: dataset.borderWidth || 0, hidden: chart.getDataVisibility(i) || dataset.data[i] === 0, index: i
                                }));
                             }
                         }
                     },
                     tooltip: {
                         backgroundColor: hexToRgba(cardBg, 0.9), titleColor: textColor, bodyColor: textColor, borderColor: borderColor, borderWidth: 1, padding: 10,
                         callbacks: {
                            label: context => {
                                 let label = context.label || '';
                                 if (context.parsed !== null) {
                                     const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                     label = `${label}: ${formatCurrency(context.parsed)} (${total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0.0%'})`;
                                 } return label;
                            }
                         }
                     }
                 }
             };
         }

        function updateReserveUI() {
            const panel = document.getElementById('reserve-fund-panel'); if (!panel) return;
            const isPercent = document.getElementById('reserve-type-percent').checked;
            const inputs = panel.querySelectorAll('input[type="number"]');
            const uiUnitLabel = isPercent ? '%' : '$'; const uiCurrentStep = isPercent ? '0.1' : '100';
            inputs.forEach((input, i) => {
                input.step = uiCurrentStep; input.placeholder = uiUnitLabel;
                input.title = `Valor de fondo de reserva para ${FULL_MONTHS[i]} (${uiUnitLabel})`;
                 // Actualizar el valor si el panel ya fue renderizado y solo cambió el tipo
                 const scenario = getCurrentScenarioData();
                 if (scenario && scenario.reserveFund && scenario.reserveFund.values[i] !== undefined) {
                     // No cambiar el valor aquí directamente, solo la UI. El valor se guarda con saveReserveFund.
                 } else {
                     input.value = isPercent ? 5 : 0; // Default si no hay datos aún
                 }
            });
        }

        function renderReserveFundInputsInPanel(panelElement, reserveFundData) {
             panelElement.innerHTML = '';
             const uiUnitLabel = reserveFundData.type === 'percent' ? '%' : '$';
             const uiCurrentStep = reserveFundData.type === 'percent' ? '0.1' : '100';
             const reserveValues = (Array.isArray(reserveFundData.values) && reserveFundData.values.length === 12) ? reserveFundData.values.map(v => parseFloat(v || 0)) : Array(12).fill(reserveFundData.type === 'percent' ? 5 : 0);
             for (let i = 0; i < 12; i++) {
                 const monthDiv = document.createElement('div'); monthDiv.classList.add('form-group'); // Corregido: form-group no month-config
                 const label = document.createElement('label'); label.textContent = FULL_MONTHS[i]; label.htmlFor = `reserve-month-${i}`;
                 const input = document.createElement('input'); input.type = 'number'; input.id = `reserve-month-${i}`; input.dataset.month = i;
                 input.value = reserveValues[i]; input.step = uiCurrentStep; input.min = '0'; input.placeholder = uiUnitLabel; input.style.textAlign = 'right';
                 input.title = `Valor de fondo de reserva para ${FULL_MONTHS[i]} (${uiUnitLabel})`;
                 monthDiv.appendChild(label); monthDiv.appendChild(input); panelElement.appendChild(monthDiv);
             }
        }

        function ensureCollapsibleTableHeaderFooterCells(thead, tfoot, type) {
             let theadRow = thead.querySelector('tr'); if (!theadRow) theadRow = thead.insertRow();
             const expectedHeaderCellCount = (type === 'gastos' ? 2 : 1) + MONTHS.length + 1;
             let headersNeedRebuild = theadRow.cells.length !== expectedHeaderCellCount || theadRow.cells[0]?.textContent !== "Rubro / Detalle" || (type === 'gastos' && theadRow.cells[1]?.textContent !== "Coef. Aplicado") || theadRow.cells[theadRow.cells.length - 1]?.textContent !== "Total Anual";
             if (headersNeedRebuild) {
                 theadRow.innerHTML = ''; theadRow.insertCell().textContent = "Rubro / Detalle";
                 if (type === 'gastos') theadRow.insertCell().textContent = "Coef. Aplicado";
                 MONTHS.forEach(month => { const th=theadRow.insertCell(); th.textContent=month; th.classList.add('number-cell'); });
                 const thTotal = theadRow.insertCell(); thTotal.textContent="Total Anual"; thTotal.classList.add('number-cell');
             }
            let tfootRow = tfoot.querySelector('tr'); if (!tfootRow || tfootRow.cells.length === 0) tfootRow = tfoot.insertRow();
             const footerDescCols = type === 'gastos' ? 2 : 1; const expectedFooterCellCount = footerDescCols + 12 + 1;
             let footerLabelCell = tfootRow.cells[0]; if (!footerLabelCell) footerLabelCell = tfootRow.insertCell(0);
             footerLabelCell.colSpan = footerDescCols; footerLabelCell.textContent = `TOTAL GENERAL ${type.toUpperCase()}`; footerLabelCell.classList.remove('number-cell');
             while(tfootRow.cells.length < expectedFooterCellCount) tfootRow.insertCell(); while(tfootRow.cells.length > expectedFooterCellCount) tfootRow.deleteCell(-1);
             for(let i=footerDescCols; i<expectedFooterCellCount; i++) if(tfootRow.cells[i]) tfootRow.cells[i].classList.add('number-cell');
             tfootRow.style.fontWeight = "bold"; // Asegurar que el pie de tabla esté en negrita
        }

        function updateRubroList(type, listElementId) {
            const listElement = document.getElementById(listElementId); if (!listElement) return; listElement.innerHTML = '';
            const rubros = appState.settings.rubros[type] || [];
            const coefTypes = appState.settings.coefficientTypes || {};
            rubros.forEach(rubroName => {
                const li = document.createElement('li');
                const span = document.createElement('span'); span.textContent = rubroName; li.appendChild(span);
                if (type === 'gastos') {
                    const select = document.createElement('select'); select.dataset.rubro = rubroName;
                    Object.keys(coefTypes).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = coefTypes[key].name; select.appendChild(option); });
                    const currentCoef = appState.settings.rubroConfig[rubroName]?.coefficientType || 'None';
                    select.value = coefTypes[currentCoef] ? currentCoef : 'None';
                    select.addEventListener('change', handleCoefficientAssignmentChange);
                    li.appendChild(select);
                }
                const btnRemove = document.createElement('button'); btnRemove.innerHTML = '<i class="fas fa-trash-alt"></i>'; btnRemove.classList.add('button-danger', 'button-sm'); btnRemove.title = `Eliminar rubro ${rubroName}`;
                btnRemove.onclick = () => removeRubro(type, rubroName);
                li.appendChild(btnRemove);
                listElement.appendChild(li);
            });
        }

        function updateCoefficientTypeList() {
            const listElement = document.getElementById('coefficient-type-list'); if (!listElement) return; listElement.innerHTML = '';
            const coefTypes = appState.settings.coefficientTypes || {};
            Object.entries(coefTypes).forEach(([key, type]) => {
                const li = document.createElement('li');
                const span = document.createElement('span'); span.textContent = type.name;
                if (key !== 'None' && key !== 'IPC') span.style.cursor = 'pointer'; span.onclick = () => (key !== 'None' && key !== 'IPC') ? editCoefficientType(key) : null;
                li.appendChild(span);
                if (!type.isDefault) {
                    const btnRemove = document.createElement('button'); btnRemove.innerHTML = '<i class="fas fa-trash-alt"></i>'; btnRemove.classList.add('button-danger', 'button-sm'); btnRemove.title = `Eliminar tipo ${type.name}`;
                    btnRemove.onclick = () => removeCoefficientType(key);
                    li.appendChild(btnRemove);
                }
                listElement.appendChild(li);
            });
        }

        function renderCoefficientValuesEditor(typeKey) {
            const editorDiv = document.getElementById('coefficient-values-editor');
            const nameSpan = document.getElementById('editing-coefficient-name');
            if (!editorDiv || !nameSpan) return;
            editorDiv.innerHTML = '';

            const typeData = appState.settings.coefficientTypes?.[typeKey];
            if (!typeData || typeKey === 'None' || typeKey === 'IPC') {
                nameSpan.textContent = typeData ? typeData.name : (typeKey || 'Ninguno');
                editorDiv.innerHTML = `<p class="text-muted">Selecciona un tipo de coeficiente (que no sea "Sin Coeficiente" o "IPC") para editar sus valores.</p>`;
                appState.uiState.editingCoefficientType = null; // Reset if invalid type for editing
                return;
            }
            nameSpan.textContent = typeData.name;
            const values = Array.isArray(typeData.values) && typeData.values.length === 12 ? typeData.values : Array(12).fill(0);
            values.forEach((val, i) => {
                const monthDiv = document.createElement('div'); monthDiv.classList.add('form-group');
                const label = document.createElement('label'); label.textContent = FULL_MONTHS[i]; label.htmlFor = `coef-val-${typeKey}-${i}`;
                const input = document.createElement('input'); input.type = 'number'; input.id = `coef-val-${typeKey}-${i}`;
                input.dataset.month = i; input.dataset.typeKey = typeKey; input.value = val;
                input.step = '0.1'; input.min = '-100'; input.placeholder = '%'; input.style.textAlign = 'right';
                input.title = `Valor para ${FULL_MONTHS[i]} de ${typeData.name} (%)`;
                input.addEventListener('change', handleCoefficientValueChange);
                monthDiv.appendChild(label); monthDiv.appendChild(input); editorDiv.appendChild(monthDiv);
            });
        }

        function updateIPCManualInputs() {
             const ipcDiv = document.getElementById('ipc-inputs'); if (!ipcDiv) return; ipcDiv.innerHTML = '';
             appState.settings.ipcManual = Array.isArray(appState.settings.ipcManual) && appState.settings.ipcManual.length === 12 ? appState.settings.ipcManual.map(v => parseFloat(v || 0)) : Array(12).fill(0);
             const ipcValues = appState.settings.ipcManual;
             const ipcCoefType = appState.settings.coefficientTypes?.['IPC'];
             for (let i = 0; i < 12; i++) {
                 const monthDiv = document.createElement('div'); monthDiv.classList.add('form-group');
                 const label = document.createElement('label'); label.textContent = FULL_MONTHS[i]; label.htmlFor = `ipc-month-${i}`;
                 const input = document.createElement('input'); input.type = 'number'; input.id = `ipc-month-${i}`;
                 input.dataset.month = i; input.value = ipcValues[i]; input.step = '0.1'; input.min = '0'; input.placeholder = '%'; input.style.textAlign = 'right'; input.title = `IPC para ${FULL_MONTHS[i]} (%)`;
                 input.addEventListener('change', (event) => {
                     const monthIndex = parseInt(event.target.dataset.month); const value = parseFloat(event.target.value);
                     if (!isNaN(monthIndex) && monthIndex >= 0 && monthIndex < 12) {
                         const validatedValue = (!isNaN(value) && value >= 0) ? value : 0;
                         appState.settings.ipcManual[monthIndex] = validatedValue;
                         if(ipcCoefType?.values?.length === 12) ipcCoefType.values[monthIndex] = validatedValue;
                     } else event.target.value = appState.settings.ipcManual[monthIndex] ?? 0;
                 });
                 monthDiv.appendChild(label); monthDiv.appendChild(input); ipcDiv.appendChild(monthDiv);
             }
        }


        // --- Gestión de Datos del Escenario (Continuación) ---
        function validateAndSetActiveScenario() {
            let activeKeyIsValid = false; let fallbackNeeded = true;
            if (appState.activeScenarioKey && appState.scenarios?.[appState.activeScenarioKey]) {
                 const scenario = appState.scenarios[appState.activeScenarioKey];
                 const activeYear = parseInt(appState.activeScenarioKey.split('_')[0]);
                 if (!isNaN(activeYear) && scenario.year === activeYear) { appState.currentYear = activeYear; activeKeyIsValid = true; fallbackNeeded = false; }
                 else { appState.activeScenarioKey = null; }
            } else if (appState.activeScenarioKey !== null) appState.activeScenarioKey = null;

            if (!activeKeyIsValid) {
                const defaultYear = new Date().getFullYear();
                const scenariosForCurrentYear = Object.keys(appState.scenarios || {}).filter(k => appState.scenarios[k]?.year === appState.currentYear);
                const scenariosForDefaultYear = Object.keys(appState.scenarios || {}).filter(k => appState.scenarios[k]?.year === defaultYear);
                let fallbackKey = null;
                if (appState.scenarios?.[`${appState.currentYear}_Base`]) fallbackKey = `${appState.currentYear}_Base`;
                else if (scenariosForCurrentYear.length > 0) fallbackKey = scenariosForCurrentYear.sort((a,b) => (appState.scenarios[a]?.scenarioName || '').localeCompare(appState.scenarios[b]?.scenarioName || ''))[0];
                else if (appState.scenarios?.[`${defaultYear}_Base`]) fallbackKey = `${defaultYear}_Base`;
                else if (scenariosForDefaultYear.length > 0) fallbackKey = scenariosForDefaultYear.sort((a,b) => (appState.scenarios[a]?.scenarioName || '').localeCompare(appState.scenarios[b]?.scenarioName || ''))[0];
                else { const allKeys = Object.keys(appState.scenarios || {}).sort(); if (allKeys.length > 0 && appState.scenarios[allKeys[0]]) fallbackKey = allKeys[0]; }

                if (fallbackKey && appState.scenarios?.[fallbackKey]) {
                    appState.activeScenarioKey = fallbackKey;
                    appState.currentYear = appState.scenarios[fallbackKey].year || parseInt(fallbackKey.split('_')[0]) || defaultYear;
                    fallbackNeeded = false;
                }
            }
            if (fallbackNeeded) {
                const year = new Date().getFullYear(); appState.currentYear = year;
                initScenarioData(year, 'Base'); appState.activeScenarioKey = `${year}_Base`;
            }
            const currentScenario = getCurrentScenarioData(); // Esto puede llamar a validateAndSetActiveScenario de nuevo si no hay nada
            if (currentScenario) { initializeScenarioDataForRubros(currentScenario); ensureDefaultCoefficientTypes(); }
            else console.error("validateAndSetActiveScenario: No se pudo establecer un escenario activo válido después de los fallbacks.");
            // saveState(); // Save state se hace al final de DOMContentLoaded y después de cambios
        }

        function getCurrentScenarioData() {
             if (appState.activeScenarioKey && appState.scenarios?.[appState.activeScenarioKey]?.year !== undefined) return appState.scenarios[appState.activeScenarioKey];
             // Si no hay escenario activo válido, validateAndSetActiveScenario intentará establecer uno.
             // Esta función es llamada a menudo, así que evitamos bucles infinitos no llamando a validateAndSetActiveScenario aquí directamente
             // sino confiando en que se llamó en la inicialización o cuando se cambió de escenario.
             console.warn("getCurrentScenarioData: No hay un escenario activo válido o datos. Esto podría ser normal durante la inicialización o si no hay escenarios.");
             return null;
        }

        function initScenarioData(year, scenarioName = 'Base') {
             if (typeof year !== 'number' || year < 2000 || year > 2099) year = new Date().getFullYear();
             const key = `${year}_${scenarioName.replace(/\s+/g, '_').replace(/[^\w-]/g, '')}`;
             if (appState.scenarios[key]) return appState.scenarios[key];
             const defaultTemplate = getDefaultAppState().BaseScenarioStructureTemplate;
             appState.scenarios[key] = JSON.parse(JSON.stringify(defaultTemplate));
             appState.scenarios[key].year = year; appState.scenarios[key].scenarioName = scenarioName;
             // initializeScenarioDataForRubros se llamará cuando este escenario se active o se carguen datos.
             return appState.scenarios[key];
        }

        function initializeScenarioDataForRubros(scenarioData) {
             if (!scenarioData || typeof scenarioData !== 'object' || scenarioData.year === undefined) { console.error("initializeScenarioDataForRubros: datos de escenario inválidos."); return; }
             scenarioData.rubroOrder = scenarioData.rubroOrder ?? { gastos: [], ingresos: [] };
             scenarioData.rubroOrder.gastos = Array.isArray(scenarioData.rubroOrder.gastos) ? scenarioData.rubroOrder.gastos : [];
             scenarioData.rubroOrder.ingresos = Array.isArray(scenarioData.rubroOrder.ingresos) ? scenarioData.rubroOrder.ingresos : [];
             scenarioData.data = scenarioData.data ?? { gastos: {}, ingresos: {} };
             scenarioData.data.gastos = scenarioData.data.gastos ?? {}; scenarioData.data.ingresos = scenarioData.data.ingresos ?? {};
             scenarioData.monthStatus = scenarioData.monthStatus ?? { gastos: {}, ingresos: {} }; // Ingresos no usa monthStatus actualmente
             scenarioData.monthStatus.gastos = scenarioData.monthStatus.gastos ?? {};
             scenarioData.reserveFund = scenarioData.reserveFund ?? { type: 'percent', values: Array(12).fill(5) };
             scenarioData.reserveFund.values = (Array.isArray(scenarioData.reserveFund.values) && scenarioData.reserveFund.values.length === 12) ? scenarioData.reserveFund.values.map(v => parseFloat(v||0)) : Array(12).fill(scenarioData.reserveFund.type === 'fixed' ? 0 : 5);
             scenarioData.calculated = scenarioData.calculated ?? {};
             const defaultCalc = getDefaultAppState().BaseScenarioStructureTemplate?.calculated || {};
             for(const k in defaultCalc) {
                 if(scenarioData.calculated[k] === undefined || scenarioData.calculated[k] === null) scenarioData.calculated[k] = Array.isArray(defaultCalc[k]) ? Array(12).fill(0) : (typeof defaultCalc[k] === 'object' ? {} : defaultCalc[k]);
                 else if (Array.isArray(scenarioData.calculated[k]) && scenarioData.calculated[k].length !== 12 && k !== 'annualTotals') scenarioData.calculated[k] = Array(12).fill(0); // No resetear annualTotals
             }
             scenarioData.calculated.annualTotals = scenarioData.calculated.annualTotals ?? { gastos: {__TOTAL__:0}, ingresos: {__TOTAL__:0}, fondoReserva: 0, cuotaSobreGastos: 0, cuotaIpc: 0, cuotaRealBase: 0 };
             scenarioData.calculated.annualTotals.gastos = scenarioData.calculated.annualTotals.gastos ?? { __TOTAL__: 0 };
             scenarioData.calculated.annualTotals.ingresos = scenarioData.calculated.annualTotals.ingresos ?? { __TOTAL__: 0 };

             if (!Array.isArray(scenarioData.calculated.ipcManual) || scenarioData.calculated.ipcManual.length !== 12) scenarioData.calculated.ipcManual = [...(appState.settings?.ipcManual || Array(12).fill(0))];
             else scenarioData.calculated.ipcManual = scenarioData.calculated.ipcManual.map(v => parseFloat(v||0));

             ['gastos', 'ingresos'].forEach(type => {
                 const globalRubros = appState.settings?.rubros?.[type] || [];
                 globalRubros.forEach(rubro => {
                      if (!scenarioData.data[type][rubro]) scenarioData.data[type][rubro] = { detailOrder: [], detailsData: {} };
                      scenarioData.data[type][rubro].detailOrder = Array.isArray(scenarioData.data[type][rubro].detailOrder) ? scenarioData.data[type][rubro].detailOrder : [];
                      scenarioData.data[type][rubro].detailsData = (typeof scenarioData.data[type][rubro].detailsData === 'object' && scenarioData.data[type][rubro].detailsData !== null) ? scenarioData.data[type][rubro].detailsData : {};
                      if (type === 'gastos') scenarioData.monthStatus[type][rubro] = (typeof scenarioData.monthStatus[type][rubro] === 'object' && scenarioData.monthStatus[type][rubro] !== null) ? scenarioData.monthStatus[type][rubro] : {};

                      const calcKeyPrefix = type === 'gastos' ? 'gasto' : 'ingreso';
                      const calcKeyTotalRubroMes = `total${type.charAt(0).toUpperCase() + type.slice(1)}RubroMes`;
                      scenarioData.calculated[`${calcKeyPrefix}Ajustado`] = scenarioData.calculated[`${calcKeyPrefix}Ajustado`] ?? {};
                      scenarioData.calculated[`${calcKeyPrefix}Ajustado`][rubro] = scenarioData.calculated[`${calcKeyPrefix}Ajustado`][rubro] ?? {};
                      scenarioData.calculated[calcKeyTotalRubroMes] = scenarioData.calculated[calcKeyTotalRubroMes] ?? {};
                      scenarioData.calculated[calcKeyTotalRubroMes][rubro] = (Array.isArray(scenarioData.calculated[calcKeyTotalRubroMes][rubro]) && scenarioData.calculated[calcKeyTotalRubroMes][rubro].length === 12) ? scenarioData.calculated[calcKeyTotalRubroMes][rubro].map(v=>parseFloat(v||0)) : Array(12).fill(0);
                      scenarioData.calculated.annualTotals[type][rubro] = scenarioData.calculated.annualTotals[type][rubro] ?? 0;

                      Object.keys(scenarioData.data[type][rubro].detailsData).forEach(detail => {
                           if (!scenarioData.data[type][rubro].detailOrder.includes(detail)) scenarioData.data[type][rubro].detailOrder.push(detail);
                           const detailDataArray = scenarioData.data[type][rubro].detailsData[detail];
                           if(!Array.isArray(detailDataArray) || detailDataArray.length !== 12) scenarioData.data[type][rubro].detailsData[detail] = Array(12).fill(0);
                           else scenarioData.data[type][rubro].detailsData[detail] = detailDataArray.map(v => parseFloat(v||0));

                           if (type === 'gastos') {
                               const statusArray = scenarioData.monthStatus[type][rubro]?.[detail];
                               if (!Array.isArray(statusArray) || statusArray.length !== 12) scenarioData.monthStatus[type][rubro][detail] = Array(12).fill('Estimado');
                               else scenarioData.monthStatus[type][rubro][detail] = statusArray.map(s => String(s || 'Estimado'));
                           }
                           const calcDetailArray = scenarioData.calculated[`${calcKeyPrefix}Ajustado`][rubro]?.[detail];
                           if(!Array.isArray(calcDetailArray) || calcDetailArray.length !== 12) scenarioData.calculated[`${calcKeyPrefix}Ajustado`][rubro][detail] = Array(12).fill(0);
                           else scenarioData.calculated[`${calcKeyPrefix}Ajustado`][rubro][detail] = calcDetailArray.map(v=>parseFloat(v||0));
                       });
                 });
                 Object.keys(scenarioData.data[type] || {}).forEach(rubro => { if (!globalRubros.includes(rubro)) { delete scenarioData.data[type][rubro]; if (type === 'gastos') delete scenarioData.monthStatus[type][rubro]; } });
                 scenarioData.rubroOrder[type] = scenarioData.rubroOrder[type].filter(rubro => globalRubros.includes(rubro));
             });
         }

        function ensureDefaultCoefficientTypes() {
              const defaultTypes = getDefaultAppState().settings.coefficientTypes;
             appState.settings.coefficientTypes = appState.settings.coefficientTypes || {};
             for (const key in defaultTypes) {
                 if (!appState.settings.coefficientTypes[key]) appState.settings.coefficientTypes[key] = JSON.parse(JSON.stringify(defaultTypes[key]));
                 else {
                      appState.settings.coefficientTypes[key].isDefault = defaultTypes[key].isDefault ?? false;
                     if (key === 'IPC') {
                          const manualIPC = appState.settings.ipcManual;
                          if (!Array.isArray(manualIPC) || manualIPC.length !== 12) appState.settings.ipcManual = Array(12).fill(0);
                           appState.settings.coefficientTypes[key].values = [...appState.settings.ipcManual.map(v => parseFloat(v||0))];
                      } else if (key === 'None') appState.settings.coefficientTypes[key].values = Array(12).fill(1);
                      else if (Array.isArray(appState.settings.coefficientTypes[key].values) && appState.settings.coefficientTypes[key].values.length === 12) appState.settings.coefficientTypes[key].values = appState.settings.coefficientTypes[key].values.map(val => (!isNaN(parseFloat(val)) && parseFloat(val) >= -100) ? parseFloat(val) : 0);
                      else appState.settings.coefficientTypes[key].values = Array(12).fill(0);
                 }
             }
         }

        // --- Lógica de Negocio y Cálculos ---
        function calculateAll(scenarioData) {
             if (!scenarioData) { renderEmptyState(); return; }
             initializeScenarioDataForRubros(scenarioData); // Asegura que todas las estructuras estén presentes y correctas
             const { data, reserveFund } = scenarioData; const { settings } = appState; const { rubroConfig, coefficientTypes, cantidadUnidades } = settings;
             const calculated = scenarioData.calculated;
             calculated.ipcManual = Array.isArray(settings.ipcManual) && settings.ipcManual.length === 12 ? [...settings.ipcManual.map(v=>parseFloat(v||0))] : Array(12).fill(0);
             calculated.gastoAjustado = {}; calculated.totalGastoRubroMes = {}; calculated.totalGastoProyectadoMes = Array(12).fill(0);
             calculated.ingresoAjustado = {}; calculated.totalIngresoRubroMes = {}; calculated.totalIngresoProyectadoMes = Array(12).fill(0);
             Object.assign(calculated, { fondoReservaMes: Array(12).fill(0), cuotaSobreGastosMes: Array(12).fill(0), cuotaIpcMes: Array(12).fill(0), cuotaRealBaseMes: Array(12).fill(0) });
             calculated.annualTotals = { gastos: {__TOTAL__:0}, ingresos: {__TOTAL__:0}, fondoReserva: 0, cuotaSobreGastos: 0, cuotaIpc: 0, cuotaRealBase: 0 };

             const globalGastosRubros = settings?.rubros?.gastos || [];
             const gastoRubros = (scenarioData.rubroOrder?.gastos?.length > 0 ? scenarioData.rubroOrder.gastos : globalGastosRubros).filter(r => globalGastosRubros.includes(r) && data.gastos?.[r]?.detailsData);
             gastoRubros.forEach(rubro => {
                 if (!data.gastos?.[rubro]?.detailsData) return;
                 calculated.gastoAjustado[rubro] = {}; calculated.totalGastoRubroMes[rubro] = Array(12).fill(0); calculated.annualTotals.gastos[rubro] = 0;
                 const detailOrder = (data.gastos[rubro].detailOrder?.length > 0 ? data.gastos[rubro].detailOrder : Object.keys(data.gastos[rubro].detailsData || {})).filter(d => Array.isArray(data.gastos[rubro].detailsData?.[d]) && data.gastos[rubro].detailsData[d].length === 12);
                 if (detailOrder.length === 0) return;
                 const coefKey = rubroConfig[rubro]?.coefficientType || 'None'; const coefType = coefficientTypes[coefKey];
                 const monthlyMultipliers = Array(12).fill(1);
                 if (coefType && coefKey !== 'None' && Array.isArray(coefType.values) && coefType.values.length === 12) {
                    for(let i=0; i<12; i++) { const perc = parseFloat(coefType.values[i]||0); if(!isNaN(perc)) monthlyMultipliers[i] = 1 + perc/100; }
                 }
                 detailOrder.forEach(detail => {
                     const srcVals = (data.gastos[rubro].detailsData[detail] || []).map(v => parseFloat(v||0));
                     const adjVals = srcVals.map((val, idx) => val * (monthlyMultipliers[idx] ?? 1));
                     calculated.gastoAjustado[rubro][detail] = adjVals;
                     for (let i=0; i<12; i++) calculated.totalGastoRubroMes[rubro][i] += (adjVals[i]||0);
                 });
                 for (let i=0; i<12; i++) calculated.totalGastoProyectadoMes[i] += (calculated.totalGastoRubroMes[rubro]?.[i]||0);
                 calculated.annualTotals.gastos[rubro] = (calculated.totalGastoRubroMes[rubro]||[]).reduce((a,b)=>a+(b||0),0);
             });
             calculated.annualTotals.gastos.__TOTAL__ = (calculated.totalGastoProyectadoMes||[]).reduce((a,b)=>a+(b||0),0);

             const unidades = parseInt(cantidadUnidades) || 1; const unidadesCuota = unidades > 0 ? unidades : 1;
             const globalIngresosRubros = settings?.rubros?.ingresos || [];
             const ingresoRubros = (scenarioData.rubroOrder?.ingresos?.length > 0 ? scenarioData.rubroOrder.ingresos : globalIngresosRubros).filter(r => globalIngresosRubros.includes(r) && data.ingresos?.[r]?.detailsData);
             ingresoRubros.forEach(rubro => {
                 if (!data.ingresos?.[rubro]?.detailsData) return;
                 calculated.ingresoAjustado[rubro] = {}; calculated.totalIngresoRubroMes[rubro] = Array(12).fill(0); calculated.annualTotals.ingresos[rubro] = 0;
                 const detailOrder = (data.ingresos[rubro].detailOrder?.length > 0 ? data.ingresos[rubro].detailOrder : Object.keys(data.ingresos[rubro].detailsData || {})).filter(d => Array.isArray(data.ingresos[rubro].detailsData?.[d]) && data.ingresos[rubro].detailsData[d].length === 12);
                 if (detailOrder.length === 0) return;
                 detailOrder.forEach(detail => {
                     const baseVals = (data.ingresos[rubro].detailsData[detail]||[]).map(v => parseFloat(v||0));
                     calculated.ingresoAjustado[rubro][detail] = baseVals;
                     for (let i=0; i<12; i++) calculated.totalIngresoRubroMes[rubro][i] += (SPECIAL_INGRESO_RUBROS.includes(rubro) ? baseVals[i]*unidades : baseVals[i]) || 0;
                 });
                 for (let i=0; i<12; i++) calculated.totalIngresoProyectadoMes[i] += (calculated.totalIngresoRubroMes[rubro]?.[i]||0);
                 calculated.annualTotals.ingresos[rubro] = (calculated.totalIngresoRubroMes[rubro]||[]).reduce((a,b)=>a+(b||0),0);
             });
             calculated.annualTotals.ingresos.__TOTAL__ = (calculated.totalIngresoProyectadoMes||[]).reduce((a,b)=>a+(b||0),0);

             if (unidadesCuota <= 0 || !calculated.totalIngresoRubroMes?.[CUOTA_RUBRO_NAME]) calculated.cuotaRealBaseMes = Array(12).fill(0);
             else for (let i=0; i<12; i++) calculated.cuotaRealBaseMes[i] = (calculated.totalIngresoRubroMes[CUOTA_RUBRO_NAME][i]||0) / unidadesCuota;
             calculated.annualTotals.cuotaRealBase = (calculated.cuotaRealBaseMes||[]).reduce((a,b)=>a+(b||0),0);

             const reserveVals = (reserveFund?.values?.length === 12 ? reserveFund.values : Array(12).fill(reserveFund?.type === 'fixed' ? 0:5)).map(v=>parseFloat(v||0));
             for (let i=0; i<12; i++) calculated.fondoReservaMes[i] = reserveFund?.type === 'percent' ? (calculated.totalGastoProyectadoMes[i]||0)*(reserveVals[i]/100) : (reserveVals[i]||0);
             calculated.annualTotals.fondoReserva = (calculated.fondoReservaMes||[]).reduce((a,b)=>a+(b||0),0);

             for (let i=0; i<12; i++) calculated.cuotaSobreGastosMes[i] = unidadesCuota > 0 ? ((calculated.totalGastoProyectadoMes[i]||0) + (calculated.fondoReservaMes[i]||0)) / unidadesCuota : 0;
             calculated.annualTotals.cuotaSobreGastos = (calculated.cuotaSobreGastosMes||[]).reduce((a,b)=>a+(b||0),0);

             const ipcSnap = (calculated.ipcManual?.length === 12 ? calculated.ipcManual : Array(12).fill(0)).map(v=>parseFloat(v||0));
             const baseEneroCuota = calculated.cuotaRealBaseMes?.[0]||0;
             if (baseEneroCuota > 0) {
                 let accMult = 1;
                 for (let i=0; i<12; i++) { accMult *= (!isNaN(ipcSnap[i]) && ipcSnap[i]>=0 ? (1+ipcSnap[i]/100) : 1); calculated.cuotaIpcMes[i] = baseEneroCuota * accMult; }
             }
             calculated.annualTotals.cuotaIpc = (calculated.cuotaIpcMes||[]).reduce((a,b)=>a+(b||0),0);
             saveState(); updateUI(); showSnackbar("Cálculos actualizados.", false, 'success');
        }

        function recalculateEstimates() {
            const scenarioData = getCurrentScenarioData(); if (!scenarioData) { showSnackbar("No hay escenario activo.", true, 'error'); return; }
            const { data, monthStatus, rubroOrder } = scenarioData; const { settings } = appState; const { rubroConfig, coefficientTypes } = settings;
            let changesMade = false; let projectedCellCount = 0; let totalDetailsProcessed = 0;
            const globalGastosRubros = settings?.rubros?.gastos || [];
            const gastoRubros = (rubroOrder?.gastos?.length > 0 ? rubroOrder.gastos : globalGastosRubros).filter(r => globalGastosRubros.includes(r) && data.gastos?.[r]?.detailsData);
            if (gastoRubros.length === 0) { showSnackbar("No hay rubros de gasto para proyectar.", false, 'info'); return; }

            gastoRubros.forEach(rubro => {
                if (!data.gastos?.[rubro]?.detailsData) return;
                const detailOrder = (data.gastos[rubro].detailOrder?.length > 0 ? data.gastos[rubro].detailOrder : Object.keys(data.gastos[rubro].detailsData||{})).filter(d => Array.isArray(data.gastos[rubro].detailsData?.[d]) && data.gastos[rubro].detailsData[d].length === 12);
                if (detailOrder.length === 0) return; totalDetailsProcessed += detailOrder.length;
                const coefKey = rubroConfig[rubro]?.coefficientType || 'None'; const coefType = coefficientTypes[coefKey];
                const monthlyMultipliers = Array(12).fill(1);
                if (coefType && coefKey !== 'None' && Array.isArray(coefType.values) && coefType.values.length === 12) {
                   for(let i=0; i<12; i++) { const perc = parseFloat(coefType.values[i]||0); if(!isNaN(perc)) monthlyMultipliers[i] = 1 + perc/100; }
                }
                detailOrder.forEach(detail => {
                    const statuses = (monthStatus.gastos?.[rubro]?.[detail]?.length === 12 ? monthStatus.gastos[rubro][detail] : Array(12).fill('Estimado'));
                    const dataVals = (data.gastos[rubro].detailsData[detail]||[]).map(v=>parseFloat(v||0));
                    let lastRealIdx = -1; for (let i=11; i>=0; i--) if(statuses[i]==='REAL'){lastRealIdx=i; break;}
                    if (lastRealIdx === -1 || lastRealIdx === 11) return;
                    let prevVal = dataVals[lastRealIdx];
                    for (let j = lastRealIdx + 1; j < 12; j++) {
                        if (statuses[j] === 'Estimado') {
                            const projVal = prevVal * monthlyMultipliers[j]; data.gastos[rubro].detailsData[detail][j] = projVal;
                            changesMade = true; projectedCellCount++; prevVal = projVal;
                        } else if (statuses[j] === 'REAL') prevVal = dataVals[j];
                    }
                });
            });
            if (totalDetailsProcessed === 0) { showSnackbar("No se encontraron detalles de gastos válidos para proyectar.", false, 'info'); return; }
            if (changesMade) { showSnackbar(`Estimados recalculados (${projectedCellCount} celdas). Actualizando...`, false, 'info'); calculateAll(scenarioData); }
            else showSnackbar("No se necesitaron cambios en los estimados.", false, 'info');
        }

        // --- Funciones Principales de Actualización de UI ---
        function updateSettingsPanel() {
            const ufInput = document.getElementById('cantidad-unidades');
            appState.settings.cantidadUnidades = parseInt(appState.settings.cantidadUnidades)||100; if(appState.settings.cantidadUnidades<0)appState.settings.cantidadUnidades=100;
            if (ufInput) ufInput.value = appState.settings.cantidadUnidades;
            updateRubroList('gastos', 'gasto-rubro-list'); updateRubroList('ingresos', 'ingreso-rubro-list');
            ensureDefaultCoefficientTypes(); updateCoefficientTypeList();
            const currentEditing = appState.uiState.editingCoefficientType;
            const typeData = appState.settings.coefficientTypes?.[currentEditing];
            if (currentEditing && typeData && currentEditing !== 'None' && currentEditing !== 'IPC') renderCoefficientValuesEditor(currentEditing);
            else {
                document.getElementById('coefficient-values-editor').innerHTML = '<p class="text-muted">Selecciona un tipo de coeficiente (que no sea "Sin Coeficiente" o "IPC") de la lista de la izquierda para editar sus valores.</p>';
                document.getElementById('editing-coefficient-name').textContent = 'Ninguno';
                appState.uiState.editingCoefficientType = null;
            }
            updateIPCManualInputs();
        }

        function updateReserveFundPanel(scenarioData) {
             const panel = document.getElementById('reserve-fund-panel'); const pRadio=document.getElementById('reserve-type-percent'); const fRadio=document.getElementById('reserve-type-fixed');
             if(!panel||!pRadio||!fRadio) return;
             const defReserve = getDefaultAppState().BaseScenarioStructureTemplate.reserveFund;
             const reserveData = (scenarioData?.reserveFund?.values?.length===12 && typeof scenarioData.reserveFund.type==='string') ? scenarioData.reserveFund : defReserve;
             const typeFromState = reserveData.type==='fixed'?'fixed':'percent'; pRadio.checked=typeFromState==='percent'; fRadio.checked=typeFromState==='fixed';
             const inputs = panel.querySelectorAll('input[type="number"]');
             if (inputs.length === 12) { // Si los inputs ya existen, solo actualizar sus valores y propiedades
                   inputs.forEach((input, i) => { input.value = parseFloat(reserveData.values[i]||0) || (typeFromState==='fixed'?0:5); });
                   updateReserveUI(); // Esto actualizará step, placeholder, title.
             } else renderReserveFundInputsInPanel(panel, reserveData); // Si no, reconstruir
        }

        function updateCollapsibleTable(type, scenarioData) {
             const table = document.getElementById(`${type}-detail-table`); if (!table) return;
             const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody'); const tfoot = table.querySelector('tfoot'); if (!thead || !tbody || !tfoot) return;
             tbody.innerHTML = ''; tfoot.innerHTML = '';
             const expectedHdrCount = (type==='gastos'?2:1)+MONTHS.length+1;
             if (!scenarioData?.data || !scenarioData.calculated || !appState.settings) { tbody.innerHTML=`<tr><td colspan="${thead.querySelector('tr')?.cells.length||expectedHdrCount}" class="text-muted" style="text-align:center;padding:20px;">Faltan datos.</td></tr>`; ensureCollapsibleTableHeaderFooterCells(thead,tfoot,type); return; }
             const { data, calculated, monthStatus, rubroOrder } = scenarioData;
             const globalRubros = appState.settings.rubros?.[type] || [];
             const rubrosToDisplay = (rubroOrder?.[type]?.length>0 ? rubroOrder[type] : globalRubros).filter(r => globalRubros.includes(r) && data[type]?.[r]?.detailsData);
             ensureCollapsibleTableHeaderFooterCells(thead, tfoot, type);
             if (rubrosToDisplay.length === 0) { tbody.innerHTML=`<tr><td colspan="${thead.querySelector('tr')?.cells.length||expectedHdrCount}" class="text-muted" style="text-align:center;padding:20px;">No hay rubros.</td></tr>`; return; }

             rubrosToDisplay.forEach(rubro => {
                 if (!data[type]?.[rubro]?.detailsData || !calculated[type==='gastos'?'gastoAjustado':'ingresoAjustado']?.[rubro] || !calculated[type==='gastos'?'totalGastoRubroMes':'totalIngresoRubroMes']?.[rubro] || calculated.annualTotals?.[type]?.[rubro]===undefined) return;
                 const rubroData = data[type][rubro];
                 const detailsToDisplay = (rubroData.detailOrder?.length>0 ? rubroData.detailOrder : Object.keys(rubroData.detailsData||{})).filter(d => Array.isArray(rubroData.detailsData?.[d])&&rubroData.detailsData[d].length===12 && Array.isArray(calculated[type==='gastos'?'gastoAjustado':'ingresoAjustado'][rubro]?.[d]) && calculated[type==='gastos'?'gastoAjustado':'ingresoAjustado'][rubro][d].length===12);
                 if (detailsToDisplay.length === 0) return;
                 const isCollapsed = appState.settings.rubroConfig?.[rubro]?.detailsCollapsed ?? true;
                 const totalRow = tbody.insertRow(); totalRow.className = `rubro-total-row${isCollapsed?' collapsed':''}`; totalRow.dataset.rubro=rubro; totalRow.dataset.type=type;
                 totalRow.insertCell().textContent = rubro; if(type==='gastos') totalRow.insertCell().textContent = ''; // Placeholder para coef
                 (calculated[type==='gastos'?'totalGastoRubroMes':'totalIngresoRubroMes'][rubro]||Array(12).fill(0)).forEach(v=>{const c=totalRow.insertCell();c.textContent=formatCurrency(v);c.classList.add('number-cell');});
                 const cellAnnTotal=totalRow.insertCell(); cellAnnTotal.textContent=formatCurrency(calculated.annualTotals[type][rubro]||0); cellAnnTotal.classList.add('number-cell');
                 const coefName = type==='gastos'?(appState.settings.coefficientTypes[appState.settings.rubroConfig[rubro]?.coefficientType||'None']?.name||'N/A'):'';
                 detailsToDisplay.forEach(detail => {
                     const detailVals = calculated[type==='gastos'?'gastoAjustado':'ingresoAjustado'][rubro][detail];
                     const detailStatuses = type==='gastos' && monthStatus.gastos?.[rubro]?.[detail]?.length===12 ? monthStatus.gastos[rubro][detail].map(s=>String(s||'Estimado')) : Array(12).fill('Estimado');
                     const detailRow=tbody.insertRow(); detailRow.className=`detail-row${isCollapsed?' hidden':''}`; detailRow.dataset.rubro=rubro; detailRow.dataset.type=type;
                     const cellDName=detailRow.insertCell(); cellDName.textContent=detail; cellDName.classList.add('text-muted');
                     if(type==='gastos'){const cCoef=detailRow.insertCell();cCoef.textContent=coefName;cCoef.classList.add('text-muted');}
                     let annualDetTotal=0;
                     detailVals.forEach((val,idx)=>{ const c=detailRow.insertCell();c.textContent=formatCurrency(val||0);c.classList.add('number-cell'); if(type==='gastos')c.classList.add(detailStatuses[idx]==='REAL'?'real-month-cell':'estimated-month-cell'); annualDetTotal+=(val||0);});
                     const cellAnnDet=detailRow.insertCell(); cellAnnDet.textContent=formatCurrency(annualDetTotal); cellAnnDet.classList.add('number-cell');
                 });
             });
             addCollapsibleListeners(); // Asegura que los listeners se añadan si es necesario
        }

        function updateCharts(scenarioData) {
             if (!scenarioData?.calculated?.annualTotals) {
                 destroyChart('evolutivoCuotaChart'); displayChartNoData('evolutivoCuotaChart', true);
                 destroyChart('participacionGastosChart'); displayChartNoData('participacionGastosChart', true);
                 destroyChart('participacionIngresosChart'); displayChartNoData('participacionIngresosChart', true);
                 return;
             }
             const { calculated } = scenarioData; const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
             const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(); const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim();
             const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
             const chartColors = [primaryColor, accentColor, '#ffc107', '#6f42c1', '#fd7e14', '#17a2b8', '#dc3545', secondaryColor, '#20c997', '#0d6efd', '#198754', '#adb5bd'];

             destroyChart('evolutivoCuotaChart'); const ctxEvo = document.getElementById('evolutivoCuotaChart')?.getContext('2d');
             const evoHasData = (calculated.cuotaSobreGastosMes?.some(v=>v!==0)??false) || (calculated.cuotaRealBaseMes?.some(v=>v!==0)??false);
             displayChartNoData('evolutivoCuotaChart', !evoHasData);
             if(ctxEvo && evoHasData) window.evolutivoCuotaChart_instance = new Chart(ctxEvo, { type:'line', data:{labels:MONTHS, datasets:[
                 {label:'Cuota s/Gtos ($)',data:calculated.cuotaSobreGastosMes,borderColor:primaryColor,backgroundColor:hexToRgba(primaryColor,0.1),tension:0.2,fill:true,yAxisID:'yCuota'},
                 {label:'Expensa Real Base ($)',data:calculated.cuotaRealBaseMes,borderColor:accentColor,backgroundColor:hexToRgba(accentColor,0.1),tension:0.2,fill:true,yAxisID:'yCuota'},
                 {label:'Cuota IPC ($)',data:calculated.cuotaIpcMes,borderColor:secondaryColor,backgroundColor:hexToRgba(secondaryColor,0.1),tension:0.2,fill:false,borderDash:[5,5],yAxisID:'yCuota'}
             ]}, options:commonChartOptions('yCuota')});

             destroyChart('participacionGastosChart'); const ctxGastos = document.getElementById('participacionGastosChart')?.getContext('2d');
             const activeGastoRubros = (appState.settings.rubros?.gastos||[]).filter(r=>(calculated.annualTotals?.gastos?.[r]||0)>0);
             const gastoData = activeGastoRubros.map(r=>calculated.annualTotals.gastos[r]); displayChartNoData('participacionGastosChart', gastoData.length===0);
             if(ctxGastos && gastoData.length>0) window.participacionGastosChart_instance = new Chart(ctxGastos, {type:'doughnut',data:{labels:activeGastoRubros, datasets:[{data:gastoData,backgroundColor:generateColors(gastoData.length,chartColors,0.8),borderColor:cardBg,borderWidth:2}]},options:pieChartOptions()});

             destroyChart('participacionIngresosChart'); const ctxIngresos = document.getElementById('participacionIngresosChart')?.getContext('2d');
             const activeIngresoRubros = (appState.settings.rubros?.ingresos||[]).filter(r=>(calculated.annualTotals?.ingresos?.[r]||0)>0);
             const ingresoData = activeIngresoRubros.map(r=>calculated.annualTotals.ingresos[r]); displayChartNoData('participacionIngresosChart', ingresoData.length===0);
             if(ctxIngresos && ingresoData.length>0) window.participacionIngresosChart_instance = new Chart(ctxIngresos, {type:'doughnut',data:{labels:activeIngresoRubros, datasets:[{data:ingresoData,backgroundColor:generateColors(ingresoData.length,chartColors.slice().reverse(),0.8),borderColor:cardBg,borderWidth:2}]},options:pieChartOptions()});
        }

        function updateDashboardTables(scenarioData) {
            const summaryTable = document.getElementById('dashboard-summary'); if (!summaryTable) return;
            const tbody = summaryTable.querySelector('tbody'); const tfoot = summaryTable.querySelector('tfoot'); if (!tbody || !tfoot) return;
            tbody.innerHTML = ''; tfoot.innerHTML = '';
            if (!scenarioData?.calculated) { tbody.innerHTML = `<tr><td colspan="${summaryTable.querySelector('thead tr')?.cells.length||7}" class="text-muted" style="text-align:center;padding:20px;">No hay datos.</td></tr>`; return; }
            const { calculated } = scenarioData; const annuals = calculated.annualTotals || {};
            for (let i = 0; i < 12; i++) {
                const r=tbody.insertRow(); r.insertCell().textContent=MONTHS[i];
                r.insertCell().textContent=formatCurrency(calculated.totalGastoProyectadoMes?.[i]||0); r.insertCell().textContent=formatCurrency(calculated.fondoReservaMes?.[i]||0);
                r.insertCell().textContent=formatCurrency(calculated.cuotaSobreGastosMes?.[i]||0); r.insertCell().textContent=`${(calculated.ipcManual?.[i]||0).toFixed(1)}%`;
                r.insertCell().textContent=formatCurrency(calculated.cuotaIpcMes?.[i]||0); r.insertCell().textContent=formatCurrency(calculated.cuotaRealBaseMes?.[i]||0);
            }
            const fr=tfoot.insertRow(); fr.insertCell().textContent="TOTAL ANUAL"; fr.cells[0].style.fontWeight="bold";
            fr.insertCell().textContent=formatCurrency(annuals.gastos?.__TOTAL__||0); fr.cells[1].style.fontWeight="bold"; fr.insertCell().textContent=formatCurrency(annuals.fondoReserva||0); fr.cells[2].style.fontWeight="bold";
            fr.insertCell().textContent=formatCurrency(annuals.cuotaSobreGastos||0); fr.cells[3].style.fontWeight="bold"; fr.insertCell().textContent="-";
            fr.insertCell().textContent=formatCurrency(annuals.cuotaIpc||0); fr.cells[5].style.fontWeight="bold"; fr.insertCell().textContent=formatCurrency(annuals.cuotaRealBase||0); fr.cells[6].style.fontWeight="bold";
            updateCollapsibleTable('gastos', scenarioData); updateCollapsibleTable('ingresos', scenarioData);
        }

        function updateScenarioSelector() {
            const selector = document.getElementById('scenario-selector'); if (!selector) return;
            const prevVal = selector.value; selector.innerHTML = '';
            const scenariosForYear = Object.keys(appState.scenarios||{}).filter(k=>appState.scenarios[k]?.year===appState.currentYear).sort((a,b)=>(appState.scenarios[a]?.scenarioName||a).localeCompare(appState.scenarios[b]?.scenarioName||b));
            if(scenariosForYear.length===0){const o=document.createElement('option');o.value="";o.textContent="No hay escenarios";o.disabled=true;selector.appendChild(o);selector.value="";}
            else { scenariosForYear.forEach(k=>{if(appState.scenarios[k]){const o=document.createElement('option');o.value=k;o.textContent=`${appState.scenarios[k].scenarioName} (${appState.scenarios[k].year})`;selector.appendChild(o);}});
                if(appState.activeScenarioKey && scenariosForYear.includes(appState.activeScenarioKey)) selector.value = appState.activeScenarioKey;
                else if(scenariosForYear.includes(prevVal)) selector.value = prevVal;
                else selector.value = scenariosForYear.includes(`${appState.currentYear}_Base`) ? `${appState.currentYear}_Base` : scenariosForYear[0];
            }
            if(appState.activeScenarioKey && selector.value!==appState.activeScenarioKey && scenariosForYear.includes(appState.activeScenarioKey)) selector.value = appState.activeScenarioKey;
        }

        function updateCurrentYearAndScenarioInUI() {
            const scenario = getCurrentScenarioData();
            const year = scenario ? scenario.year : (appState.currentYear || new Date().getFullYear());
            const name = scenario ? scenario.scenarioName : "Ninguno";
            document.getElementById('dashboard-year').textContent = year; document.getElementById('dashboard-scenario').textContent = name;
            document.querySelectorAll('.current-year').forEach(s=>s.textContent=year); document.querySelectorAll('.current-scenario').forEach(s=>s.textContent=name);
        }

        function updateReportsPanel() {
             const reportsDiv = document.getElementById('reports'); if (!reportsDiv) return;
             const scenario = getCurrentScenarioData();
             const hasData = scenario?.calculated && ((scenario.calculated.totalGastoProyectadoMes?.some(v=>(v||0)!==0)??false) || (scenario.calculated.totalIngresoProyectadoMes?.some(v=>(v||0)!==0)??false) || (scenario.calculated.cuotaRealBaseMes?.some(v=>(v||0)!==0)??false));
             const disable = !scenario || !hasData;
             reportsDiv.querySelectorAll('button').forEach(btn => { btn.disabled = disable; btn.classList.toggle('disabled', disable); });
        }

        function renderEmptyState() {
            const sumTable = document.getElementById('dashboard-summary');
            if(sumTable) { sumTable.querySelector('tbody').innerHTML = `<tr><td colspan="${sumTable.querySelector('thead tr')?.cells.length||7}" class="text-muted" style="text-align:center;padding:20px;">No hay datos.</td></tr>`; sumTable.querySelector('tfoot').innerHTML=''; }
            ['gastos','ingresos'].forEach(type=>{ const t=document.getElementById(`${type}-detail-table`); if(t){t.querySelector('tbody').innerHTML=`<tr><td colspan="${t.querySelector('thead tr')?.cells.length||(type==='gastos'?16:15)}" class="text-muted" style="text-align:center;padding:20px;">No hay datos.</td></tr>`; t.querySelector('tfoot').innerHTML='';}});
            destroyChart('evolutivoCuotaChart'); displayChartNoData('evolutivoCuotaChart', true);
            destroyChart('participacionGastosChart'); displayChartNoData('participacionGastosChart', true);
            destroyChart('participacionIngresosChart'); displayChartNoData('participacionIngresosChart', true);
            document.getElementById('coefficient-values-editor').innerHTML = '<p class="text-muted">Selecciona un tipo para editar.</p>';
            document.getElementById('editing-coefficient-name').textContent = 'Ninguno';
            if(appState.uiState) appState.uiState.editingCoefficientType = null;
            const pRadio=document.getElementById('reserve-type-percent'); const fRadio=document.getElementById('reserve-type-fixed');
            if(pRadio && fRadio) { const defType=(getDefaultAppState().BaseScenarioStructureTemplate.reserveFund || {}).type || 'percent'; pRadio.checked=((getCurrentScenarioData()?.reserveFund?.type) ?? defType)==='percent';fRadio.checked=!pRadio.checked; updateReserveUI(); }
            updateSettingsPanel(); updateReportsPanel();
        }

        // --- UI Orchestration ---
        function updateUI() {
             const scenarioData = getCurrentScenarioData();
             if (!scenarioData) { renderEmptyState(); updateCurrentYearAndScenarioInUI(); updateScenarioSelector(); return; }
             updateCurrentYearAndScenarioInUI(); updateScenarioSelector();
             updateDashboardTables(scenarioData); updateCharts(scenarioData);
             updateReserveFundPanel(scenarioData); updateSettingsPanel(); updateReportsPanel();
        }

        function initUI() {
             document.getElementById('exercise-year')?.setAttribute('value', appState.currentYear || new Date().getFullYear());
             const footerYearEl = document.getElementById('footer-year');
             if(footerYearEl) footerYearEl.textContent = new Date().getFullYear();
             updateScenarioSelector(); updateCurrentYearAndScenarioInUI();
        }

        // --- Tema ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)')?.matches ?? false;
            appState.darkMode = (savedTheme === 'dark') || (!savedTheme && prefersDark);
            if (window.matchMedia) {
                 window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (!localStorage.getItem('theme')) { appState.darkMode = event.matches; applyTheme(true); saveState(); }
                 });
            }
            applyTheme(false); // Apply theme without forcing chart updates if not necessary yet
        }

        function toggleTheme() {
            appState.darkMode = !appState.darkMode;
            localStorage.setItem('theme', appState.darkMode ? 'dark' : 'light');
            applyTheme(true);
            saveState();
        }

        function applyTheme(updateChartsUI = true){
            document.body.classList.toggle('dark-mode', appState.darkMode);
            const toggleButton = document.getElementById('theme-toggle');
            if (toggleButton) {
                 toggleButton.innerHTML = appState.darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                 toggleButton.title = appState.darkMode ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro';
            }
            if (updateChartsUI) {
                 requestAnimationFrame(() => {
                     Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                     ['evolutivoCuotaChart', 'participacionGastosChart', 'participacionIngresosChart'].forEach(id => {
                          if (window[`${id}_instance`]) window[`${id}_instance`].update();
                     });
                 });
            }
        }

        // --- Manejo de Eventos y Acciones del Usuario ---
        function openTab(evt, tabName) {
             if(!tabName)return; Array.from(document.getElementsByClassName("tab-content")).forEach(tc=>{tc.classList.remove("active");tc.style.display="none";});
             Array.from(document.getElementsByClassName("tab-link")).forEach(tl=>tl.classList.remove("active"));
             const tab=document.getElementById(tabName); if(tab){tab.style.display="block";void tab.offsetWidth;tab.classList.add("active");}
             if(evt?.currentTarget) evt.currentTarget.classList.add("active");
             if(tabName==='dashboard') requestAnimationFrame(()=>{['evolutivoCuotaChart','participacionGastosChart','participacionIngresosChart'].forEach(id=>{if(window[`${id}_instance`])window[`${id}_instance`].resize();});});
         }

        function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
        let collapsibleListenersAdded = false;
        function addCollapsibleListeners() {
             const container = document.querySelector('.container'); if(!container||collapsibleListenersAdded)return;
             container.addEventListener('click', (event) => {
                 const targetRow = event.target.closest('tr.rubro-total-row');
                 if (targetRow && (targetRow.closest('#gastos-detail-table') || targetRow.closest('#ingresos-detail-table'))) {
                     const rubro = targetRow.dataset.rubro; const type = targetRow.dataset.type; if(rubro&&type) toggleRubroDetails(type,rubro);
                 }
             }); collapsibleListenersAdded = true;
        }

        function toggleRubroDetails(type, rubro) {
              appState.settings.rubroConfig = appState.settings.rubroConfig ?? {};
              appState.settings.rubroConfig[rubro] = appState.settings.rubroConfig[rubro] ?? { detailsCollapsed: true };
              if(appState.settings.rubroConfig[rubro].detailsCollapsed===undefined) appState.settings.rubroConfig[rubro].detailsCollapsed=true;
             const newState = !appState.settings.rubroConfig[rubro].detailsCollapsed; appState.settings.rubroConfig[rubro].detailsCollapsed = newState;
             const totalRow = document.querySelector(`#${type}-detail-table tr.rubro-total-row[data-rubro="${rubro}"][data-type="${type}"]`); if(!totalRow){saveState();return;}
             totalRow.classList.toggle('collapsed', newState);
             let nextSib = totalRow.nextElementSibling;
             while(nextSib){ if(nextSib.classList.contains('detail-row') && nextSib.dataset.rubro===rubro && nextSib.dataset.type===type){ nextSib.classList.toggle('hidden',newState); nextSib=nextSib.nextElementSibling; } else break; }
             saveState();
        }

        function toggleAllRubroDetails(type, collapse) {
             const table = document.getElementById(`${type}-detail-table`); if(!table?.querySelector('tbody'))return;
             const totalRows = table.querySelectorAll('tbody tr.rubro-total-row'); if(totalRows.length===0){showSnackbar(`No hay rubros de ${type}.`,false,'info');return;}
             let changesMade=false;
             totalRows.forEach(totalRow => {
                  const rubro = totalRow.dataset.rubro; const rowType = totalRow.dataset.type; if(!rubro||rowType!==type)return;
                  appState.settings.rubroConfig = appState.settings.rubroConfig ?? {}; appState.settings.rubroConfig[rubro] = appState.settings.rubroConfig[rubro] ?? { detailsCollapsed: true };
                  if(appState.settings.rubroConfig[rubro].detailsCollapsed !== collapse){ appState.settings.rubroConfig[rubro].detailsCollapsed = collapse; changesMade=true; totalRow.classList.toggle('collapsed',collapse);
                      let nextSib = totalRow.nextElementSibling; while(nextSib){if(nextSib.classList.contains('detail-row')&&nextSib.dataset.rubro===rubro&&nextSib.dataset.type===type){nextSib.classList.toggle('hidden',collapse);nextSib=nextSib.nextElementSibling;}else break;}}
             });
             if(changesMade){saveState();showSnackbar(`Detalles ${collapse?'colapsados':'expandidos'}.`,false,'info');} else showSnackbar(`Detalles ya ${collapse?'colapsados':'expandidos'}.`,false,'info');
         }

        function handleCoefficientAssignmentChange(event) {
             const select = event.target; const rubro = select.dataset.rubro; const newCoefType = select.value;
             if (rubro && newCoefType !== undefined && appState.settings.rubroConfig) {
                 appState.settings.rubroConfig[rubro] = appState.settings.rubroConfig[rubro] ?? {};
                 appState.settings.rubroConfig[rubro].coefficientType = newCoefType; saveState(); // No es necesario recalcular aquí, solo al guardar settings
                 showSnackbar(`Coeficiente para "${rubro}" asignado. Guarda configuración para recalcular.`, false, 'info');
             } else showSnackbar("Error al asignar coeficiente.", true, 'error');
         }

        function handleCoefficientValueChange(event) {
             const input=event.target; const monthIdx=parseInt(input.dataset.month); const typeKey=input.dataset.typeKey; const value=parseFloat(input.value);
             const typeData=appState.settings.coefficientTypes?.[typeKey];
             if(!typeKey||!typeData||isNaN(monthIdx)||monthIdx<0||monthIdx>11){ input.value=typeData?.values?.[monthIdx]||0; showSnackbar("Error: Coeficiente/mes inválido.",true,'error'); return;}
             const isNone = typeKey==='None'; const isValid = !isNaN(value)&&(isNone||value>=-100);
             if(isValid){ if(!Array.isArray(typeData.values)||typeData.values.length!==12)typeData.values=Array(12).fill(isNone?1:0); typeData.values[monthIdx]=value; saveState(); }
             else { input.value=typeData.values[monthIdx]||(isNone?1:0); showSnackbar(`Valor inválido para ${FULL_MONTHS[monthIdx]}. Debe ser >= -100.`,true,'error'); }
         }

        function addRubro(type) {
            const inputId = type === 'gastos' ? 'new-gasto-rubro-name' : 'new-ingreso-rubro-name';
            const inputElement = document.getElementById(inputId); if (!inputElement) return;
            const rubroName = inputElement.value.trim();
            if (!rubroName) { showSnackbar("El nombre del rubro no puede estar vacío.", true, 'error'); return; }
            appState.settings.rubros[type] = appState.settings.rubros[type] || [];
            if (appState.settings.rubros[type].includes(rubroName)) { showSnackbar(`El rubro "${rubroName}" ya existe.`, true, 'warning'); return; }
            appState.settings.rubros[type].push(rubroName);
            appState.settings.rubroConfig[rubroName] = appState.settings.rubroConfig[rubroName] || { coefficientType: 'None', detailsCollapsed: true };
            inputElement.value = '';
            updateRubroList(type, type === 'gastos' ? 'gasto-rubro-list' : 'ingreso-rubro-list');
            showSnackbar(`Rubro "${rubroName}" añadido. Guarda la configuración para aplicar.`, false, 'info');
        }

        function removeRubro(type, rubroName) {
            if (!confirm(`¿Eliminar el rubro "${rubroName}"? Esto podría afectar datos existentes si no se guarda la configuración.`)) return;
            appState.settings.rubros[type] = (appState.settings.rubros[type] || []).filter(r => r !== rubroName);
            updateRubroList(type, type === 'gastos' ? 'gasto-rubro-list' : 'ingreso-rubro-list');
            showSnackbar(`Rubro "${rubroName}" eliminado de la lista. Guarda la configuración.`, false, 'info');
        }

        function addCoefficientType() {
            const inputElement = document.getElementById('new-coefficient-type-name'); if (!inputElement) return;
            const name = inputElement.value.trim();
            if (!name) { showSnackbar("El nombre del tipo de coeficiente no puede estar vacío.", true, 'error'); return; }
            const key = name.replace(/\s+/g, '_').replace(/[^\w-]/g, '');
            if (!key) { showSnackbar("Nombre de tipo inválido tras sanitizar.", true, 'error'); return; }
            if (appState.settings.coefficientTypes[key]) { showSnackbar(`El tipo de coeficiente "${name}" (o su clave "${key}") ya existe.`, true, 'warning'); return; }
            appState.settings.coefficientTypes[key] = { name: name, values: Array(12).fill(0), isDefault: false };
            inputElement.value = '';
            updateCoefficientTypeList();
            showSnackbar(`Tipo de coeficiente "${name}" añadido. Edita sus valores y guarda.`, false, 'info');
        }

        function removeCoefficientType(typeKey) {
            if (appState.settings.coefficientTypes[typeKey]?.isDefault) { showSnackbar("No se pueden eliminar tipos de coeficiente por defecto.", true, 'warning'); return; }
            if (!confirm(`¿Eliminar el tipo de coeficiente "${appState.settings.coefficientTypes[typeKey]?.name}"?`)) return;
            delete appState.settings.coefficientTypes[typeKey];
            Object.values(appState.settings.rubroConfig).forEach(rc => { if (rc.coefficientType === typeKey) rc.coefficientType = 'None'; });
            if (appState.uiState.editingCoefficientType === typeKey) {
                appState.uiState.editingCoefficientType = null;
                renderCoefficientValuesEditor(null); // Limpia el editor
            }
            updateCoefficientTypeList();
            updateRubroList('gastos', 'gasto-rubro-list');
            showSnackbar(`Tipo de coeficiente eliminado. Guarda la configuración.`, false, 'info');
        }

        function editCoefficientType(typeKey) {
            if (typeKey === 'None' || typeKey === 'IPC') {
                const editorDiv = document.getElementById('coefficient-values-editor');
                const nameSpan = document.getElementById('editing-coefficient-name');
                if(nameSpan) nameSpan.textContent = appState.settings.coefficientTypes[typeKey]?.name || 'Error';
                if(editorDiv) editorDiv.innerHTML = `<p class="text-muted">Los valores para "${appState.settings.coefficientTypes[typeKey]?.name}" no se editan aquí directamente.</p>`;
                appState.uiState.editingCoefficientType = typeKey;
                return;
            }
            appState.uiState.editingCoefficientType = typeKey;
            renderCoefficientValuesEditor(typeKey);
        }

        function createNewExercise() {
            const yearInput = document.getElementById('exercise-year'); if (!yearInput) return; const newYear = parseInt(yearInput.value);
            if (isNaN(newYear)||newYear<2000||newYear>2099) { showSnackbar("Año inválido.",true,'error'); yearInput.value=appState.currentYear; return; }
            if (newYear===appState.currentYear && Object.keys(appState.scenarios||{}).some(k=>appState.scenarios[k]?.year===newYear)){ showSnackbar(`Año ${newYear} ya seleccionado.`,false,'info'); return; }
            appState.currentYear = newYear; validateAndSetActiveScenario(); updateUI(); showSnackbar(`Ejercicio para ${appState.currentYear} seleccionado/creado.`,false,'success'); saveState();
        }

        function createScenario() {
            const name = prompt(`Nombre para nuevo escenario (Año ${appState.currentYear}):`, `Escenario ${Object.keys(appState.scenarios).filter(k=>appState.scenarios[k]?.year===appState.currentYear).length+1}`);
            if (!name?.trim()) { showSnackbar("Creación cancelada.",false,'info'); return; }
            const sanName = name.trim().replace(/\s+/g,'_').replace(/[^\w-]/g,''); if(!sanName){showSnackbar("Nombre inválido.",true,'error');return;}
            const newKey = `${appState.currentYear}_${sanName}`; if(appState.scenarios[newKey]){showSnackbar(`Escenario "${name}" ya existe.`,true,'error');return;}
            initScenarioData(appState.currentYear, name.trim()); appState.activeScenarioKey = newKey;
            initializeScenarioDataForRubros(appState.scenarios[newKey]); calculateAll(appState.scenarios[newKey]);
            showSnackbar(`Escenario "${name.trim()}" creado y activado.`,false,'success');
        }

        function cloneScenario() {
            const current = getCurrentScenarioData(); if(!current){showSnackbar("No hay escenario activo para clonar.",true,'error');return;}
            const newName = prompt(`Nombre para clon (base: "${current.scenarioName}"):`, `${current.scenarioName}_Copia`);
            if(!newName?.trim()){showSnackbar("Clonación cancelada.",false,'info');return;}
            const sanNewName = newName.trim().replace(/\s+/g,'_').replace(/[^\w-]/g,''); if(!sanNewName){showSnackbar("Nombre inválido.",true,'error');return;}
            const newKey = `${current.year}_${sanNewName}`; if(appState.scenarios[newKey]){showSnackbar(`Escenario "${newName}" ya existe.`,true,'error');return;}
            appState.scenarios[newKey] = JSON.parse(JSON.stringify(current)); appState.scenarios[newKey].scenarioName = newName.trim();
            appState.activeScenarioKey = newKey; appState.currentYear = current.year;
            initializeScenarioDataForRubros(appState.scenarios[newKey]); calculateAll(appState.scenarios[newKey]);
            showSnackbar(`Escenario clonado como "${newName.trim()}" y activado.`,false,'success');
        }

        function deleteScenario() {
            const key=appState.activeScenarioKey; const current=getCurrentScenarioData(); if(!current){showSnackbar("No hay escenario para eliminar.",true,'error');return;}
            if(Object.keys(appState.scenarios).filter(k=>appState.scenarios[k]?.year===current.year).length<=1 && current.scenarioName.toLowerCase()==='base'){showSnackbar(`No se puede eliminar el único "Base".`,true,'warning');return;}
            if(!confirm(`¿Eliminar escenario "${current.scenarioName}" (Año ${current.year})? ¡No se puede deshacer!`)){showSnackbar("Eliminación cancelada.",false,'info');return;}
            delete appState.scenarios[key]; appState.activeScenarioKey = null; validateAndSetActiveScenario(); updateUI(); saveState();
            showSnackbar(`Escenario "${current.scenarioName}" eliminado.`,false,'success');
        }

        function saveReserveFund() {
            const scenario = getCurrentScenarioData(); if(!scenario){showSnackbar("No hay escenario activo.",true,'error');return;}
            const type = document.getElementById('reserve-type-percent').checked ? 'percent' : 'fixed';
            scenario.reserveFund.type = type; scenario.reserveFund.values = []; let allValid=true;
            document.querySelectorAll('#reserve-fund-panel input[type="number"]').forEach((input,i)=>{
                const val = parseFloat(input.value);
                if(isNaN(val)||val<0){showSnackbar(`Valor inválido para ${FULL_MONTHS[i]}.`,true,'error');input.value=scenario.reserveFund.values[i]||(type==='percent'?5:0);allValid=false;return;}
                scenario.reserveFund.values[i]=val;
            });
            if(!allValid)return; showSnackbar("Fondo de reserva guardado. Recalculando...",false,'info'); calculateAll(scenario);
        }

        function saveSettings() {
            const ufInput = document.getElementById('cantidad-unidades'); const cantidadUF = parseInt(ufInput.value);
            if(isNaN(cantidadUF)||cantidadUF<1){showSnackbar("UF inválida. Debe ser >= 1.",true,'error');ufInput.value=appState.settings.cantidadUnidades;return;}
            appState.settings.cantidadUnidades=cantidadUF; const scenario=getCurrentScenarioData();
            if(!scenario){showSnackbar("No hay escenario activo para aplicar config.",true,'error');saveState();updateSettingsPanel();return;}
            showSnackbar("Configuración guardada. Recalculando...",false,'info'); calculateAll(scenario);
        }

        function handleFileUpload(files) {
            const file = files[0]; const feedbackDiv = document.getElementById('file-upload-feedback'); if(!feedbackDiv)return; feedbackDiv.textContent = '';
            if(!file){feedbackDiv.textContent="No se seleccionó archivo.";feedbackDiv.style.color='var(--danger-color)';return;}
            if(!file.name.match(/\.(xlsx|xls)$/i)){feedbackDiv.textContent=`Archivo no válido: ${file.name}.`;feedbackDiv.style.color='var(--danger-color)';showSnackbar("Tipo de archivo no válido.",true,'error');return;}
            feedbackDiv.textContent=`Cargando ${file.name}...`; feedbackDiv.style.color='var(--info-color)';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result),{type:'array',cellDates:true}); const scenario = getCurrentScenarioData();
                    if(!scenario){showSnackbar("No hay escenario activo para cargar datos.",true,'error');feedbackDiv.textContent="Error: No hay escenario activo.";feedbackDiv.style.color='var(--danger-color)';return;}
                    let newGR=[],newIR=[],newGD={},newID={},processed=false;
                    [GASTOS_SHEET_NAME,INGRESOS_SHEET_NAME].forEach((sheetName,idx)=>{
                        const type = idx===0?'gastos':'ingresos'; const sheet = workbook.Sheets[sheetName];
                        if(sheet){ const jsonData=XLSX.utils.sheet_to_json(sheet,{header:1,blankrows:false});
                            if(jsonData.length>1){ scenario.data[type]={}; if(type==='gastos')scenario.monthStatus.gastos={}; if(!Array.isArray(appState.settings.rubros[type]))appState.settings.rubros[type]=[];
                                for(let i=1;i<jsonData.length;i++){ const row=jsonData[i],rName=String(row[0]||'').trim(),dName=String(row[1]||'').trim(); if(!rName||!dName)continue;
                                    if(!appState.settings.rubros[type].includes(rName)){appState.settings.rubros[type].push(rName);(type==='gastos'?newGR:newIR).push(rName);appState.settings.rubroConfig[rName]=appState.settings.rubroConfig[rName]||{coefficientType:'None',detailsCollapsed:true};}
                                    if(!scenario.rubroOrder[type].includes(rName))scenario.rubroOrder[type].push(rName);
                                    if(!scenario.data[type][rName]){scenario.data[type][rName]={detailOrder:[],detailsData:{}};if(type==='gastos')scenario.monthStatus.gastos[rName]={};}
                                    if(!scenario.data[type][rName].detailOrder.includes(dName)){scenario.data[type][rName].detailOrder.push(dName);const newDetailsArray=(type==='gastos'?newGD:newID);if(!newDetailsArray[rName])newDetailsArray[rName]=[];if(!newDetailsArray[rName].includes(dName))newDetailsArray[rName].push(dName);}
                                    scenario.data[type][rName].detailsData[dName]=[];if(type==='gastos')scenario.monthStatus.gastos[rName][dName]=[];
                                    for(let m=0;m<12;m++){ const cellVal=row[2+m],numVal=parseFloat(cellVal);
                                        if(type==='gastos'){if(typeof cellVal==='number'&&!isNaN(numVal)){scenario.data.gastos[rName].detailsData[dName][m]=numVal;scenario.monthStatus.gastos[rName][dName][m]='REAL';}else{scenario.data.gastos[rName].detailsData[dName][m]=0;scenario.monthStatus.gastos[rName][dName][m]='Estimado';}}
                                        else scenario.data.ingresos[rName].detailsData[dName][m]=(typeof cellVal==='number'&&!isNaN(numVal))?numVal:0;
                                    }} processed=true;
                            } else feedbackDiv.textContent+=`\nHoja "${sheetName}" vacía/malformada.`;
                        } else feedbackDiv.textContent+=`\nHoja "${sheetName}" no encontrada.`;
                    });
                    if(processed){ let msg=""; if(newGR.length>0)msg+=`\nNuevos Gasto Rubros: ${newGR.join(', ')}.`; if(newIR.length>0)msg+=`\nNuevos Ingreso Rubros: ${newIR.join(', ')}.`;
                        feedbackDiv.textContent=`Archivo "${file.name}" procesado.${msg}\nRecalculando...`;feedbackDiv.style.color='var(--success-color)';
                        initializeScenarioDataForRubros(scenario); calculateAll(scenario); showSnackbar(`Datos de "${file.name}" cargados.${msg}`,false,'success',6000); updateSettingsPanel();
                    } else { if(!feedbackDiv.textContent.includes("Error:"))feedbackDiv.textContent="No se procesaron datos válidos."; showSnackbar("No se procesaron datos.",true,'error');}
                } catch(err){console.error("Error procesando Excel:",err);feedbackDiv.textContent=`Error: ${err.message}`;showSnackbar("Error grave procesando Excel.",true,'error');}
            }; reader.onerror=err=>{console.error("Error leyendo archivo:",err);feedbackDiv.textContent="Error al leer archivo.";showSnackbar("Error al leer archivo.",true,'error');};
            reader.readAsArrayBuffer(file);
        }

        function downloadTemplate() {
            const wb=XLSX.utils.book_new(); const hGastos=["Rubro","Detalle",...MONTHS,"Total Anual (Calculado)"]; const hIngresos=hGastos;
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([hGastos,["Ej: Seguridad","Ej: Vigilador",...Array(12).fill(""),""]]),GASTOS_SHEET_NAME);
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([hIngresos,["Ej: Expensas Ordinarias","Base por UF",...Array(12).fill(""),""]]),INGRESOS_SHEET_NAME);
            XLSX.writeFile(wb,`Plantilla_Expensas_${appState.currentYear}.xlsx`); showSnackbar("Plantilla descargada.",false,'success');
        }

        function loadSampleData() {
            if(!confirm("¿Cargar datos ejemplo? Reemplazará datos del escenario actual.")) {showSnackbar("Carga cancelada.",false,'info');return;}
            const scenario=getCurrentScenarioData(); if(!scenario){showSnackbar("No hay escenario activo.",true,'error');return;}
            appState.settings.rubros={gastos:["Seguridad","Mantenimiento","Administración"],ingresos:[CUOTA_RUBRO_NAME,"Alquiler SUM","Intereses Plazo Fijo"]};
            appState.settings.cantidadUnidades=150; appState.settings.ipcManual=[1,1.2,0.8,1.5,2,1.3,1,0.5,0.7,1.1,1.4,1]; ensureDefaultCoefficientTypes();
            appState.settings.coefficientTypes["SueldosAdmin"]={name:"Sueldos Admin",values:Array(12).fill(2.5),isDefault:false};
            appState.settings.rubroConfig={"Seguridad":{coefficientType:"UTEDYC",detailsCollapsed:false},"Mantenimiento":{coefficientType:"IPC",detailsCollapsed:true},"Administración":{coefficientType:"SueldosAdmin",detailsCollapsed:false},[CUOTA_RUBRO_NAME]:{detailsCollapsed:false},"Alquiler SUM":{detailsCollapsed:true},"Intereses Plazo Fijo":{detailsCollapsed:false}};
            scenario.data.gastos={"Seguridad":{detailOrder:["Vigiladores","Monitoreo"],detailsData:{"Vigiladores":[100000,101000,102000,103000,110000,111000,112000,113000,120000,121000,122000,123000],"Monitoreo":Array(12).fill(25000)}},"Mantenimiento":{detailOrder:["Limpieza","Jardinería"],detailsData:{"Limpieza":Array(12).fill(30000),"Jardinería":[15000,15000,16000,16000,17000,17000,18000,18000,19000,19000,20000,20000]}},"Administración":{detailOrder:["Honorarios Admin","Gastos Bancarios"],detailsData:{"Honorarios Admin":Array(12).fill(50000),"Gastos Bancarios":Array(12).fill(5000)}}};
            scenario.monthStatus.gastos={"Seguridad":{"Vigiladores":Array(12).fill('REAL'),"Monitoreo":Array(12).fill('REAL')},"Mantenimiento":{"Limpieza":Array(12).fill('REAL'),"Jardinería":Array(12).fill('REAL')},"Administración":{"Honorarios Admin":Array(12).fill('REAL'),"Gastos Bancarios":Array(12).fill('REAL')}};
            scenario.rubroOrder.gastos=["Seguridad","Mantenimiento","Administración"];
            scenario.data.ingresos={[CUOTA_RUBRO_NAME]:{detailOrder:["Cuota Base UF"],detailsData:{"Cuota Base UF":Array(12).fill(35.5)}},"Alquiler SUM":{detailOrder:["Eventos FinDeSemana"],detailsData:{"Eventos FinDeSemana":[5000,0,7000,0,10000,0,12000,0,8000,0,6000,0]}},"Intereses Plazo Fijo":{detailOrder:["Fondo Común Inv."],detailsData:{"Fondo Común Inv.":[1000,1100,1050,1200,1150,1300,1250,1400,1350,1500,1450,1600]}}};
            scenario.rubroOrder.ingresos=[CUOTA_RUBRO_NAME,"Alquiler SUM","Intereses Plazo Fijo"];
            scenario.reserveFund={type:'percent',values:[5,5,5,6,6,6,7,7,7,8,8,8]};
            initializeScenarioDataForRubros(scenario); calculateAll(scenario); updateSettingsPanel(); showSnackbar("Datos de ejemplo cargados.",false,'success');
        }

        function exportToExcel() {
            const scenario = getCurrentScenarioData(); if(!scenario){showSnackbar("No hay datos para exportar.",true,'error');return;}
            const wb=XLSX.utils.book_new(); const sumData=[["Mes","Gasto ($)","Fondo ($)","Cuota s/Gs ($/UF)","IPC (%)","Cuota IPC ($/UF)","Expensa Real ($/UF)"]];
            for(let i=0;i<12;i++)sumData.push([MONTHS[i],scenario.calculated.totalGastoProyectadoMes?.[i]||0,scenario.calculated.fondoReservaMes?.[i]||0,scenario.calculated.cuotaSobreGastosMes?.[i]||0,scenario.calculated.ipcManual?.[i]||0,scenario.calculated.cuotaIpcMes?.[i]||0,scenario.calculated.cuotaRealBaseMes?.[i]||0]);
            sumData.push(["TOTAL ANUAL",scenario.calculated.annualTotals.gastos?.__TOTAL__||0,scenario.calculated.annualTotals.fondoReserva||0,scenario.calculated.annualTotals.cuotaSobreGastos||0,"-",scenario.calculated.annualTotals.cuotaIpc||0,scenario.calculated.annualTotals.cuotaRealBase||0]);
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sumData),"Resumen General");
            const gData=[["Rubro","Detalle","Coef. Aplicado",...MONTHS,"Total Anual"]];
            (appState.settings.rubros?.gastos||[]).forEach(r=>{if(!scenario.data.gastos[r])return; const cfg=appState.settings.rubroConfig[r]||{};const cKey=cfg.coefficientType||'None';const cName=appState.settings.coefficientTypes[cKey]?.name||'N/A';const rTotals=scenario.calculated.totalGastoRubroMes?.[r]||Array(12).fill(0);gData.push([r,"TOTAL RUBRO","",...rTotals,scenario.calculated.annualTotals.gastos?.[r]||0]);(scenario.data.gastos[r]?.detailOrder||[]).forEach(d=>{const dVals=scenario.calculated.gastoAjustado?.[r]?.[d]||Array(12).fill(0);gData.push(["",d,cName,...dVals,dVals.reduce((s,v)=>s+v,0)]);});});
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(gData),"Detalle Gastos");
            const iData=[["Rubro","Detalle",...MONTHS,"Total Anual"]];
            (appState.settings.rubros?.ingresos||[]).forEach(r=>{if(!scenario.data.ingresos[r])return; const rTotals=scenario.calculated.totalIngresoRubroMes?.[r]||Array(12).fill(0);iData.push([r,"TOTAL RUBRO (Calculado)",...rTotals,scenario.calculated.annualTotals.ingresos?.[r]||0]);(scenario.data.ingresos[r]?.detailOrder||[]).forEach(d=>{const dBaseVals=scenario.calculated.ingresoAjustado?.[r]?.[d]||Array(12).fill(0);iData.push(["",d+(SPECIAL_INGRESO_RUBROS.includes(r)?" (Valor Base x UF)":" (Valor Base)"),...dBaseVals,dBaseVals.reduce((s,v)=>s+v,0)]);});});
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(iData),"Detalle Ingresos (Base)");
            const cfgData=[["Parámetro","Valor"],["Año Ejercicio",scenario.year],["Nombre Escenario",scenario.scenarioName],["Cantidad UF",appState.settings.cantidadUnidades],["Fondo Reserva Tipo",scenario.reserveFund.type],...scenario.reserveFund.values.map((v,i)=>[ `Fondo Reserva ${MONTHS[i]}`,v]),...appState.settings.ipcManual.map((v,i)=>[ `IPC Manual ${MONTHS[i]} (%)`,v])];
            Object.entries(appState.settings.coefficientTypes).forEach(([k,t])=>{cfgData.push([`Coef. Tipo: ${t.name} (${k})`,"Valores Mensuales (%)"]);t.values.forEach((v,i)=>cfgData.push([MONTHS[i],v]));});
            (appState.settings.rubros?.gastos||[]).forEach(r=>{const cK=appState.settings.rubroConfig[r]?.coefficientType||'None';cfgData.push([`Rubro Gasto: ${r}`,`Coef. Asignado: ${appState.settings.coefficientTypes[cK]?.name||'N/A'}`]);});
            XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cfgData),"Configuración Aplicada");
            XLSX.writeFile(wb,`Reporte_Expensas_${scenario.year}_${scenario.scenarioName.replace(/\s+/g,'_')}.xlsx`); showSnackbar("Reporte Excel generado.",false,'success');
        }

        function exportChart(chartId, filename) {
            const instance = window[`${chartId}_instance`];
            if(instance){try{const img=instance.toBase64Image();const link=document.createElement('a');link.href=img;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);showSnackbar(`Gráfico "${filename}" descargado.`,false,'success');}catch(e){showSnackbar("Error exportando gráfico.",true,'error');}}
            else showSnackbar("Gráfico no disponible.",true,'warning');
        }

        function clearScenarioData() {
             const key=appState.activeScenarioKey; const scenario=appState.scenarios?.[key]; if(!scenario){showSnackbar('No hay escenario activo.',true,'error');return;}
             if(!confirm(`¿Borrar TODOS los datos (gastos, ingresos, status) del escenario "${scenario.scenarioName}" (Año ${scenario.year})?\nConfiguración de Fondo, Coeficientes y rubros se mantendrán.\n¡No se puede deshacer!`)){showSnackbar("Operación cancelada.",false,'info');return;}
             scenario.data={gastos:{},ingresos:{}}; scenario.monthStatus={gastos:{},ingresos:{}}; scenario.rubroOrder={gastos:[],ingresos:[]};
             saveState(); calculateAll(scenario);
        }

        // --- Inicialización de EventListeners ---
        function addEventListeners() {
             document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
             document.getElementById('scenario-selector')?.addEventListener('change', (event) => {
                 const newKey = event.target.value; const newScenario = appState.scenarios?.[newKey];
                 if(newKey&&newScenario){appState.activeScenarioKey=newKey;appState.currentYear=newScenario.year||parseInt(newKey.split('_')[0])||new Date().getFullYear();initializeScenarioDataForRubros(newScenario);calculateAll(newScenario);}
                 else if(newKey===""){appState.activeScenarioKey=null;validateAndSetActiveScenario();updateUI();}
                 else {showSnackbar(`Error: Escenario no válido.`,true,'error');if(appState.activeScenarioKey&&appState.scenarios?.[appState.activeScenarioKey])event.target.value=appState.activeScenarioKey;else event.target.value="";updateUI();}
             });
             const uploadArea = document.getElementById('file-upload-area');
             if(uploadArea){ ['dragenter','dragover','dragleave','drop'].forEach(evtName=>document.body.addEventListener(evtName,preventDefaults,false));
                 ['dragenter','dragover'].forEach(evtName=>uploadArea.addEventListener(evtName,()=>uploadArea.style.backgroundColor='var(--clickable-row-hover)',false));
                 ['dragleave','drop'].forEach(evtName=>uploadArea.addEventListener(evtName,()=>uploadArea.style.backgroundColor='var(--bg-color)',false));
                 uploadArea.addEventListener('drop',(event)=>{const files=event.dataTransfer.files;if(files.length>0)handleFileUpload(files);},false);
                 window.addEventListener('beforeunload',()=>{['dragenter','dragover','dragleave','drop'].forEach(evtName=>document.body.removeEventListener(evtName,preventDefaults,false));});
             }
             addCollapsibleListeners();
        }

        // --- Punto de Entrada Principal del Script ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState(); // Carga el estado guardado o el por defecto
            initTheme(); // Configura el tema visual
            validateAndSetActiveScenario(); // Valida o establece un escenario activo

            // Actualiza elementos informativos fijos
            const cuotaInfoSpan1 = document.getElementById('cuota-rubro-name-info');
            if (cuotaInfoSpan1) cuotaInfoSpan1.textContent = CUOTA_RUBRO_NAME;
            const cuotaInfoSpan2 = document.getElementById('cuota-rubro-name-info2');
            if (cuotaInfoSpan2) cuotaInfoSpan2.textContent = CUOTA_RUBRO_NAME;

            initUI(); // Inicializa la UI con los datos actuales
            addEventListeners(); // Añade los listeners de eventos
            updateUI(); // Primera actualización completa de la UI
            console.log(`App ${STORAGE_KEY} Inicializada Completamente.`);
        });

    </script>
</body>
</html>
```