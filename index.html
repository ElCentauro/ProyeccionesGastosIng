<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Proyección Expensas - Barrio El Centauro</title>
    <!-- Librería SheetJS (js-xlsx) para leer/escribir Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Librería Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin doughnut 3D shadow -->
    <script>
    /* Plugin: doughnutShadow3D
       Añade una sombra suave debajo de cada porción para simular profundidad 3 D.
       Seguro para todos los datasets (evita NaN en createRadialGradient). */
    const doughnutShadow3D = {
      id: 'doughnutShadow3D',
      afterDatasetDraw(chart, args, opts) {
        const {ctx} = chart;
        if (args.meta.type !== 'doughnut') return;
    
        args.meta.data.forEach(segment => {
          const {x, y, startAngle, endAngle, innerRadius, outerRadius} = segment;
          if (!isFinite(x) || !isFinite(y) || !isFinite(innerRadius) || !isFinite(outerRadius)) return;
    
          ctx.save();
          ctx.fillStyle = 'rgba(0,0,0,0.15)';      // shadow color
          ctx.translate(0, 4);                     // vertical offset
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.arc(x, y, outerRadius, startAngle, endAngle);
          ctx.arc(x, y, innerRadius, endAngle, startAngle, true);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        });
      }
    };
    // Registrar plugin globalmente
    if (window.Chart && !Chart.registry.plugins.get('doughnutShadow3D')) {
      Chart.register(doughnutShadow3D);
    }
    </script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Reset Básico y Fuentes --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; /* Base font size */ }
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.7; /* Improved readability */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
    
        /* --- Variables de Color (Paleta Refinada) --- */
        :root {
            --bg-color: #f8f9fa;              /* Slightly off-white */
            --text-color: #343a40;            /* Darker gray */
            --primary-color: #007bff;          /* Classic blue */
            --primary-color-darker: #006fe6;    /* Darker blue for hover */
            --secondary-color: #6c757d;        /* Gray */
            --secondary-color-darker: #5a6268;  /* Darker gray for hover */
            --danger-color: #dc3545;           /* Bootstrap red */
            --success-color: #28a745;          /* Bootstrap green */
            --warning-color: #ffc107;          /* Bootstrap yellow */
            --info-color: #17a2b8;             /* Bootstrap cyan */
            --light-color: #f8f9fa;            /* Bootstrap light */
            --dark-color: #343a40;             /* Bootstrap dark */
            --input-focus-shadow: rgba(0, 123, 255, 0.25); /* Blue shadow */
            --disabled-bg: #e9ecef;           /* Disabled background */
            --disabled-text: #6c757d;         /* Disabled text */
        }
    
        body.dark-mode {
            --bg-color: #1a1a1a;              /* Very dark gray */
            --text-color: #f1f1f1;            /* Light gray */
            --primary-color: #66bfff;         /* Lighter blue for contrast */
            --primary-color-darker: #52a3e0;  /* Lighter hover blue */
            --secondary-color: #8a8d90;       /* Gray adjusted for dark mode */
            --secondary-color-darker: #6f7275;/* Darker gray for hover in dark mode */
            --danger-color: #ff6b6b;          /* Red (lighter for dark mode) */
            --success-color: #51cf66;         /* Green (lighter for dark mode) */
            --warning-color: #ffec99;         /* Yellow (lighter for dark mode) */
            --info-color: #63e6be;            /* Cyan (lighter for dark mode) */
            --light-color: #343a40;           /* Dark now */
            --dark-color: #f8f9fa;            /* Light now */
            --input-focus-shadow: rgba(102, 191, 255, 0.25); /* Lighter blue shadow */
            --disabled-bg: #343a40;           /* Disabled background in dark */
            --disabled-text: #8a8d90;         /* Disabled text in dark */
        }
    
        /* --- Estilos Generales --- */
        .container { width: 95%; max-width: 1700px; margin: 0 auto; padding: 25px 20px; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 1em; font-weight: 600; }
        h1 { font-size: 2.2rem; text-align: center; }
        h2 { font-size: 1.6rem; margin-top: 1em; }
        h3 { font-size: 1.4rem; margin-top: 1.8em; }
        h4 { font-size: 1.15rem; color: var(--secondary-color); margin-top: 1.2em; margin-bottom: 0.6em; }
        p, li { font-size: 0.9rem; }
        ul { padding-left: 1.2em; }
        li { margin-bottom: 0.3em; }
        a { color: var(--primary-color); transition: color 0.2s ease; }
        a:hover { color: var(--primary-color-darker); text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5em; font-size: 0.9rem; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .text-muted { color: #6c757d; }
        .text-muted a { color: #6c757d; }
        .text-muted a:hover { color: #343a40; }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .chart-container { position: relative; height: 400px; margin-bottom: 2em; }
        .input-group { display: flex; align-items: center; }
        .input-group label { margin-right: 10px; font-size: 0.9rem; }
        .input-group input[type="number"] { width: 120px; }
        .input-group select { margin-left: 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
                  background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px;
                         bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #007bff; }
        input:focus + .slider { box-shadow: 0 0 1px #007bff; }
        input:checked + .slider:before { transform: translateX(26px); }
        /* Buttons */
        .button-primary, .button-secondary, .button-success, .button-danger, .button-warning { 
            padding: 6px 12px; border: 1px solid transparent; border-radius: 4px;
            font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center;
            background-color: var(--primary-color); color: var(--button-text);
        }
        .button-primary:hover { background-color: var(--primary-color-darker); border-color: var(--primary-color-darker); }
        .button-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: white; }
        .button-secondary:hover { background-color: var(--secondary-color-darker); border-color: var(--secondary-color-darker); }
        .button-success { background-color: var(--success-color); border-color: var(--success-color); color: white; }
        .button-success:hover { background-color: #218838; border-color: #1e7e34; }
        .button-danger { background-color: var(--danger-color); border-color: var(--danger-color); color: white; }
        .button-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .button-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: #212529; }
        .button-warning:hover { background-color: #e0a800; border-color: #d39e00; }
        button i { margin-right: 2px; /* Keep small margin */ }
        button:hover {
            background-color: var(--primary-color-darker);
            border-color: var(--primary-color-darker);
        }
        button:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem var(--input-focus-shadow);
        }
        button:disabled {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            cursor: not-allowed;
        }
        /* Section Tabs */
        .tabs { display: flex; list-style: none; padding: 0; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .tabs li { margin-right: 20px; }
        .tabs a {
            text-decoration: none;
            padding: 5px 10px;
            display: inline-block;
            color: var(--text-color);
            border: 2px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }
        .tabs a.active {
            font-weight: 600;
            border-color: #dee2e6;
            border-bottom-color: var(--bg-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* Card Styles */
        .card { border: 1px solid #ccc; border-radius: 4px; margin-bottom: 20px; }
        .card-header { background-color: #f8f9fa; padding: 10px; font-weight: 600; }
        .card-body { padding: 10px; }
        .card-body p { margin-bottom: 8px; }
        .card-footer { background-color: #f8f9fa; padding: 10px; text-align: right; }
        /* Tables adjustments for small screens */
        .responsive-table { overflow-x: auto; }
        /* Loader (when reading Excel) */
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 100px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Additional classes for text and spacing */
        .mt-2 { margin-top: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .tooltip-inner { max-width: none; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Proyección de Expensas</h1>
        <p>Proyecta las expensas del barrio para el año en curso y futuros.</p>
        <ul class="tabs">
            <li><a href="#" data-tab="dashboard" class="active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Resumen General</a></li>
            <li><a href="#" data-tab="file" onclick="switchTab('file')"><i class="fas fa-file-upload"></i> Cargar Archivo</a></li>
            <li><a href="#" data-tab="reserve" onclick="switchTab('reserve')"><i class="fas fa-piggy-bank"></i> Fondo de Reserva</a></li>
            <li><a href="#" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Configuración</a></li>
        </ul>
        <!-- ==================== DASHBOARD ==================== -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <div class="card-header">Expensas - Resumen Actual (<span class="current-year"></span>)</div>
                <div class="card-body">
                    <div id="main-summary">
                        <!-- Main summary content here -->
                    </div>
                    <hr>
                    <h3>Participación de Rubros en Gastos Totales</h3>
                    <div class="chart-container">
                        <canvas id="participacionGastosChart"></canvas>
                    </div>
                    <h3>Evolución de la Cuota Ordinaria (por UF)</h3>
                    <div class="chart-container">
                        <canvas id="evolutivoCuotaChart"></canvas>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 2em;">
                        <div style="flex: 1; min-width: 300px;">
                            <h4><i class="fas fa-arrow-down" style="color: var(--danger-color);"></i> Gastos Totales</h4>
                            <div class="responsive-table">
                                <table id="dashboard-gastos" class="dashboard-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 300px;">
                            <h4><i class="fas fa-arrow-up" style="color: var(--success-color);"></i> Ingresos Totales</h4>
                            <div class="responsive-table">
                                <table id="dashboard-ingresos" class="dashboard-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="button-secondary" onclick="downloadTableData()"><i class="fas fa-download"></i> Descargar Datos</button>
                </div>
            </div>
        </div>
        <!-- ==================== FILE UPLOAD ==================== -->
        <div id="file" class="tab-content">
            <h2><i class="fas fa-file-upload"></i> Cargar Archivo Excel</h2>
            <p>Sube tu archivo Excel con las hojas <strong>"Gastos"</strong> e <strong>"Ingresos"</strong>. Los rubros nuevos se añadirán automáticamente a la sección de Configuración.</p>
            <p><strong>Importante:</strong>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Las celdas con números en la hoja "Gastos" marcarán ese mes/detalle como 'REAL' (fondo verde claro en detalle).</li>
                    <!-- MODIFICADO -->
                    <li>Los rubros de Ingreso llamados "<strong id="cuota-rubro-name-info">Expensas Ordinarias</strong>" y "<strong>Expensas Extraordinarias</strong>" tendrán sus valores base multiplicados por la cantidad de UF (definida en Configuración) al calcular el *total* de ingresos en el Resumen General.</li>
                </ul>
            </p>
            <div id="file-upload-area" onclick="document.getElementById('excel-file-input').click()">
                 <p><i class="fas fa-file-excel"></i><br>Arrastra tu archivo Excel aquí (.xlsx, .xls) o haz clic para seleccionar</p>
                 <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(this.files)">
                 <button type="button" class="button-primary" onclick="event.stopPropagation(); document.getElementById('excel-file-input').click()" style="pointer-events: auto;"><i class="fas fa-folder-open"></i> Seleccionar Archivo</button>
                 <button type="button" onclick="event.stopPropagation(); loadSampleData()" style="margin-left: 10px; pointer-events: auto;" class="button-secondary"><i class="fas fa-database"></i> Cargar Datos Ejemplo</button>
            </div>
            <div id="file-upload-feedback"></div>
            <a href="#" onclick="event.preventDefault(); downloadTemplate();" title="Descargar archivo Excel con estructura de ejemplo"><i class="fas fa-download"></i> Descargar Plantilla Ejemplo</a>
        </div>
        <!-- ==================== RESERVE FUND ==================== -->
        <div id="reserve" class="tab-content">
             <h2><i class="fas fa-piggy-bank"></i> Configurar Fondo de Reserva - <span class="current-year"></span> (<span class="current-scenario">Base</span>)</h2>
             <div class="form-group">
                 <label>Método de Cálculo del Fondo:</label>
                 <div class="input-group">
                     <input type="radio" id="reserve-type-percent" name="reserve-type" value="percent" checked onchange="updateReserveUI()">
                     <label for="reserve-type-percent">Porcentaje (%) sobre Gastos Mensuales</label>
                     <input type="radio" id="reserve-type-fixed" name="reserve-type" value="fixed" onchange="updateReserveUI()">
                     <label for="reserve-type-fixed">Valor Fijo Mensual ($)</label>
                 </div>
             </div>
             <div id="reserve-fund-panel">
                 <!-- Inputs generados por JS -->
             </div>
             <button onclick="saveReserveFund()" style="margin-top: 25px;" class="button-success" title="Guardar los valores mensuales y el tipo de cálculo del fondo"><i class="fas fa-save"></i> Guardar Configuración del Fondo y Recalcular</button>
        </div>
        <!-- ==================== SETTINGS ==================== -->
        <div id="settings" class="tab-content">
             <h2><i class="fas fa-cog"></i> Configuración General y de Cálculo</h2>
             <div class="config-section">
                 <h4><i class="fas fa-building"></i> Ajustes Generales del Barrio</h4>
                 <div class="form-group">
                     <label for="cantidad-unidades">Cantidad Total de Unidades Funcionales (UF):</label>
                     <input type="number" id="cantidad-unidades" min="1" value="100" style="width: 180px;" title="Número total de UF para calcular cuotas base">
                 </div>
             </div>
             <div class="config-section">
                 <h4><i class="fas fa-list-alt"></i> Gestión de Rubros (Categorías)</h4>
                 <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                     <div style="flex: 1; min-width: 320px;">
                         <h5><i class="fas fa-arrow-down" style="color:var(--danger-color)"></i> Rubros de GASTOS</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-gasto-rubro-name" placeholder="Nombre nuevo rubro de gasto" style="flex-grow: 1;">
                             <button onclick="addRubro('gastos')" class="button-primary" title="Agregar nuevo rubro de gastos"><i class="fas fa-plus"></i> Agregar</button>
                         </div>
                         <div class="responsive-table">
                             <table id="gastos-rubros-table" class="table-config">
                                 <thead>
                                     <tr><th>Rubro</th><th>Acciones</th></tr>
                                 </thead>
                                 <tbody id="gastos-rubros-list"></tbody>
                             </table>
                         </div>
                     </div>
                     <div style="flex: 1; min-width: 320px;">
                         <h5><i class="fas fa-arrow-up" style="color:var(--success-color)"></i> Rubros de INGRESOS</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-ingreso-rubro-name" placeholder="Nombre nuevo rubro de ingreso" style="flex-grow: 1;">
                             <button onclick="addRubro('ingresos')" class="button-primary" title="Agregar nuevo rubro de ingresos"><i class="fas fa-plus"></i> Agregar</button>
                         </div>
                         <div class="responsive-table">
                             <table id="ingresos-rubros-table" class="table-config">
                                 <thead>
                                     <tr><th>Rubro</th><th>Acciones</th></tr>
                                 </thead>
                                 <tbody id="ingresos-rubros-list"></tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="config-section">
                 <h4><i class="fas fa-coins"></i> Ajustes de Coeficientes</h4>
                 <p class="text-muted">Define cómo se calculan ciertos rubros especiales en gastos (porcentaje sobre totales mensuales, etc.). Aplica globalmente.</p>
                 <div class="form-group">
                     <label for="coeficiente-reserva">Coeficiente de Fondo de Reserva (% de cada gasto mensual):</label>
                     <input type="number" id="coeficiente-reserva" min="0" max="100" value="0" style="width: 100px;">
                 </div>
                 <div class="form-group">
                     <label for="coeficiente-morosos">Coeficiente Morosidad (% de ingresos ordinarios no cobrados):</label>
                     <input type="number" id="coeficiente-morosos" min="0" max="100" value="0" style="width: 100px;">
                 </div>
             </div>
             <div class="config-section">
                 <h4><i class="fas fa-wrench"></i> Otras Opciones</h4>
                 <div class="form-group">
                     <label for="migrar-cache">Migrar caches locales a versión actual:</label>
                     <button onclick="migrateCache()" class="button-secondary" id="migrar-cache"><i class="fas fa-sync-alt"></i> Migrar</button>
                 </div>
                 <div class="form-group">
                     <label for="borrar-cache">Borrar almacenamiento local:</label>
                     <button onclick="clearLocalData()" class="button-secondary" id="borrar-cache"><i class="fas fa-trash"></i> Borrar</button>
                 </div>
             </div>
        </div>
    </div>
    
    <!-- ==================== SCRIPTS ==================== -->
    <script>
        // Variables de estado global
        const appState = {
            scenarios: {},        // Datos de escenarios
            activeScenarioKey: null,
            currentYear: null,
            settings: {
                rubros: { gastos: [], ingresos: [] },
                rubroConfig: {},  // Additional config for rubros if needed (e.g., coefficient type)
                coeficienteReserva: 0,
                coeficienteMorosos: 0
            },
            loadedFileName: null,   // Track loaded file name for feedback
            snackbar: null          // Placeholder for snackbar element
        };
    
        // Constantes de nombres de rubros especiales
        const CUOTA_RUBRO_NAME = "Expensas Ordinarias";
        const EXTRA_CUOTA_RUBRO_NAME = "Expensas Extraordinarias";
    
        // Estructuras iniciales para datos mensuales de un rubro en un escenario
        function initializeScenarioDataForRubros(scenarioData) {
            ['gastos','ingresos'].forEach(type => {
                scenarioData.data[type] = scenarioData.data[type] || {};
                scenarioData.monthStatus[type] = scenarioData.monthStatus[type] || {};
                scenarioData.rubroOrder[type] = scenarioData.rubroOrder[type] || [];
                // Ensure all rubros from global settings exist in local scenario data
                appState.settings.rubros[type].forEach(r => {
                    if (!scenarioData.data[type][r]) scenarioData.data[type][r] = { detailsData: {}, detailOrder: [] };
                    if (!scenarioData.monthStatus[type][r]) scenarioData.monthStatus[type][r] = {};
                    if (!scenarioData.rubroOrder[type].includes(r)) scenarioData.rubroOrder[type].push(r);
                });
            });
        }
    
        // Guardar estado en localStorage (simple serialización a JSON)
        function saveState() {
            localStorage.setItem('appState', JSON.stringify(appState));
        }
    
        // Cargar estado de localStorage (si existe)
        function loadState() {
            const state = localStorage.getItem('appState');
            if (state) {
                Object.assign(appState, JSON.parse(state));
            }
        }
    
        // Snackbar para mostrar mensajes temporales
        function showSnackbar(message, isError = false, type = 'info', duration = 3000) {
            let snackbar = appState.snackbar;
            if (!snackbar) {
                snackbar = document.createElement('div');
                snackbar.className = 'snackbar';
                document.body.appendChild(snackbar);
                appState.snackbar = snackbar;
            }
            snackbar.textContent = message;
            snackbar.className = 'snackbar show ' + (isError ? 'snackbar-error' : 'snackbar-' + type);
            setTimeout(() => {
                snackbar.className = snackbar.className.replace(' show', '');
            }, duration);
        }
    
        // Cambiar de pestaña
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.tabs a').forEach(tabLink => {
                tabLink.classList.remove('active');
            });
            document.querySelector(`.tabs a[data-tab="${tabId}"]`).classList.add('active');
        }
    
        // Manejar subida de archivo Excel
        function handleFileUpload(files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showSnackbar("Formato de archivo no soportado. Por favor, sube un archivo Excel (.xlsx o .xls).", true, 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    processWorkbook(workbook);
                    appState.loadedFileName = file.name;
                    showSnackbar("Archivo cargado exitosamente.", false, 'success');
                    document.getElementById('file-upload-feedback').innerHTML = `<p><strong>Archivo cargado:</strong> ${file.name}</p>`;
                    switchTab('dashboard');
                } catch (error) {
                    console.error("Error leyendo el archivo:", error);
                    showSnackbar("Error al leer el archivo. Asegúrate de que el archivo esté en formato Excel válido.", true, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
    
        // Procesar el libro de Excel cargado
        function processWorkbook(workbook) {
            const sheetNames = workbook.SheetNames;
            const requiredSheets = ['Gastos', 'Ingresos'];
            const missingSheets = requiredSheets.filter(sheet => !sheetNames.includes(sheet));
            if (missingSheets.length > 0) {
                showSnackbar("El archivo Excel no contiene las hojas requeridas: " + missingSheets.join(', ') + ".", true, 'error');
                return;
            }
            const gastosSheet = workbook.Sheets['Gastos'];
            const ingresosSheet = workbook.Sheets['Ingresos'];
            const gastosData = XLSX.utils.sheet_to_json(gastosSheet, { header: 1 });
            const ingresosData = XLSX.utils.sheet_to_json(ingresosSheet, { header: 1 });
            // Procesar datos de gastos e ingresos
            processDataFromSheets(gastosData, 'gastos');
            processDataFromSheets(ingresosData, 'ingresos');
            // Actualizar año actual y escenario activo
            appState.currentYear = new Date().getFullYear();
            initScenarioData(appState.currentYear); // Crea escenario "Base" por defecto si no existe
            // Actualizar UI después de cargar datos
            updateUI();
        }
    
        // Procesar datos de una hoja de Excel (gastos o ingresos)
        function processDataFromSheets(data, type) {
            const headers = data[0];
            const rubroColumnIndex = headers.indexOf('Rubro');
            const detailColumnIndex = headers.indexOf('Detalle');
            if (rubroColumnIndex === -1 || detailColumnIndex === -1) {
                showSnackbar("Formato de hoja " + type + " no válido. Asegúrate de incluir columnas 'Rubro' y 'Detalle'.", true, 'error');
                return;
            }
            // Asegurarse de que los rubros existen globalmente
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                const rubroName = row[rubroColumnIndex] ? row[rubroColumnIndex].toString().trim() : "";
                if (rubroName && !appState.settings.rubros[type].includes(rubroName)) {
                    appState.settings.rubros[type].push(rubroName);
                }
            }
            // Asegurarse de que los rubros existen localmente
            if (!appState.scenarios[appState.currentYear]) {
                appState.scenarios[appState.currentYear] = { data: { gastos: {}, ingresos: {} }, monthStatus: { gastos: {}, ingresos: {} }, rubroOrder: { gastos: [], ingresos: [] } };
            }
            const scenarioData = appState.scenarios[appState.currentYear];
            initializeScenarioDataForRubros(scenarioData);
            // Recorrer filas de datos (saltando la fila de encabezados)
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                const rubroName = row[rubroColumnIndex] ? row[rubroColumnIndex].toString().trim() : "";
                const detailName = row[detailColumnIndex] ? row[detailColumnIndex].toString().trim() : "";
                if (!rubroName || !detailName) continue;
                // Asegurarse de que el rubro y detalle existen en la estructura
                if (!scenarioData.data[type][rubroName]) {
                    scenarioData.data[type][rubroName] = { detailsData: {}, detailOrder: [] };
                }
                if (!scenarioData.data[type][rubroName].detailsData[detailName]) {
                    scenarioData.data[type][rubroName].detailsData[detailName] = Array(12).fill(0);
                    scenarioData.data[type][rubroName].detailOrder.push(detailName);
                }
                // Rellenar datos mensuales si hay suficientes columnas
                for (let j = detailColumnIndex + 1; j < row.length && j < detailColumnIndex + 13; j++) {
                    const monthIndex = j - (detailColumnIndex + 1);
                    const cellValue = row[j] || 0;
                    // Convertir a número si es posible
                    const value = typeof cellValue === 'string' ? parseFloat(cellValue.replace(',', '.')) : cellValue;
                    scenarioData.data[type][rubroName].detailsData[detailName][monthIndex] = isNaN(value) ? 0 : value;
                    // Estado 'REAL' si hay valor numérico, 'Estimado' si está vacío
                    if (!scenarioData.monthStatus[type][rubroName][detailName]) {
                        scenarioData.monthStatus[type][rubroName][detailName] = Array(12).fill('Estimado');
                    }
                    if (row[j] !== null && row[j] !== "" && !isNaN(value)) {
                        scenarioData.monthStatus[type][rubroName][detailName][monthIndex] = 'REAL';
                    }
                }
            }
        }
    
        // Inicializar datos de escenario para un nuevo año o establecer escenario activo existente
        function initScenarioData(year, nombreEscenario = "Base") {
            const key = year.toString() + "-" + nombreEscenario;
            if (!appState.scenarios[key]) {
                appState.scenarios[key] = { data: { gastos: {}, ingresos: {} }, monthStatus: { gastos: {}, ingresos: {} }, rubroOrder: { gastos: [], ingresos: [] } };
                appState.settings.rubros.gastos.forEach(r => {
                    appState.scenarios[key].data.gastos[r] = { detailsData: {}, detailOrder: [] };
                    appState.scenarios[key].monthStatus.gastos[r] = {};
                    appState.scenarios[key].rubroOrder.gastos.push(r);
                });
                appState.settings.rubros.ingresos.forEach(r => {
                    appState.scenarios[key].data.ingresos[r] = { detailsData: {}, detailOrder: [] };
                    appState.scenarios[key].monthStatus.ingresos[r] = {};
                    appState.scenarios[key].rubroOrder.ingresos.push(r);
                });
            }
            appState.activeScenarioKey = key;
        }
    
        // Actualizar la interfaz de usuario (UI) basándose en el estado actual
        function updateUI() {
            // Comprobar año actual y escenario activo
            if (!appState.activeScenarioKey) {
                console.log("No hay escenario activo. Nada que actualizar.");
                return;
            }
            const [year, scenarioName] = appState.activeScenarioKey.split("-");
            document.querySelectorAll('.current-year').forEach(el => el.textContent = year);
            document.querySelectorAll('.current-scenario').forEach(el => el.textContent = scenarioName);
            // Actualizar tablas y gráficos del dashboard
            updateDashboard();
        }
    
        // Actualizar datos del Dashboard (tablas y gráficos)
        function updateDashboard() {
            const scenarioData = getCurrentScenarioData(); // Obtener datos del escenario activo
            if (!scenarioData) {
                console.error("updateDashboard: No hay escenario activo o datos disponibles. Renderizando estado vacío.");
                renderEmptyState(); // Mostrar estado vacío si no hay datos
                updateCurrentYearAndScenarioInUI(); // Aún actualizar display de año/escenario (podría mostrar 'Ninguno')
                return;
            }
            // Actualizar tablas de resumen (gastos e ingresos)
            updateDashboardTables(scenarioData);
            // Actualizar gráficos
            updateCharts(scenarioData);
        }
    
        // Obtener datos del escenario activo actual
        function getCurrentScenarioData() {
            return appState.scenarios[appState.activeScenarioKey];
        }
    
        // Actualizar tablas de resumen en el Dashboard
        function updateDashboardTables(scenarioData) {
            const gastosTable = document.getElementById('dashboard-gastos');
            const ingresosTable = document.getElementById('dashboard-ingresos');
            const gastosTbody = gastosTable.querySelector('tbody');
            const ingresosTbody = ingresosTable.querySelector('tbody');
    
            // Limpiar tablas
            gastosTbody.innerHTML = '';
            ingresosTbody.innerHTML = '';
    
            // Totales anuales
            const annualTotals = { gastos: 0, ingresos: 0 };
    
            // Llenar tabla de gastos
            Object.keys(scenarioData.data.gastos).forEach(rubro => {
                let rubroTotal = 0;
                const tr = document.createElement('tr');
                const tdRubro = document.createElement('td');
                tdRubro.textContent = rubro;
                tr.appendChild(tdRubro);
                scenarioData.rubroOrder.gastos.forEach(r => {
                    if (r === rubro) {
                        // Sumar total anual de ese rubro
                        Object.values(scenarioData.data.gastos[rubro].detailsData).forEach(months => {
                            rubroTotal += months.reduce((a, b) => a + b, 0);
                        });
                        const tdTotal = document.createElement('td');
                        tdTotal.textContent = rubroTotal.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
                        tr.appendChild(tdTotal);
                        gastosTbody.appendChild(tr);
                        annualTotals.gastos += rubroTotal;
                    }
                });
            });
    
            // Llenar tabla de ingresos
            Object.keys(scenarioData.data.ingresos).forEach(rubro => {
                let rubroTotal = 0;
                const tr = document.createElement('tr');
                const tdRubro = document.createElement('td');
                tdRubro.textContent = rubro;
                tr.appendChild(tdRubro);
                scenarioData.rubroOrder.ingresos.forEach(r => {
                    if (r === rubro) {
                        // Sumar total anual de ese rubro
                        Object.values(scenarioData.data.ingresos[rubro].detailsData).forEach(months => {
                            rubroTotal += months.reduce((a, b) => a + b, 0);
                        });
                        const tdTotal = document.createElement('td');
                        tdTotal.textContent = rubroTotal.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
                        tr.appendChild(tdTotal);
                        ingresosTbody.appendChild(tr);
                        annualTotals.ingresos += rubroTotal;
                    }
                });
            });
    
            // Añadir fila de totales
            const gastosTotalTr = document.createElement('tr');
            const ingresosTotalTr = document.createElement('tr');
            gastosTotalTr.innerHTML = `<td><strong>Total Gastos</strong></td><td><strong>${annualTotals.gastos.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 })}</strong></td>`;
            ingresosTotalTr.innerHTML = `<td><strong>Total Ingresos</strong></td><td><strong>${annualTotals.ingresos.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 })}</strong></td>`;
            gastosTbody.appendChild(gastosTotalTr);
            ingresosTbody.appendChild(ingresosTotalTr);
        }
    
        // Actualizar gráficos del Dashboard
        function updateCharts(scenarioData) {
            // Chart de Participación de Gastos
            const participacionCtx = document.getElementById('participacionGastosChart').getContext('2d');
            destroyChart('participacionGastosChart');
            const gastosLabels = scenarioData.rubroOrder.gastos;
            const gastosData = gastosLabels.map(rubro => {
                let total = 0;
                Object.values(scenarioData.data.gastos[rubro].detailsData).forEach(months => {
                    total += months.reduce((a, b) => a + b, 0);
                });
                return total;
            });
            displayChartNoData('participacionGastosChart', gastosData.length === 0 || gastosData.every(val => val === 0));
            if (gastosData.length > 0 && !gastosData.every(val => val === 0)) {
                new Chart(participacionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: gastosLabels,
                        datasets: [{
                            data: gastosData,
                            backgroundColor: ['#007bff', '#6610f2', '#6f42c1', '#e83e8c', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997', '#17a2b8'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            doughnutShadow3D: {}
                        }
                    }
                });
            }
    
            // Chart de Evolución de la Cuota (por UF)
            const evolutivoCtx = document.getElementById('evolutivoCuotaChart').getContext('2d');
            destroyChart('evolutivoCuotaChart');
            const cuotaData = scenarioData.data.ingresos[CUOTA_RUBRO_NAME]?.detailsData?.['Cuota por UF'] || [];
            const cuotaLabels = Array.from({ length: cuotaData.length }, (_, i) => `Mes ${i+1}`);
            displayChartNoData('evolutivoCuotaChart', cuotaData.length === 0 || cuotaData.every(val => val === 0));
            if (cuotaData.length > 0 && !cuotaData.every(val => val === 0)) {
                new Chart(evolutivoCtx, {
                    type: 'line',
                    data: {
                        labels: cuotaLabels,
                        datasets: [{
                            label: 'Cuota Ordinaria (por UF)',
                            data: cuotaData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    
        // Mostrar mensaje "Sin datos" en un canvas de gráfico
        function displayChartNoData(canvasId, shouldDisplay) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const parent = canvas.parentElement;
            let noDataDiv = parent.querySelector('.no-data');
            if (shouldDisplay) {
                if (!noDataDiv) {
                    noDataDiv = document.createElement('div');
                    noDataDiv.className = 'no-data';
                    noDataDiv.textContent = 'Sin datos para mostrar';
                    noDataDiv.style.textAlign = 'center';
                    noDataDiv.style.paddingTop = '50px';
                    parent.appendChild(noDataDiv);
                }
                canvas.style.display = 'none';
            } else {
                if (noDataDiv) {
                    noDataDiv.remove();
                }
                canvas.style.display = 'block';
            }
        }
    
        // Destruir un gráfico existente para evitar superposición
        function destroyChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas && canvas.chartInstance) {
                canvas.chartInstance.destroy();
                canvas.chartInstance = null;
            }
        }
    
        // Obtener el año actual (helper)
        function getCurrentYear() {
            return new Date().getFullYear();
        }
    
        // Actualizar displays de año y nombre de escenario en UI (por si cambian)
        function updateCurrentYearAndScenarioInUI() {
            if (!appState.activeScenarioKey) return;
            const [year, scenarioName] = appState.activeScenarioKey.split("-");
            document.querySelectorAll('.current-year').forEach(el => el.textContent = year);
            document.querySelectorAll('.current-scenario').forEach(el => el.textContent = scenarioName);
        }
    
        // Cambiar escenario activo
        function changeScenario(newKey) {
            if (!appState.scenarios[newKey]) {
                console.error(`Intento de cambiar a escenario inválido o no encontrado: ${newKey}`);
                return;
            }
            appState.activeScenarioKey = newKey;
            updateUI();
        }
    
        // Crear nuevo escenario (nuevo año, por ejemplo)
        function createNewScenario() {
            const year = getCurrentYear();
            let nombre = prompt("Ingrese el nombre para el nuevo escenario:");
            if (!nombre) {
                showSnackbar("Creación de escenario cancelada o nombre inválido.", true, 'error');
                return;
            }
            const key = year.toString() + "-" + nombre;
            if (appState.scenarios[key]) {
                showSnackbar("Ya existe un escenario con ese nombre para el año actual. Por favor elige otro nombre.", true, 'error');
                return;
            }
            // Clonar datos base
            const baseKey = year.toString() + "-Base";
            const baseScenario = appState.scenarios[baseKey];
            if (!baseScenario) {
                showSnackbar("Escenario base no encontrado. Operación cancelada.", true, 'error');
                return;
            }
            appState.scenarios[key] = JSON.parse(JSON.stringify(baseScenario));
            appState.activeScenarioKey = key;
            showSnackbar("Nuevo escenario creado y activado: " + nombre, false, 'success');
            updateUI();
        }
    
        // Eliminar escenario actual (excepto base)
        function deleteCurrentScenario() {
            const [year, scenarioName] = appState.activeScenarioKey.split("-");
            if (scenarioName === "Base") {
                showSnackbar("No se puede eliminar el escenario base.", true, 'error');
                return;
            }
            if (!confirm("¿Seguro que deseas eliminar el escenario actual? Esta acción no se puede deshacer.")) {
                return;
            }
            delete appState.scenarios[appState.activeScenarioKey];
            appState.activeScenarioKey = year.toString() + "-Base";
            showSnackbar("Escenario eliminado. Se ha vuelto al escenario base.", false, 'success');
            updateUI();
        }
    
        // Cargar datos de ejemplo (escenario base)
        function loadSampleData() {
            console.log("Cargando datos de ejemplo...");
            const scenarioData = getCurrentScenarioData();
            if (!scenarioData) { showSnackbar("No hay escenario activo. Crea o selecciona un año.", true, 'error'); return; }
    
            // Reset current scenario data
            scenarioData.data = { gastos: {}, ingresos: {} };
            scenarioData.monthStatus = { gastos: {}, ingresos: {} };
            scenarioData.rubroOrder = { gastos: [], ingresos: [] };
            // Calculated reset happens in calculateAll
    
            const sampleGastosRubros = ["Seguridad", "Jardinería", "Mantenimiento", "Administración", "Servicios Públicos"];
            // --- MODIFICADO: Usar constante ---
            const sampleIngresosRubros = [CUOTA_RUBRO_NAME, "Alquiler SUM", "Ingresos Extra", EXTRA_CUOTA_RUBRO_NAME];
            let settingsChanged = false;
    
            // Ensure sample rubros exist globally and locally
            sampleGastosRubros.forEach(r => {
                if (!appState.settings.rubros.gastos.includes(r)) { appState.settings.rubros.gastos.push(r); settingsChanged = true; }
                if (!appState.settings.rubroConfig[r]) appState.settings.rubroConfig[r] = { coefficientType: 'None', detailsCollapsed: true };
                if (!scenarioData.rubroOrder.gastos.includes(r)) scenarioData.rubroOrder.gastos.push(r);
            });
            sampleIngresosRubros.forEach(r => {
                 if (!appState.settings.rubros.ingresos.includes(r)) { appState.settings.rubros.ingresos.push(r); settingsChanged = true; }
                 if (!scenarioData.rubroOrder.ingresos.includes(r)) scenarioData.rubroOrder.ingresos.push(r);
            });
    
            // Initialize structures in the current scenario for these rubros AND ensure others are initialized
            initializeScenarioDataForRubros(scenarioData);
            if (settingsChanged) {
                // Re-initialize all scenarios if global settings changed
                Object.values(appState.scenarios).forEach(scen => initializeScenarioDataForRubros(scen));
                saveState(); // Save settings early if they changed
            }
    
            // --- Gastos Data & Status ---
            scenarioData.data.gastos["Seguridad"].detailOrder = ["Vigilador Dia", "Vigilador Noche", "Monitoreo Cámaras"];
            scenarioData.data.gastos["Seguridad"].detailsData = {
                "Vigilador Dia":   [50000, 50500, 51000, 51500, 52000, 52500, 53000, 53500, 54000, 54500, 55000, 55500],
                "Vigilador Noche": [55000, 55500, 56000, 56500, 57000, 57500, 58000, 58500, 59000, 59500, 60000, 60500],
                "Monitoreo Cámaras": Array(12).fill(10000)
            };
            scenarioData.monthStatus.gastos["Seguridad"] = {
                "Vigilador Dia":   ['REAL','REAL','REAL','REAL',   'Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Vigilador Noche": ['REAL','REAL','REAL','REAL',   'Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Monitoreo Cámaras": ['REAL','REAL','REAL','REAL', 'Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'] // Example: Real first 4 months
            };
            scenarioData.data.gastos["Jardinería"].detailOrder = ["Mantenimiento Parque", "Reposición Plantas"];
            scenarioData.data.gastos["Jardinería"].detailsData = {
                "Mantenimiento Parque": [30000, 30000, 30500, 30500, 31000, 31000, 31500, 31500, 32000, 32000, 32500, 32500],
                "Reposición Plantas":   [0,     0,     5000,  0,     0,     0,     0,     0,     6000,  0,     0,     0]
            };
            scenarioData.monthStatus.gastos["Jardinería"] = {
                "Mantenimiento Parque": ['REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Reposición Plantas":   ['REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','REAL','Estimado','Estimado','Estimado']
            };
            scenarioData.data.gastos["Mantenimiento"].detailOrder = ["Bomba Agua Pozo", "Limpieza Tanques", "Pintura General"];
            scenarioData.data.gastos["Mantenimiento"].detailsData = {
                "Bomba Agua Pozo":  [0,     12000, 0,     0,     0,     0,     0,     13500, 0,     0,     0,     0],
                "Limpieza Tanques": [0,     0,     0,     15000, 0,     0,     0,     0,     0,     15000, 0,     0],
                "Pintura General":  [0,     0,     0,     0,     0,     0,     0,     0,     45000, 0,     0,     0]
            };
            scenarioData.monthStatus.gastos["Mantenimiento"] = {
                "Bomba Agua Pozo":  ['REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','REAL','Estimado','Estimado','Estimado','Estimado'],
                "Limpieza Tanques": ['REAL','REAL','Estimado','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','REAL','Estimado','Estimado'],
                "Pintura General":  ['REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','REAL','Estimado','Estimado','Estimado']
            };
            scenarioData.data.gastos["Administración"].detailOrder = ["Honorarios", "Papelería"];
            scenarioData.data.gastos["Administración"].detailsData = {
                "Honorarios": [20000, 20000, 20000, 20000, 22000, 22000, 22000, 22000, 24000, 24000, 24000, 24000],
                "Papelería":  [500,   500,   500,   500,   500,   500,   500,   500,   500,   500,   500,   500]
            };
            scenarioData.monthStatus.gastos["Administración"] = {
                "Honorarios": ['REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Papelería":  ['REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado']
            };
            scenarioData.data.gastos["Servicios Públicos"].detailOrder = ["Electricidad", "Agua", "Gas"];
            scenarioData.data.gastos["Servicios Públicos"].detailsData = {
                "Electricidad": [10000, 11000, 12000, 13000, 14000, 15000, 16000, 17000, 18000, 19000, 20000, 21000],
                "Agua":         [3000,  3200,  3400,  3600,  3800,  4000,  4200,  4400,  4600,  4800,  5000,  5200],
                "Gas":          [2000,  2100,  2200,  2300,  2400,  2500,  2600,  2700,  2800,  2900,  3000,  3100]
            };
            scenarioData.monthStatus.gastos["Servicios Públicos"] = {
                "Electricidad": ['REAL','REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Agua":         ['REAL','REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado'],
                "Gas":          ['REAL','REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado']
            };
    
            // --- Ingresos Data & Status ---
            scenarioData.data.ingresos[CUOTA_RUBRO_NAME].detailOrder = ["Cuota por UF"];
            scenarioData.data.ingresos[CUOTA_RUBRO_NAME].detailsData = {
                "Cuota por UF": [5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000, 5000] // $5000 per UF every month
            };
            scenarioData.monthStatus.ingresos[CUOTA_RUBRO_NAME] = {
                "Cuota por UF": ['REAL','REAL','REAL','REAL','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado','Estimado']
            };
            scenarioData.data.ingresos["Alquiler SUM"].detailOrder = ["Cuota por SUM"];
            scenarioData.data.ingresos["Alquiler SUM"].detailsData = {
                "Cuota por SUM": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] // no actual data by default
            };
            scenarioData.monthStatus.ingresos["Alquiler SUM"] = {
                "Cuota por SUM": Array(12).fill('Estimado')
            };
            scenarioData.data.ingresos["Ingresos Extra"].detailOrder = ["Extra 1", "Extra 2"];
            scenarioData.data.ingresos["Ingresos Extra"].detailsData = {
                "Extra 1": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                "Extra 2": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            };
            scenarioData.monthStatus.ingresos["Ingresos Extra"] = {
                "Extra 1": Array(12).fill('Estimado'),
                "Extra 2": Array(12).fill('Estimado')
            };
            scenarioData.data.ingresos[EXTRA_CUOTA_RUBRO_NAME].detailOrder = ["Extraordinaria 1", "Extraordinaria 2"];
            scenarioData.data.ingresos[EXTRA_CUOTA_RUBRO_NAME].detailsData = {
                "Extraordinaria 1": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                "Extraordinaria 2": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            };
            scenarioData.monthStatus.ingresos[EXTRA_CUOTA_RUBRO_NAME] = {
                "Extraordinaria 1": Array(12).fill('Estimado'),
                "Extraordinaria 2": Array(12).fill('Estimado')
            };
    
            // Marcar cambios de configuración y recalcular todo
            console.log("Datos de ejemplo cargados. Ahora recalculando todo...");
            showSnackbar("Meses estimados recalculados (acum.). Actualizando dashboard...", false, 'info', 4000);
            calculateAll(scenarioData); // Recalculate everything after loading sample data
            console.log("UI Actualizada.");
        }
    
        // Calcular todos los totales y acumulaciones necesarias tras cambios
        function calculateAll(scenarioData) {
            // Por ahora, simplemente recalcular totales anuales (pues los mensuales ya se calculan on-the-fly)
            scenarioData.annualTotals = {
                gastos: {},
                ingresos: {}
            };
            // Totales anuales por rubro
            Object.keys(scenarioData.data.gastos).forEach(rubro => {
                scenarioData.annualTotals.gastos[rubro] = 0;
                Object.values(scenarioData.data.gastos[rubro].detailsData).forEach(months => {
                    scenarioData.annualTotals.gastos[rubro] += months.reduce((a, b) => a + b, 0);
                });
            });
            Object.keys(scenarioData.data.ingresos).forEach(rubro => {
                scenarioData.annualTotals.ingresos[rubro] = 0;
                Object.values(scenarioData.data.ingresos[rubro].detailsData).forEach(months => {
                    scenarioData.annualTotals.ingresos[rubro] += months.reduce((a, b) => a + b, 0);
                });
            });
            // Actualizar UI tras recalcular
            updateUI();
        }
    
        // Guardar fondo de reserva
        function saveReserveFund() {
            const scenarioData = getCurrentScenarioData();
            if (!scenarioData) return;
            // Los valores se asumen actualizados en la UI a scenarioData (por el binding)
            showSnackbar("Configuración del fondo de reserva guardada.", false, 'success');
            calculateAll(scenarioData);
        }
    
        // Actualizar UI de reserva cuando se cambia el tipo (radio buttons)
        function updateReserveUI() {
            const percentOption = document.getElementById('reserve-type-percent');
            const panel = document.getElementById('reserve-fund-panel');
            panel.innerHTML = '';
            if (percentOption.checked) {
                // Mostrar coeficiente de reserva
                const label = document.createElement('label');
                label.textContent = 'Porcentaje de cada gasto mensual que se destina al Fondo de Reserva:';
                const input = document.createElement('input');
                input.type = 'number';
                input.id = 'coeficiente-reserva-input';
                input.min = 0;
                input.max = 100;
                input.value = appState.settings.coeficienteReserva;
                input.style.width = '100px';
                input.onchange = () => {
                    appState.settings.coeficienteReserva = parseFloat(input.value) || 0;
                };
                panel.appendChild(label);
                panel.appendChild(document.createElement('br'));
                panel.appendChild(input);
            } else {
                // Mostrar valor fijo de reserva por mes
                const label = document.createElement('label');
                label.textContent = 'Valor fijo mensual para el Fondo de Reserva:';
                const input = document.createElement('input');
                input.type = 'number';
                input.id = 'valor-fijo-reserva-input';
                input.min = 0;
                input.value = appState.settings.valorFijoReserva || 0;
                input.style.width = '100px';
                input.onchange = () => {
                    appState.settings.valorFijoReserva = parseFloat(input.value) || 0;
                };
                panel.appendChild(label);
                panel.appendChild(document.createElement('br'));
                panel.appendChild(input);
            }
        }
    
        // Migrar caché local a la nueva versión
        function migrateCache() {
            const oldState = localStorage.getItem('appState');
            if (oldState) {
                try {
                    const parsedState = JSON.parse(oldState);
                    if (parsedState && parsedState.scenarios) {
                        // Actualizar estructura si es necesario
                        // (Esto depende de cambios en la estructura de appState en nuevas versiones)
                        console.log("Migrando datos de estado a la nueva versión...");
                        appState.scenarios = parsedState.scenarios;
                        appState.activeScenarioKey = parsedState.activeScenarioKey;
                        appState.currentYear = parsedState.currentYear;
                        appState.settings = parsedState.settings || appState.settings;
                        // Asegurarse de que todos los escenarios tengan estructuras completas
                        Object.values(appState.scenarios).forEach(scen => {
                            initializeScenarioDataForRubros(scen);
                        });
                        // Migración específica: Si no existe rubroConfig para algún rubro, inicializarlo
                        appState.settings.rubros.gastos.forEach(r => {
                            if (!appState.settings.rubroConfig[r]) appState.settings.rubroConfig[r] = { coefficientType: 'None', detailsCollapsed: true };
                        });
                        console.log("Migración completa.");
                        showSnackbar("Datos locales migrados a la nueva versión.", false, 'success');
                        updateUI();
                    }
                } catch (e) {
                    console.error("Error al migrar datos:", e);
                    showSnackbar("Error al migrar datos del caché antiguo.", true, 'error');
                }
            } else {
                showSnackbar("No hay datos antiguos para migrar.", false, 'info');
            }
        }
    
        // Borrar todos los datos locales (reset)
        function clearLocalData() {
            if (confirm("¿Estás seguro de que deseas borrar todos los datos locales?")) {
                localStorage.removeItem('appState');
                location.reload();
            }
        }
    
        // Inicializar aplicación al cargar la página
        window.onload = function() {
            loadState();
            const currentYear = new Date().getFullYear();
            // Inicializar escenario base para el año actual si no existe
            initScenarioData(currentYear);
            appState.currentYear = currentYear;
            updateUI();
        };
    
        // Atajos de teclado (por ejemplo, para desarrollo rápido)
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                saveState();
                showSnackbar("Estado guardado (Ctrl+S).", false, 'info');
            }
            if (event.ctrlKey && event.key === 'l') {
                event.preventDefault();
                localStorage.clear();
                showSnackbar("Almacenamiento local borrado (Ctrl+L).", false, 'warning');
            }
            if (event.ctrlKey && event.key === 'm') {
                event.preventDefault();
                migrateCache();
            }
        });
    
        // Tooltips (ejemplo de uso de bootstrap tooltips)
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
    
    <!-- Librería Bootstrap (solo para tooltips en este caso, si es necesario) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js plugin for better legends (example, might not be needed) -->
    <script>
        // Example plugin for Chart.js (if needed for legends, etc.)
        const legendTweaks_v3 = {
            id: 'legendTweaks_v3',
            afterUpdate(chart) {
                // Example: modify legend behavior
            }
        };
        if (window.Chart) {
          Chart.register(legendTweaks_v3);
        }
    </script>
</body>
</html>
