<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
<link rel="icon" type="image/png" href="favicon.png">
    <title>Proyección Expensas - Barrio El Centauro</title>
    <!-- Librería SheetJS (js-xlsx) para leer/escribir Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Librería Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plugin doughnut 3D shadow -->
<script>
/* Plugin: doughnutShadow3D
   Añade una sombra suave debajo de cada porción para simular profundidad 3 D.
   Seguro para todos los datasets (evita NaN en createRadialGradient). */
const doughnutShadow3D = {
  id: 'doughnutShadow3D',
  afterDatasetDraw(chart, args, opts) {
    const {ctx} = chart;
    if (args.meta.type !== 'doughnut') return;

    args.meta.data.forEach(segment => {
      const {x, y, startAngle, endAngle, innerRadius, outerRadius} = segment;
      if (!isFinite(x) || !isFinite(y) || !isFinite(innerRadius) || !isFinite(outerRadius)) return;

      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.15)';      // shadow color
      ctx.translate(0, 4);                     // vertical offset
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.arc(x, y, outerRadius, startAngle, endAngle);
      ctx.arc(x, y, innerRadius, endAngle, startAngle, true);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    });
  }
};
// Registrar plugin globalmente
if (window.Chart && !Chart.registry.plugins.get('doughnutShadow3D')) {
  Chart.register(doughnutShadow3D);
}
</script>

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Reset Básico y Fuentes --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; /* Base font size */ }
        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            line-height: 1.7; /* Improved readability */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Variables de Color (Paleta Refinada) --- */
        :root {
            --bg-color: #f8f9fa;              /* Slightly off-white */
            --text-color: #343a40;            /* Darker gray */
            --primary-color: #007bff;          /* Classic blue */
            --primary-color-darker: #0056b3;   /* Darker blue for hover */
            --secondary-color: #6c757d;        /* Standard gray */
            --secondary-color-darker: #5a6268; /* Darker gray for hover */
            --accent-color: #28a745;           /* Vibrant green */
            --accent-color-darker: #218838;    /* Darker green for hover */
            --danger-color: #dc3545;           /* Red */
            --danger-color-darker: #c82333;    /* Darker red */
            --warning-color: #ffc107;           /* Yellow */
            --warning-color-darker: #e0a800;   /* Darker yellow */
            --info-color: #17a2b8;             /* Teal */
            --info-color-darker: #138496;      /* Darker teal */
            --success-color: var(--accent-color); /* Alias for consistency */
            --success-color-darker: var(--accent-color-darker); /* Alias */

            --border-color: #dee2e6;           /* Light gray border */
            --header-bg: #ffffff;              /* White header */
            --card-bg: #ffffff;                /* White cards */
            --shadow-color: rgba(0, 0, 0, 0.08); /* Softer shadow */
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-focus-border: var(--primary-color);
            --input-focus-shadow: rgba(0, 123, 255, 0.25);
            --button-text: #ffffff;
            --button-warning-text: #212529; /* Dark text for yellow button */
            --table-header-bg: #eef2f7;        /* Lighter table header */
            --table-row-hover: #f1f3f5;        /* Subtle hover */
            --expandable-row-bg: #f8f9fa;      /* Same as body bg for subtle diff */
            --clickable-row-hover: #e9ecef;    /* Slightly darker hover for clickable rows */
            --disabled-bg: #e9ecef;
            --disabled-text: #6c757d;
            --disabled-border: #ced4da;

            /* >>> COLORES REAL/ESTIMADO <<< */
            --real-month-bg: #d1f7d9; /* Light, fresh green */
            --estimated-month-bg: #fff3cd; /* Soft Yellow */
             --estimated-month-border: #ffda6a; /* Yellow border for input */
        }

        body.dark-mode {
            --bg-color: #1a1a1a;              /* Very dark gray */
            --text-color: #e0e0e0;            /* Light gray text */
            --primary-color: #58a6ff;          /* Brighter blue */
            --primary-color-darker: #79b8ff;   /* Lighter blue for hover */
            --secondary-color: #8b949e;        /* Lighter gray */
            --secondary-color-darker: #a0a8b0; /* Lighter gray hover */
            --accent-color: #56d364;           /* Brighter green */
            --accent-color-darker: #6bde7a;    /* Lighter green hover */
            --danger-color: #f85149;           /* Bright red */
            --danger-color-darker: #fa6a61;    /* Lighter red */
            --warning-color: #f0b41e;          /* Bright yellow */
            --warning-color-darker: #f2c037;   /* Lighter yellow */
            --info-color: #6cb6f1;             /* Bright teal */
            --info-color-darker: #85c3f4;      /* Lighter teal */
            --success-color: var(--accent-color);
            --success-color-darker: var(--accent-color-darker);

            --border-color: #444c56;           /* Darker border */
            --header-bg: #2c2c2c;              /* Dark card background */
            --card-bg: #2c2c2c;                /* Dark card background */
            --shadow-color: rgba(255, 255, 255, 0.05); /* Subtle white shadow */
            --input-bg: #3a3f44;
            --input-border: #5a6268;
            --input-focus-border: var(--primary-color);
            --input-focus-shadow: rgba(88, 166, 255, 0.25);
            --button-text: #1a1a1a; /* Dark text on bright buttons */
            --button-warning-text: #1a1a1a;
            --table-header-bg: #343a40;        /* Darker header */
            --table-row-hover: #3e444a;        /* Subtle dark hover */
            --expandable-row-bg: #343a40;      /* Darker expandable row bg */
            --clickable-row-hover: #495057;    /* Darker hover for clickable */
            --disabled-bg: #495057;
            --disabled-text: #adb5bd;
            --disabled-border: #5a6268;

            /* >>> COLORES REAL/ESTIMADO OSCURO <<< */
            --real-month-bg: #1c4a2b; /* Darker Green */
            --estimated-month-bg: #5a4a1d; /* Dark Yellow/Brown */
            --estimated-month-border: #f0b41e; /* Brighter Yellow border for input */
        }

        /* --- Estilos Generales --- */
        .container { width: 95%; max-width: 1700px; margin: 0 auto; padding: 25px 20px; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 1em; font-weight: 600; }
        h1 { font-size: 2.2rem; text-align: center; }
        h2 { font-size: 1.8rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 0.4em; }
        h3 { font-size: 1.4rem; margin-top: 1.8em; }
        h4 { font-size: 1.15rem; color: var(--secondary-color); margin-top: 1.2em; margin-bottom: 0.6em; }
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: var(--primary-color-darker); text-decoration: underline; }

        button {
            padding: 12px 22px;
            border: 1px solid transparent; /* Added border for consistency */
            border-radius: 6px;
            background-color: var(--primary-color);
            color: var(--button-text);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.5; /* Ensure consistent height */
            text-align: center; /* Ensure text aligns center */
        }
        button:hover {
            background-color: var(--primary-color-darker);
            border-color: var(--primary-color-darker);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem var(--input-focus-shadow);
        }
        button:disabled {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            border-color: var(--disabled-border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button i { margin-right: 2px; /* Keep small margin */ }

        /* Button variants */
        .button-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--button-text); }
        .button-primary:hover { background-color: var(--primary-color-darker); border-color: var(--primary-color-darker); }
        .button-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: var(--button-text); }
        .button-secondary:hover { background-color: var(--secondary-color-darker); border-color: var(--secondary-color-darker); }
        .button-success { background-color: var(--success-color); border-color: var(--success-color); color: var(--button-text); }
        .button-success:hover { background-color: var(--success-color-darker); border-color: var(--success-color-darker); }
        .button-danger { background-color: var(--danger-color); border-color: var(--danger-color); color: var(--button-text); }
        .button-danger:hover { background-color: var(--danger-color-darker); border-color: var(--danger-color-darker); }
        .button-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--button-warning-text); }
        .button-warning:hover { background-color: var(--warning-color-darker); border-color: var(--warning-color-darker); }
        .button-info { background-color: var(--info-color); border-color: var(--info-color); color: var(--button-text); }
        .button-info:hover { background-color: var(--info-color-darker); border-color: var(--info-color-darker); }
        .button-sm { padding: 6px 12px; font-size: 0.85rem; gap: 6px;}

        /* --- Header --- */
        header {
            background-color: var(--header-bg);
            padding: 15px 0;
            box-shadow: 0 2px 5px var(--shadow-color);
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }
        header .container { display: flex; justify-content: space-between; align-items: center; padding-top: 0; padding-bottom: 0; }
        .app-title { font-size: 1.6rem; font-weight: 700; color: var(--primary-color); }
        #theme-toggle { font-size: 1.3rem; background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s;}
        #theme-toggle:hover { background-color: var(--table-row-hover); }

        /* --- Navegación / Pestañas --- */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 5px;
        }
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px; /* Overlap bottom border */
            background-color: transparent;
            color: var(--secondary-color);
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 8px;
        }
        .tab-link:hover {
             color: var(--primary-color);
             background-color: var(--table-row-hover);
        }
        .tab-link.active {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-bottom-color: var(--card-bg); /* Hide bottom border part */
            color: var(--primary-color);
            font-weight: 700;
        }
        .tab-content {
            display: none;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-top: none;
            background-color: var(--card-bg);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Formularios y Entradas --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); font-size: 0.95rem;}
        input[type="text"], input[type="number"], input[type="file"], select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--input-focus-border);
            outline: 0;
            box-shadow: 0 0 0 0.25rem var(--input-focus-shadow);
        }
        input:disabled, select:disabled, textarea:disabled {
             background-color: var(--disabled-bg);
             color: var(--disabled-text);
             border-color: var(--disabled-border);
             cursor: not-allowed;
        }
        input[type="number"] { text-align: right; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { margin: 0; }
        input[type="file"] { padding: 8px; line-height: 1.5; } /* Adjust file input padding */
        .input-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .input-group label { margin-bottom: 0; font-weight: normal;}
        .input-group input[type="radio"] { width: auto; margin-right: 5px; }
        .input-small { width: 150px; display: inline-block; margin-left: 10px; }

        /* --- Tablas --- */
        .table-container { overflow-x: auto; margin-top: 25px; border: 1px solid var(--border-color); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); font-size: 0.9rem; }
        th, td {
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            vertical-align: middle;
            white-space: nowrap;
        }
        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            position: sticky; top: 0; z-index: 10;
            border-bottom-width: 2px;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--table-row-hover); }
        th:first-child, td:first-child { border-left: none; padding-left: 20px; /* More padding for first col */ }
        th:last-child, td:last-child { border-right: none; padding-right: 20px; /* More padding for last col */}

        /* Cell specific styles */
        td.real-month-cell { background-color: var(--real-month-bg) !important; /* Use important to override hover */ }
        td.estimated-month-cell { background-color: var(--estimated-month-bg) !important; }
        td.number-cell { text-align: right; font-variant-numeric: tabular-nums; }
        td.input-cell input { width: 100px; padding: 6px; font-size: 0.9rem; text-align: right; }
        td.input-cell input:disabled { background-color: transparent; border: none; color: var(--disabled-text);}
        .text-muted { color: var(--secondary-color); font-style: italic; font-size: 0.9em;}

        /* --- Tablas Desplegables --- */
        .collapsible-table tbody tr.rubro-total-row { font-weight: bold; cursor: pointer; background-color: var(--expandable-row-bg); transition: background-color 0.2s; }
        .collapsible-table tbody tr.rubro-total-row:hover { background-color: var(--clickable-row-hover); }
        .collapsible-table tbody tr.rubro-total-row td:first-child::before {
            content: '\f078'; /* fa-chevron-down */
            font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 12px; display: inline-block; transition: transform 0.2s ease-in-out; color: var(--primary-color);
        }
        .collapsible-table tbody tr.rubro-total-row.collapsed td:first-child::before { transform: rotate(-90deg); }
        .collapsible-table tbody tr.detail-row { display: table-row; background-color: var(--card-bg); transition: background-color 0.3s; }
        .collapsible-table tbody tr.detail-row.hidden { display: none; }
        .collapsible-table tbody tr.detail-row td { font-size: 0.85rem; color: var(--secondary-color); border-color: var(--border-color); }
        .collapsible-table tbody tr.detail-row td:first-child { padding-left: 40px; /* Indent details more */ }
        body.dark-mode .collapsible-table tbody tr.detail-row { background-color: #353535; }
        .collapsible-table tfoot tr { font-weight: bold; background-color: var(--table-header-bg); border-top: 2px solid var(--border-color); }

         /* Styles for Group/Ungroup All buttons */
        .table-actions {
            margin-bottom: 15px;
             display: flex;
             justify-content: flex-end; /* Align buttons to the right */
             gap: 10px;
             flex-wrap: wrap;
        }


        /* --- Componentes UI Específicos --- */
        #dashboard-summary { border-collapse: separate; border-spacing: 0; }
        #dashboard-summary th, #dashboard-summary td { text-align: center; white-space: normal; }
        #dashboard-summary tbody td, #dashboard-summary tfoot td { padding: 10px 8px; }
        #dashboard-summary .month-header { font-weight: bold; }

        .chart-container {
            margin-top: 35px; padding: 30px;
            background-color: var(--card-bg); border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            position: relative; min-height: 200px; /* Adjusted min height */
        }
        .chart-container canvas { max-width: 100%; height: 380px !important; }
        .chart-no-data { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-color); font-style: italic; font-size: 1.1rem; text-align: center; }

        #file-upload-area {
            border: 2px dashed var(--primary-color);
            padding: 45px; text-align: center; background-color: var(--bg-color);
            border-radius: 8px; margin-bottom: 25px; transition: background-color 0.2s ease, border-color 0.2s ease; cursor: pointer;
        }
        #file-upload-area:hover { background-color: var(--table-row-hover); border-color: var(--primary-color-darker); }
        #file-upload-area p { margin-bottom: 15px; font-size: 1.1rem; color: var(--secondary-color); }
        #file-upload-area i.fa-file-excel { font-size: 3rem; margin-bottom: 10px; color: var(--accent-color); }
        #file-upload-feedback { margin-top: 15px; font-weight: bold; white-space: pre-wrap; font-size: 0.95rem; min-height: 2em; }

        #reserve-fund-panel { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px;} /* MODIFICADO: Usar grid como IPC */
        #reserve-fund-panel .month-config { /* Removed flex styles, grid handles layout */ padding: 0; border-radius: 0; background-color: transparent; transition: none; }
        #reserve-fund-panel .month-config label { width: 100%; margin-bottom: 5px; font-weight: 600;}
        #reserve-fund-panel .month-config input { width: 100%; }
        #reserve-fund-panel .month-config span { margin-left: 5px; color: var(--secondary-color); font-size: 0.9em; } /* Style the unit */


        .config-section {
            border: 1px solid var(--border-color); border-radius: 8px; padding: 25px;
            margin-bottom: 30px; background-color: var(--card-bg);
            box-shadow: 0 3px 7px var(--shadow-color);
        }
        .config-section h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.6em; margin-bottom: 1.2em;}
        .management-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: var(--bg-color); }
        body.dark-mode .management-list { background-color: #3a3f44; }
        .management-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .management-list li:last-child { border-bottom: none;}
        .management-list li:hover { background-color: var(--table-row-hover); }
        .management-list li span { flex-grow: 1; margin-right: 15px; font-weight: 500; }
        .management-list li select { width: 200px; font-size: 0.88rem; padding: 6px 8px; flex-shrink: 0; }
        .management-list li button { flex-shrink: 0; }

         /* Styles for the NEW Coefficient Editor */
         #coefficient-editor { margin-top: 25px; }
         #coefficient-editor h4 { margin-bottom: 15px;}
         #coefficient-values-editor {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Similar grid to IPC */
             gap: 20px;
             padding: 20px; /* Add padding */
             border: 1px solid var(--border-color); /* Add border */
             border-radius: 6px; /* Add border-radius */
             background-color: var(--bg-color); /* Background like other lists/panels */
         }
         body.dark-mode #coefficient-values-editor { background-color: #3a3f44; }

         #coefficient-values-editor .form-group { margin-bottom: 0; } /* Adjust form-group margin inside grid */
         #coefficient-values-editor .form-group label { margin-bottom: 5px; font-weight: 600; width: 100%;} /* Adjust label */
         #coefficient-values-editor .form-group input { width: 100%; max-width: none; } /* Allow input to fill grid cell */
         #coefficient-values-editor .text-muted { grid-column: 1 / -1; text-align: center; padding: 20px; } /* Center and span info message */


         /* --- Snackbar --- */
        #snackbar {
            visibility: hidden; min-width: 300px; max-width: 90%;
            background-color: var(--success-color); /* Default to success */
            color: var(--button-text); text-align: center;
            border-radius: 6px; padding: 18px 25px; position: fixed; z-index: 1001;
            left: 50%; transform: translateX(-50%); bottom: 30px;
            font-size: 1.05rem; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; transition: visibility 0s 0.5s, opacity 0.5s ease-out, bottom 0.5s ease-out;
        }
        #snackbar.show {
            visibility: visible; opacity: 1; bottom: 60px;
            transition: opacity 0.5s ease-in, bottom 0.5s ease-in;
        }
        #snackbar.error { background-color: var(--danger-color); color: var(--button-text); }
        #snackbar.warning { background-color: var(--warning-color); color: var(--button-warning-text); }
        #snackbar.info { background-color: var(--info-color); color: var(--button-text); }


        /* --- Footer --- */
        footer {
            margin-top: auto; padding: 20px 0; text-align: center; font-size: 0.95em;
            color: var(--secondary-color); background-color: var(--header-bg);
            border-top: 1px solid var(--border-color);
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1200px) { .container { width: 98%; } .chart-container canvas { height: 320px !important; } }
        @media (max-width: 992px) {
             h1 { font-size: 2rem; } h2 { font-size: 1.6rem; } h3 { font-size: 1.3rem; }
             .tabs { justify-content: flex-start; }
             .tab-link { padding: 10px 18px; font-size: 0.95rem;}
             table { font-size: 0.88rem; } th,td {padding: 10px 12px;}
             .management-list li select { width: 150px; } /* Reduce select width */
        }
        @media (max-width: 768px) {
            body { line-height: 1.6; }
            .app-title { font-size: 1.3rem;} #theme-toggle { font-size: 1.1rem;}
            .chart-container { padding: 20px;} .chart-container canvas { height: 280px !important; }
            .input-group { flex-direction: column; align-items: stretch; gap: 10px;}
            .input-small { margin-left: 0; margin-top: 8px; width: 100%; }
            /* Adjust Reserve Fund and Coefficient Editor grid columns */
            #reserve-fund-panel, #coefficient-values-editor, #ipc-inputs { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;}
            #reserve-fund-panel .month-config label { width: 100%; text-align: left; margin-bottom: 5px; }
            #reserve-fund-panel .month-config input { width: 100%; }
            table { font-size: 0.85rem; } th, td { padding: 9px 8px; white-space: normal; } /* Allow wrap */
            th:first-child, td:first-child { padding-left: 15px; }
            th:last-child, td:last-child { padding-right: 15px; }
            td.input-cell input { width: 80px; padding: 5px; }
            .management-list li { flex-wrap: wrap; gap: 8px; }
            .management-list li span { flex-basis: 100%; margin-right: 0; } /* Name takes full width */
            .management-list li select { width: calc(100% - 50px); margin-top: 5px; } /* Select almost full width */
            .management-list li button { margin-left: auto; } /* Push button right */
            button { font-size: 0.95rem; padding: 10px 18px;}
            .tabs { gap: 2px; }
            .tab-link { padding: 8px 10px; font-size: 0.85rem;}
             .table-actions { justify-content: center; }
        }
        @media (max-width: 576px) {
            h1 { font-size: 1.7rem; } .app-title { display: none; } header .container { justify-content: flex-end; }
            .tab-link { padding: 8px 10px; font-size: 0.85rem;}
            th, td { padding: 8px 6px; }
            th:first-child, td:first-child { padding-left: 10px; }
            th:last-child, td:last-child { padding-right: 10px; }
            .chart-container canvas { height: 220px !important; }
            #snackbar { min-width: 90%; bottom: 20px; font-size: 1rem; padding: 15px 20px; }
            #snackbar.show { bottom: 40px; }
            #file-upload-area { padding: 30px; }
            .management-list li select { width: 100%; } /* Select full width on smallest screens */
             /* Adjust Reserve Fund and Coefficient Editor grid columns */
             #reserve-fund-panel, #coefficient-values-editor, #ipc-inputs { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;}
        }
    </style>




<style id="legend-fix">
.chartjs-legend li span,
.chart-legend li span,
.chartjs-legend li,
.chart-legend li { text-decoration:none !important; }
</style>

</head>
<body>
    <header>
        <div class="container">
            <span class="app-title">Proyección Expensas - El Centauro</span>
            <button id="theme-toggle" title="Cambiar tema"><i class="fas fa-moon"></i></button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="tab-link" onclick="openTab(event, 'upload')"><i class="fas fa-upload"></i> Cargar Datos</button>
            <button class="tab-link" onclick="openTab(event, 'reserve')"><i class="fas fa-piggy-bank"></i> Fondo Reserva</button>
            <button class="tab-link" onclick="openTab(event, 'settings')"><i class="fas fa-cog"></i> Configuración</button>
            <button class="tab-link" onclick="openTab(event, 'reports')"><i class="fas fa-download"></i> Reportes</button>
        </div>

        <!-- ==================== DASHBOARD ==================== -->
        <div id="dashboard" class="tab-content active">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Anual - <span id="dashboard-year"></span> (<span id="dashboard-scenario">Base</span>)</h2>
            <div class="form-group input-group">
                <label for="scenario-selector" style="flex-shrink: 0;">Escenario:</label>
                <select id="scenario-selector" style="flex-grow: 1;"></select>
                <button onclick="createScenario()" class="button-primary button-sm" title="Crear Escenario Nuevo"><i class="fas fa-plus"></i> Crear</button>
                <button onclick="cloneScenario()" class="button-secondary button-sm" title="Clonar Escenario Actual"><i class="fas fa-clone"></i> Clonar</button>
                <button onclick="deleteScenario()" class="button-danger button-sm" title="Eliminar Escenario Actual"><i class="fas fa-trash"></i> Eliminar</button>
                <button id="btnBorrarDatos" class="button-warning button-sm" title="Borrar Datos del Escenario Actual (Gastos, Ingresos, Status)" onclick="clearScenarioData()" ><i class="fas fa-broom"></i> Borrar Datos</button>
                <button onclick="recalculateEstimates()" class="button-info button-sm" title="Proyectar meses estimados basados en último mes real y coeficientes (acumulativo)"><i class="fas fa-calculator"></i> Calcular Estimados</button>
            </div>

            <h4>Resumen Mensual General</h4>
            <div class="table-container">
                <table id="dashboard-summary">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Gasto ($)</th>
                            <th>Fondo ($)</th>
                            <th>Cuota s/Gs ($/UF)</th> <!-- Basado en Gasto+Fondo / UF -->
                            <th>IPC (%)</th>
                            <th>Cuota IPC ($/UF)</th>   <!-- NUEVO: Cuota s/Gs * (1 + IPC%) -->
                            <!-- MODIFICACIÓN INICIO - Encabezado de tabla -->
                            <th>Expensa Real ($/UF)</th> <!-- Ahora muestra el valor del rubro Expensas Ordinarias / UF -->
                            <!-- MODIFICACIÓN FIN -->
                        </tr>
                    </thead>
                    <tbody><!-- Contenido generado por JS --></tbody>
                    <tfoot><!-- Contenido generado por JS --></tfoot>
                </table>
            </div>

            <h4 style="margin-top: 30px;">Detalle de Gastos Proyectados ($)</h4>
             <p class="text-muted" style="font-size: 0.9em;">Haga clic en una fila de rubro para expandir/colapsar los detalles. Las celdas mensuales de detalle se colorean según su origen: <span style="background-color: var(--real-month-bg); padding: 1px 4px; border-radius: 3px;">REAL</span> (cargado desde Excel con número) o <span style="background-color: var(--estimated-month-bg); padding: 1px 4px; border-radius: 3px;">ESTIMADO</span> (cargado sin número o proyectado/calculado).</p>

            <!-- Added Group/Ungroup Buttons for Gastos -->
            <div class="table-actions">
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('gastos', false)" title="Expandir todos los detalles de gastos"><i class="fas fa-expand"></i> Expandir Todo</button>
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('gastos', true)" title="Colapsar todos los detalles de gastos"><i class="fas fa-compress"></i> Colapsar Todo</button>
            </div>

            <div class="table-container">
                <table id="gastos-detail-table" class="collapsible-table">
                     <thead>
                        <tr>
                            <th>Rubro / Detalle</th>
                            <th>Coef. Aplicado</th> <!-- Add Coef. column header -->
                            <!-- Meses y Total Anual generados por JS -->
                         </tr>
                     </thead>
                     <tbody><!-- Contenido generado por JS --></tbody>
                     <tfoot><!-- Contenido generado por JS --></tfoot>
                </table>
            </div>

            <h4 style="margin-top: 30px;">Detalle de Ingresos Proyectados ($)</h4>
             <p class="text-muted" style="font-size: 0.9em;">Haga clic en una fila de rubro para expandir/colapsar. Los valores aquí son la base de cálculo (valor individual o por UF). El Total de Ingresos en el Resumen General puede incluir la multiplicación por UF.</p>

             <!-- Added Group/Ungroup Buttons for Ingresos -->
             <div class="table-actions">
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('ingresos', false)" title="Expandir todos los detalles de ingresos"><i class="fas fa-expand"></i> Expandir Todo</button>
                 <button class="button-secondary button-sm" onclick="toggleAllRubroDetails('ingresos', true)" title="Colapsar todos los detalles de ingresos"><i class="fas fa-compress"></i> Colapsar Todo</button>
            </div>

            <div class="table-container">
                 <table id="ingresos-detail-table" class="collapsible-table">
                      <thead>
                         <tr>
                            <th>Rubro / Detalle</th>
                             <!-- Meses y Total Anual generados por JS -->
                         </tr>
                       </thead>
                      <tbody><!-- Contenido generado por JS --></tbody>
                      <tfoot><!-- Contenido generado por JS --></tfoot>
                 </table>
            </div>

            <div class="chart-container">
                 <h3>Evolutivo Expensa Mensual ($/UF)</h3> <!-- MODIFICADO -->
                 <canvas id="evolutivoCuotaChart"></canvas>
                 <div class="chart-no-data" style="display: none;">No hay datos suficientes para graficar.</div>
            </div>

            <div style="display: flex; gap: 25px; flex-wrap: wrap; margin-top: 35px;">
                <div class="chart-container" style="flex: 1; min-width: 320px;">
                    <h3>Participación Gastos (%)</h3>
                    <canvas id="participacionGastosChart"></canvas>
                    <div class="chart-no-data" style="display: none;">No hay datos de gastos<br>para mostrar el gráfico.</div>
                </div>
                <div class="chart-container" style="flex: 1; min-width: 320px;">
                    <h3>Participación Ingresos (%)</h3>
                    <canvas id="participacionIngresosChart"></canvas>
                    <div class="chart-no-data" style="display: none;">No hay datos de ingresos<br>para mostrar el gráfico.</div>
                </div>
            </div>
        </div>

        <!-- ==================== UPLOAD ==================== -->
        <div id="upload" class="tab-content">
            <h2><i class="fas fa-upload"></i> Cargar Datos Reales / Base</h2>
            <div class="form-group input-group">
                <label for="exercise-year">Año del Ejercicio:</label>
                <input type="number" id="exercise-year" min="2020" max="2099" value="2024" style="width: 120px;">
                <button onclick="createNewExercise()" class="button-success"><i class="fas fa-calendar-plus"></i> Crear/Seleccionar Año</button>
             </div>
            <p>Sube tu archivo Excel con las hojas <strong>"Gastos"</strong> e <strong>"Ingresos"</strong>. Los rubros nuevos se añadirán automáticamente a la sección de Configuración.</p>
            <p><strong>Importante:</strong>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Las celdas con **números** en la hoja "Gastos" marcarán ese mes/detalle como '<strong style="color: var(--accent-color)">REAL</strong>' (fondo verde claro en detalle). Las celdas vacías o con texto se considerarán '<strong style="color: var(--warning-color)">ESTIMADO</strong>'.</li>
                    <li>Los rubros de Ingreso llamados "<strong id="cuota-rubro-name-info">Expensas Ordinarias</strong>" y "<strong>Expensas Extraordinarias</strong>" tendrán sus valores base multiplicados por la cantidad de UF (definida en Configuración) al calcular el *total* de ingresos en el Resumen General. La columna "Expensa Real ($/UF)" en el resumen muestra el valor del rubro "<strong id="cuota-rubro-name-info2">Expensas Ordinarias</strong>" <strong style="color: var(--primary-color)">dividido por la cantidad de UF</strong>.</li>
                </ul>
            </p>
            <div id="file-upload-area" onclick="document.getElementById('excel-file-input').click()">
                 <p><i class="fas fa-file-excel"></i><br>Arrastra tu archivo Excel aquí (.xlsx, .xls) o haz clic para seleccionar</p>
                 <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(this.files)">
                 <button type="button" class="button-primary" onclick="event.stopPropagation(); document.getElementById('excel-file-input').click()" style="pointer-events: auto;"><i class="fas fa-folder-open"></i> Seleccionar Archivo</button>
                 <button type="button" onclick="event.stopPropagation(); loadSampleData()" style="margin-left: 10px; pointer-events: auto;" class="button-secondary"><i class="fas fa-database"></i> Cargar Datos Ejemplo</button>
            </div>
            <div id="file-upload-feedback"></div>
            <a href="#" onclick="event.preventDefault(); downloadTemplate();" title="Descargar archivo Excel con estructura de ejemplo"><i class="fas fa-download"></i> Descargar Plantilla Ejemplo</a>
        </div>

        <!-- ==================== RESERVE FUND ==================== -->
        <div id="reserve" class="tab-content">
             <h2><i class="fas fa-piggy-bank"></i> Configurar Fondo de Reserva - <span class="current-year"></span> (<span class="current-scenario">Base</span>)</h2>
             <div class="form-group">
                 <label>Método de Cálculo del Fondo:</label>
                 <div class="input-group">
                     <input type="radio" id="reserve-type-percent" name="reserve-type" value="percent" checked onchange="updateReserveUI()">
                     <label for="reserve-type-percent">Porcentaje (%) sobre Gastos Mensuales</label>
                     <input type="radio" id="reserve-type-fixed" name="reserve-type" value="fixed" onchange="updateReserveUI()">
                     <label for="reserve-type-fixed">Valor Fijo Mensual ($)</label>
                 </div>
             </div>
             <div id="reserve-fund-panel">
                 <!-- Inputs generados por JS -->
             </div>
             <button onclick="saveReserveFund()" style="margin-top: 25px; width: 100%; padding: 15px;" class="button-success button-lg" title="Guardar los valores mensuales y el tipo de cálculo del fondo">
                 <i class="fas fa-save"></i> GUARDAR FONDO DE RESERVA Y RECALCULAR
            </button>
        </div>

        <!-- ==================== SETTINGS ==================== -->
        <div id="settings" class="tab-content">
             <h2><i class="fas fa-cog"></i> Configuración General y de Cálculo</h2>

             <div class="config-section">
                 <h4><i class="fas fa-building"></i> Ajustes Generales del Barrio</h4>
                 <div class="form-group">
                     <label for="cantidad-unidades">Cantidad Total de Unidades Funcionales (UF):</label>
                     <input type="number" id="cantidad-unidades" min="1" value="100" style="width: 180px;" title="Número total de UF para calcular cuotas base">
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-list-alt"></i> Gestión de Rubros (Categorías)</h4>
                 <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                     <div style="flex: 1; min-width: 320px;">
                         <h5><i class="fas fa-arrow-down" style="color:var(--danger-color)"></i> Rubros de GASTOS</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-gasto-rubro-name" placeholder="Nombre nuevo rubro de gasto" style="flex-grow: 1;">
                             <button onclick="addRubro('gastos')" class="button-sm button-success" title="Añadir este nuevo rubro a la lista de gastos"><i class="fas fa-plus"></i> Añadir</button>
                         </div>
                         <ul id="gasto-rubro-list" class="management-list"></ul>
                     </div>
                     <div style="flex: 1; min-width: 320px;">
                          <h5><i class="fas fa-arrow-up" style="color:var(--success-color)"></i> Rubros de INGRESOS</h5>
                          <div class="form-group input-group">
                              <input type="text" id="new-ingreso-rubro-name" placeholder="Nombre nuevo rubro de ingreso" style="flex-grow: 1;">
                              <button onclick="addRubro('ingresos')" class="button-sm button-success" title="Añadir este nuevo rubro a la lista de ingresos"><i class="fas fa-plus"></i> Añadir</button>
                          </div>
                          <ul id="ingreso-rubro-list" class="management-list"></ul>
                     </div>
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-percentage"></i> Gestión de Coeficientes de Ajuste (para Gastos Estimados)</h4>
                 <p class="text-muted" style="font-size: 0.9em;">Define tipos de coeficientes (ej. Inflación, Aumento Gremial) y asigna uno a cada rubro de Gasto. Al usar "Calcular Estimados" en el Dashboard, el sistema proyectará los meses sin datos '<strong style="color: var(--accent-color)">REAL</strong>' (marcados en amarillo) multiplicando el último valor '<strong style="color: var(--accent-color)">REAL</strong>' por el coeficiente acumulado correspondiente a cada mes futuro.</p>
                 <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                     <div style="flex: 1; min-width: 280px;">
                         <h5>Tipos de Coeficientes Disponibles</h5>
                         <div class="form-group input-group">
                             <input type="text" id="new-coefficient-type-name" placeholder="Nuevo tipo (ej: Aumento Sindicato)" style="flex-grow: 1;">
                             <button onclick="addCoefficientType()" class="button-sm button-success" title="Añadir este nuevo tipo de coeficiente a la lista"><i class="fas fa-plus"></i> Añadir Tipo</button>
                         </div>
                         <ul id="coefficient-type-list" class="management-list"></ul>
                     </div>
                     <div id="coefficient-editor" style="flex: 2; min-width: 450px;">
                          <h5><i class="fas fa-edit"></i> Editar Valores Mensuales para: <span id="editing-coefficient-name" style="color: var(--primary-color); font-weight: bold;"></span></h5>
                           <!-- MODIFICACIÓN FIX: Reemplazar tabla por grid similar a IPC -->
                          <div id="coefficient-values-editor">
                              <p class="text-muted">Selecciona un tipo de coeficiente (que no sea "Sin Coeficiente") de la lista de la izquierda para editar sus valores porcentuales (%) mes a mes.</p>
                          </div>
                         <!-- END MODIFICACIÓN FIX -->
                     </div>
                 </div>
             </div>

             <div class="config-section">
                 <h4><i class="fas fa-chart-line"></i> Índices IPC Mensuales de Referencia (%)</h4>
                 <p class="text-muted">Introduce el porcentaje (%) de IPC estimado o real para cada mes. Se usa únicamente para calcular la columna "Cuota IPC ($/UF)" como referencia en el Dashboard.</p>
                 <div id="ipc-inputs" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px;">
                     <!-- Inputs generados por JS -->
                 </div>
             </div>

             <button onclick="saveSettings()" style="margin-top: 20px; width: 100%; padding: 15px;" class="button-success button-lg" title="Guardar todos los cambios realizados en esta pestaña (UF, Rubros, Coeficientes, IPC) y recalcular el escenario actual">
                 <i class="fas fa-save"></i> GUARDAR TODA LA CONFIGURACIÓN Y RECALCULAR
             </button>
        </div>

        <!-- ==================== REPORTS ==================== -->
        <div id="reports" class="tab-content">
             <h2><i class="fas fa-download"></i> Descargar Reportes - <span class="current-year"></span> (<span class="current-scenario">Base</span>)</h2>
             <p>Genera y descarga los datos del ejercicio y escenario actual en formato Excel, incluyendo detalles y resumen.</p>
             <button onclick="exportToExcel()" class="button-success" title="Descargar un archivo .xlsx con el detalle y resumen del escenario actual"><i class="fas fa-file-excel"></i> Descargar Reporte Completo (.xlsx)</button>

             <h3 style="margin-top: 35px;">Exportar Gráficos Individuales</h3>
             <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                 <button onclick="exportChart('evolutivoCuotaChart', 'evolutivo_expensa.png')" class="button-secondary" title="Descargar el gráfico de evolución de expensas como imagen PNG"><i class="fas fa-chart-line"></i> Gráfico Evolutivo (PNG)</button> <!-- MODIFICADO -->
                 <button onclick="exportChart('participacionGastosChart', 'participacion_gastos.png')" class="button-secondary" title="Descargar el gráfico de torta de gastos como imagen PNG"><i class="fas fa-chart-pie"></i> Gráfico Gastos (PNG)</button>
                 <button onclick="exportChart('participacionIngresosChart', 'participacion_ingresos.png')" class="button-secondary" title="Descargar el gráfico de torta de ingresos como imagen PNG"><i class="fas fa-chart-pie"></i> Gráfico Ingresos (PNG)</button>
             </div>
        </div>
    </div> <!-- /container -->

    <footer>
        <div class="container">
            &copy; <span id="footer-year"></span> Proyección Expensas El Centauro. v2.7 (Coef. % Fix)
        </div>
    </footer>
    <div id="snackbar">Mensaje</div>

    <!-- ==================== SCRIPT PRINCIPAL ==================== -->
    <script>
        // --- Constantes y Estado Global ---
        const MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const FULL_MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        const GASTOS_SHEET_NAME = "Gastos";
        const INGRESOS_SHEET_NAME = "Ingresos";
        // --- MODIFICACIÓN FIX: Version bump for coefficient interpretation change and UI ---
        const STORAGE_KEY = 'expensasAppCentauroState_v2.7_CoefPercFix';
        // --- END MODIFICACIÓN FIX ---
        const CUOTA_RUBRO_NAME = "Expensas Ordinarias"; // Rubro principal para multiplicar x UF y base de Expensa Real
        const EXTRA_CUOTA_RUBRO_NAME = "Expensas Extraordinarias"; // Otro rubro a multiplicar x UF
        const SPECIAL_INGRESO_RUBROS = [CUOTA_RUBRO_NAME, EXTRA_CUOTA_RUBRO_NAME]; // Actualizado automáticamente

        let appState = getDefaultAppState(); // Iniciar con estado por defecto limpio

        // Chart instances (moved to scope variables)
        let evolutivoCuotaChart_instance = null;
        let participacionGastosChart_instance = null;
        let participacionIngresosChart_instance = null;


        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`DOM Cargado. Inicializando App ${STORAGE_KEY}...`);
            loadState(); // Cargar estado guardado si existe
            initTheme(); // Aplicar tema (antes de cualquier render que dependa de él)

            // Asegurar que exista al menos un escenario activo y válido
            validateAndSetActiveScenario();

            // --- MODIFICADO: Update UI instructions with the correct name ---
            const cuotaInfoSpan = document.getElementById('cuota-rubro-name-info');
            if (cuotaInfoSpan) cuotaInfoSpan.textContent = CUOTA_RUBRO_NAME;
             // MODIFICACIÓN INICIO - Segunda referencia al nombre del rubro
            const cuotaInfoSpan2 = document.getElementById('cuota-rubro-name-info2');
            if (cuotaInfoSpan2) cuotaInfoSpan2.textContent = CUOTA_RUBRO_NAME;
            // MODIFICACIÓN FIN

            initUI(); // Inicializar elementos de la UI que dependen del estado inicial
            addEventListeners(); // Añadir listeners globales
            updateUI(); // Renderizar todo con el estado actual/cargado
            console.log(`App ${STORAGE_KEY} Inicializada.`);
        });

        // --- Validación y Selección de Escenario Activo ---
        function validateAndSetActiveScenario() {
            let activeKeyIsValid = false;
            // Check if activeScenarioKey exists and points to a valid scenario
            if (appState.activeScenarioKey && appState.scenarios && appState.scenarios[appState.activeScenarioKey]) {
                 const activeYear = parseInt(appState.activeScenarioKey.split('_')[0]);
                 // Optionally check if the year in the key matches the stored currentYear,
                 // although currentYear should ideally follow activeScenarioKey's year.
                 // Let's prioritize the key's year if mismatch.
                if (!isNaN(activeYear) && appState.scenarios[appState.activeScenarioKey].year === activeYear) {
                   appState.currentYear = activeYear; // Ensure currentYear is in sync
                   activeKeyIsValid = true;
                } else {
                   console.warn(`Active scenario key "${appState.activeScenarioKey}" does not match its stored year or is invalid.`);
                   // Invalidate the key if data mismatch or year is invalid
                   appState.activeScenarioKey = null;
                }
            } else {
                console.warn(`Invalid or missing active scenario key: ${appState.activeScenarioKey}`);
                 appState.activeScenarioKey = null; // Ensure it's null if validation failed
            }


            if (!activeKeyIsValid) {
                console.warn(`Clave activa inválida o ausente. Buscando alternativa...`);
                // Try finding Base for the default/current year
                const defaultYear = new Date().getFullYear();
                const defaultYearBaseKey = `${defaultYear}_Base`;

                // Try finding *any* scenario for the default year first
                const firstKeyForDefaultYear = Object.keys(appState.scenarios || {}).find(k => k.startsWith(`${defaultYear}_`));

                // Try finding the very first scenario available globally
                const firstKeyOverall = Object.keys(appState.scenarios || {})[0];


                let fallbackKey = null;
                if (appState.scenarios?.[defaultYearBaseKey]) {
                    fallbackKey = defaultYearBaseKey;
                } else if (firstKeyForDefaultYear) {
                    fallbackKey = firstKeyForDefaultYear;
                } else if (firstKeyOverall) {
                    fallbackKey = firstKeyOverall;
                }

                if (fallbackKey) {
                    console.log(`Cambiando a escenario de fallback: ${fallbackKey}`);
                    appState.activeScenarioKey = fallbackKey;
                    // Ensure currentYear is updated based on the fallback key
                    appState.currentYear = parseInt(fallbackKey.split('_')[0]);
                } else {
                    // No scenarios exist at all, create the default Base for the current year
                    console.log("No existen escenarios. Creando Base para el año actual.");
                    appState.currentYear = new Date().getFullYear(); // Use actual current year
                    initScenarioData(appState.currentYear); // Creates Base by default
                    appState.activeScenarioKey = `${appState.currentYear}_Base`;
                }
                saveState(); // Save potentially corrected state
            }

             // Ensure the selected scenario data structure is complete
             const currentScenario = getCurrentScenarioData();
             if (currentScenario) {
                initializeScenarioDataForRubros(currentScenario);
             } else {
                 // This case should ideally not happen if fallback logic works,
                 // but as a last resort, ensure default Base is created if all else fails.
                  const defaultYear = new Date().getFullYear();
                  const defaultBaseKey = `${defaultYear}_Base`;
                  if (!appState.scenarios?.[defaultBaseKey]) {
                       console.warn("validateAndSetActiveScenario: Fallback logic failed, no valid scenario found. Creating default Base.");
                       appState.currentYear = defaultYear;
                       initScenarioData(appState.currentYear);
                       appState.activeScenarioKey = defaultBaseKey;
                       saveState();
                  }
             }
        }


        // --- Gestión de Datos del Escenario ---
        function getCurrentScenarioData() {
             // Return the scenario data if the active key exists and is valid
             if (appState.activeScenarioKey && appState.scenarios && appState.scenarios[appState.activeScenarioKey]) {
                 return appState.scenarios[appState.activeScenarioKey];
             }
             // If not valid, attempt to re-validate and set an active scenario
             console.warn("getCurrentScenarioData: No active scenario found. Attempting validation.");
             validateAndSetActiveScenario(); // This might set a new activeScenarioKey
             // Return the scenario data *after* potential validation
             return appState.scenarios?.[appState.activeScenarioKey] || null;
        }

        function initScenarioData(year, scenarioName = 'Base') {
            const key = `${year}_${scenarioName.replace(/\s+/g, '_').replace(/[^\w-]/g, '')}`; // Sanitize key
            if (!appState.scenarios[key]) {
                console.log(`Inicializando nuevo escenario: ${key}`);
                // Start with a deep copy of the default structure's scenario part
                 // Define a base scenario structure if the default state doesn't provide one (safety)
                 const baseScenarioStructure = {
                     year: year,
                     scenarioName: scenarioName,
                     rubroOrder: { gastos: [], ingresos: [] },
                     data: { gastos: {}, ingresos: {} },
                     monthStatus: { gastos: {}, ingresos: {} }, // Only used for Gastos
                     reserveFund: { type: 'percent', values: Array(12).fill(5) }, // Default 5%
                     calculated: {
                         gastoAjustado: {}, totalGastoRubroMes: {}, totalGastoProyectadoMes: Array(12).fill(0),
                         ingresoAjustado: {}, totalIngresoRubroMes: {}, totalIngresoProyectadoMes: Array(12).fill(0),
                         fondoReservaMes: Array(12).fill(0),
                         cuotaSobreGastosMes: Array(12).fill(0),
                         ipcManual: Array(12).fill(0), // Snapshot of IPC from settings
                         cuotaIpcMes: Array(12).fill(0),
                         cuotaRealBaseMes: Array(12).fill(0),
                         annualTotals: {
                             gastos: {__TOTAL__:0}, ingresos: {__TOTAL__:0}, fondoReserva: 0,
                             cuotaSobreGastos: 0, cuotaIpc: 0, cuotaRealBase: 0
                         }
                     }
                 };
                 // Deep copy the base structure
                 appState.scenarios[key] = JSON.parse(JSON.stringify(baseScenarioStructure));

                 // Copy GLOBAL settings IPC into the new scenario's IPC snapshot
                 if (Array.isArray(appState.settings?.ipcManual) && appState.settings.ipcManual.length === 12) {
                      appState.scenarios[key].calculated.ipcManual = [...appState.settings.ipcManual];
                 } else {
                      appState.scenarios[key].calculated.ipcManual = Array(12).fill(0);
                 }


                 // Ensure structures for existing global rubros are created within this new scenario
                initializeScenarioDataForRubros(appState.scenarios[key]);
            }
            return appState.scenarios[key];
        }


        function initializeScenarioDataForRubros(scenarioData) {
             if (!scenarioData) {
                console.warn("initializeScenarioDataForRubros llamado sin datos de escenario.");
                return;
             }

             // Ensure top-level structures exist (using nullish coalescing and default values)
             scenarioData.rubroOrder = scenarioData.rubroOrder ?? { gastos: [], ingresos: [] };
             scenarioData.rubroOrder.gastos = scenarioData.rubroOrder.gastos ?? [];
             scenarioData.rubroOrder.ingresos = scenarioData.rubroOrder.ingresos ?? [];

             scenarioData.data = scenarioData.data ?? { gastos: {}, ingresos: {} };
             scenarioData.data.gastos = scenarioData.data.gastos ?? {};
             scenarioData.data.ingresos = scenarioData.data.ingresos ?? {};

             scenarioData.monthStatus = scenarioData.monthStatus ?? { gastos: {}, ingresos: {} };
             scenarioData.monthStatus.gastos = scenarioData.monthStatus.gastos ?? {};
             // Note: monthStatus is currently only used/relevant for Gastos. Ingresos status isn't tracked per cell.

             scenarioData.reserveFund = scenarioData.reserveFund ?? { type: 'percent', values: Array(12).fill(5) };
             // Ensure reserveFund values array is 12 elements
              if (!Array.isArray(scenarioData.reserveFund.values) || scenarioData.reserveFund.values.length !== 12) {
                  scenarioData.reserveFund.values = Array(12).fill(scenarioData.reserveFund.type === 'fixed' ? 0 : 5);
              }


             scenarioData.calculated = scenarioData.calculated ?? {}; // Ensure calculated object exists
             // Ensure default calculated arrays/objects exist if missing
             const defaultCalcStructure = getDefaultAppState().scenarios.BaseExample?.calculated || {
                  gastoAjustado: {}, totalGastoRubroMes: {}, totalGastoProyectadoMes: Array(12).fill(0),
                  ingresoAjustado: {}, totalIngresoRubroMes: {}, totalIngresoProyectadoMes: Array(12).fill(0),
                  fondoReservaMes: Array(12).fill(0), cuotaSobreGastosMes: Array(12).fill(0),
                  ipcManual: Array(12).fill(0), cuotaIpcMes: Array(12).fill(0), cuotaRealBaseMes: Array(12).fill(0),
                  annualTotals: { gastos: {__TOTAL__:0}, ingresos: {__TOTAL__:0}, fondoReserva: 0, cuotaSobreGastos: 0, cuotaIpc: 0, cuotaRealBase: 0 }
             };

             for(const key in defaultCalcStructure) {
                // Only initialize if missing, don't deep copy arrays/objects here,
                // as they might contain existing loaded data.
                if(scenarioData.calculated[key] === undefined || scenarioData.calculated[key] === null) {
                     // For arrays/objects, create fresh empty ones
                     if (Array.isArray(defaultCalcStructure[key])) {
                         scenarioData.calculated[key] = Array(defaultCalcStructure[key].length).fill(0);
                     } else if (typeof defaultCalcStructure[key] === 'object' && defaultCalcStructure[key] !== null) {
                          scenarioData.calculated[key] = {};
                     } else {
                          scenarioData.calculated[key] = defaultCalcStructure[key];
                     }
                }
             }
              // Specifically ensure calculated.annualTotals substructures exist
              scenarioData.calculated.annualTotals = scenarioData.calculated.annualTotals ?? {};
              scenarioData.calculated.annualTotals.gastos = scenarioData.calculated.annualTotals.gastos ?? { __TOTAL__: 0 };
              scenarioData.calculated.annualTotals.ingresos = scenarioData.calculated.annualTotals.ingresos ?? { __TOTAL__: 0 };

             // Ensure ipcManual array exists and has 12 elements (copy from settings if scenario one is bad)
             if (!Array.isArray(scenarioData.calculated.ipcManual) || scenarioData.calculated.ipcManual.length !== 12) {
                console.warn(`Scenario ${scenarioData.year}-${scenarioData.scenarioName} IPC snapshot invalid. Copying from settings.`);
                scenarioData.calculated.ipcManual = [...(appState.settings?.ipcManual || Array(12).fill(0))];
             }


             // Iterate through GLOBAL rubro lists from settings to ensure scenario structures exist for them
             ['gastos', 'ingresos'].forEach(type => {
                 const globalRubros = appState.settings?.rubros?.[type] || [];
                 globalRubros.forEach(rubro => {
                     // Ensure data/status structures for the rubro exist in the scenario
                     if (!scenarioData.data[type][rubro]) {
                         scenarioData.data[type][rubro] = { detailOrder: [], detailsData: {} };
                     }
                     if (type === 'gastos' && !scenarioData.monthStatus[type][rubro]) {
                         scenarioData.monthStatus[type][rubro] = {}; // Initialize as object for details
                     }
                     // Initialize detailOrder/detailsData inside data[type][rubro] if they are missing
                     scenarioData.data[type][rubro].detailOrder = scenarioData.data[type][rubro].detailOrder ?? [];
                     scenarioData.data[type][rubro].detailsData = scenarioData.data[type][rubro].detailsData ?? {};


                     // Initialize calculated substructures for this rubro if missing
                     if (type === 'gastos') {
                        scenarioData.calculated.gastoAjustado = scenarioData.calculated.gastoAjustado ?? {};
                        scenarioData.calculated.totalGastoRubroMes = scenarioData.calculated.totalGastoRubroMes ?? {};
                        if (!scenarioData.calculated.gastoAjustado[rubro]) scenarioData.calculated.gastoAjustado[rubro] = {};
                        if (!scenarioData.calculated.totalGastoRubroMes[rubro]) scenarioData.calculated.totalGastoRubroMes[rubro] = Array(12).fill(0);
                     } else { // ingresos
                        scenarioData.calculated.ingresoAjustado = scenarioData.calculated.ingresoAjustado ?? {};
                        scenarioData.calculated.totalIngresoRubroMes = scenarioData.calculated.totalIngresoRubroMes ?? {};
                         if (!scenarioData.calculated.ingresoAjustado[rubro]) scenarioData.calculated.ingresoAjustado[rubro] = {};
                         if (!scenarioData.calculated.totalIngresoRubroMes[rubro]) scenarioData.calculated.totalIngresoRubroMes[rubro] = Array(12).fill(0);
                     }

                     // Initialize annual totals for the rubro if missing
                     if (scenarioData.calculated.annualTotals[type][rubro] === undefined) {
                         scenarioData.calculated.annualTotals[type][rubro] = 0;
                     }

                     // Ensure detail structures within the rubro data/status are initialized
                     const detailOrder = scenarioData.data[type][rubro].detailOrder ?? [];
                     detailOrder.forEach(detail => {
                         if(scenarioData.data[type][rubro].detailsData[detail] === undefined) {
                              scenarioData.data[type][rubro].detailsData[detail] = Array(12).fill(0);
                         } else if (!Array.isArray(scenarioData.data[type][rubro].detailsData[detail]) || scenarioData.data[type][rubro].detailsData[detail].length !== 12) {
                             // If it exists but is not a valid 12-element array, replace it
                             console.warn(`Detail data for ${type}/${rubro}/${detail} is invalid. Resetting.`);
                             scenarioData.data[type][rubro].detailsData[detail] = Array(12).fill(0);
                         }

                         if (type === 'gastos') {
                              if (scenarioData.monthStatus[type][rubro]?.[detail] === undefined) {
                                  scenarioData.monthStatus[type][rubro][detail] = Array(12).fill('Estimado');
                              } else if (!Array.isArray(scenarioData.monthStatus[type][rubro][detail]) || scenarioData.monthStatus[type][rubro][detail].length !== 12) {
                                   // If it exists but is not a valid 12-element array, replace it
                                   console.warn(`Detail status for ${type}/${rubro}/${detail} is invalid. Resetting.`);
                                  scenarioData.monthStatus[type][rubro][detail] = Array(12).fill('Estimado');
                              }
                         }
                          // calculated.[gasto/ingreso]Ajustado is initialized per rubro above, details are handled inside calculateAll
                     });

                 });
             });
             // After ensuring structures exist, clean up any detail data that might be orphaned (rubro no longer exists)
             ['gastos', 'ingresos'].forEach(type => {
                 const globalRubros = appState.settings?.rubros?.[type] || [];
                 const scenarioRubros = Object.keys(scenarioData.data[type] || {});
                  scenarioRubros.forEach(rubro => {
                      if (!globalRubros.includes(rubro)) {
                           console.warn(`Rubro "${rubro}" in scenario data but not in global settings. Removing from scenario.`);
                           delete scenarioData.data[type][rubro];
                           if (type === 'gastos') delete scenarioData.monthStatus[type][rubro];
                           // Calculated data will be rebuilt in calculateAll
                           // rubroOrder will be rebuilt from remaining data or global settings
                      }
                  });
             });
         }


        // --- Lógica de Negocio y Cálculos ---
        function calculateAll(scenarioData) {
             console.log(`Recalculando TODO para: ${scenarioData?.year} - ${scenarioData?.scenarioName}`);
             if (!scenarioData) { console.error("CalculateAll: No scenario data provided."); renderEmptyState(); return; }

             // Ensure structures are complete and valid before calculating
             initializeScenarioDataForRubros(scenarioData);

             const { data, monthStatus, reserveFund, rubroOrder } = scenarioData;
             const { settings } = appState;
             const { rubros, rubroConfig, coefficientTypes, cantidadUnidades } = settings;
             const calculated = scenarioData.calculated; // Direct reference

             // Ensure calculated.ipcManual snapshot is up-to-date with settings before using it
             if (Array.isArray(settings.ipcManual) && settings.ipcManual.length === 12) {
                 calculated.ipcManual = [...settings.ipcManual];
             } else {
                 calculated.ipcManual = Array(12).fill(0); // Fallback
             }


             // --- Reset Calculated Values ---
             calculated.gastoAjustado = {}; calculated.totalGastoRubroMes = {}; calculated.totalGastoProyectadoMes = Array(12).fill(0);
             calculated.ingresoAjustado = {}; calculated.totalIngresoRubroMes = {}; calculated.totalIngresoProyectadoMes = Array(12).fill(0);
             calculated.fondoReservaMes = Array(12).fill(0);
             calculated.cuotaSobreGastosMes = Array(12).fill(0);
             calculated.cuotaIpcMes = Array(12).fill(0);
             calculated.cuotaRealBaseMes = Array(12).fill(0);

             calculated.annualTotals = {
                gastos: { __TOTAL__: 0 },
                ingresos: { __TOTAL__: 0 },
                fondoReserva: 0,
                cuotaSobreGastos: 0,
                cuotaIpc: 0,
                cuotaRealBase: 0
             };
             // Ensure annual total objects exist (redundant with initialize, but safe)
             calculated.annualTotals.gastos = { __TOTAL__: 0 };
             calculated.annualTotals.ingresos = { __TOTAL__: 0 };
             // --- End Reset ---


             // 1. Gastos Ajustados y Totales
             // Use scenario-specific rubro order if available, otherwise process all in data that are in global settings
             const gastoRubrosToProcess = (Array.isArray(rubroOrder?.gastos) && rubroOrder.gastos.length > 0
                                          ? rubroOrder.gastos
                                          : Object.keys(data?.gastos || {}))
                                          .filter(rubro => settings.rubros.gastos.includes(rubro)); // Filter by global settings

             gastoRubrosToProcess.forEach(rubro => {
                 // Ensure data structure exists for this rubro
                 if (!data.gastos || !data.gastos[rubro]) {
                    console.warn(`Data missing for gasto rubro "${rubro}" during calculation.`);
                    return;
                 }

                 // Initialize calculated structures for this rubro
                 calculated.gastoAjustado[rubro] = {};
                 calculated.totalGastoRubroMes[rubro] = Array(12).fill(0);
                 calculated.annualTotals.gastos[rubro] = 0;

                 const config = rubroConfig[rubro] || {};
                 const coefTypeKey = config.coefficientType || 'None';
                 // Get coefficient values (percentages). Ensure it's an array of 12 numbers.
                  // --- MODIFICACIÓN FIX: Ensure coefValues is a valid array of 12 numbers (percentages) ---
                 const coefValuesRaw = coefficientTypes[coefTypeKey]?.values;
                 const coefPercentages = (Array.isArray(coefValuesRaw) && coefValuesRaw.length === 12)
                                         ? coefValuesRaw.map(v => parseFloat(v || 0))
                                         : Array(12).fill(0); // Default to 0% increase
                 // --- END MODIFICACIÓN FIX ---


                 // Use scenario-specific detail order if available, otherwise process all in data
                 const detailOrder = (Array.isArray(data.gastos[rubro].detailOrder) && data.gastos[rubro].detailOrder.length > 0
                                     ? data.gastos[rubro].detailOrder
                                     : Object.keys(data.gastos[rubro].detailsData || {}))
                                     .filter(detail => data.gastos[rubro].detailsData[detail] !== undefined); // Ensure detail data exists

                 detailOrder.forEach(detail => {
                      // Ensure data and status arrays exist before accessing them
                    const baseValues = Array.isArray(data.gastos[rubro].detailsData[detail]) && data.gastos[rubro].detailsData[detail].length === 12
                                       ? data.gastos[rubro].detailsData[detail].map(v => parseFloat(v || 0))
                                       : Array(12).fill(0);

                    const statusArray = (monthStatus.gastos && monthStatus.gastos[rubro] && Array.isArray(monthStatus.gastos[rubro][detail]) && monthStatus.gastos[rubro][detail].length === 12)
                                         ? monthStatus.gastos[rubro][detail]
                                         : Array(12).fill('Estimado'); // Default to Estimado if no status or invalid

                     calculated.gastoAjustado[rubro][detail] = Array(12).fill(0); // Initialize adjusted array for detail

                     // The `calculated.gastoAjustado` array for a detail should directly store the final value for each month:
                     // - The loaded value if the month is REAL.
                     // - The *projected* value if the month is ESTIMADO *after* the last REAL month (this is handled by `recalculateEstimates`).
                     // - The loaded value (likely 0) if the month is ESTIMADO *before* the first REAL month.
                     // So, in `calculateAll`, we just use the values already placed in `data.gastos[rubro].detailsData[detail]` by the load or recalculateEstimates process.

                     const finalDetailValues = Array(12).fill(0); // Array to store final values for this detail

                     for (let i = 0; i < 12; i++) {
                          // Use the value directly from the source data, which has been populated by load or recalculateEstimates
                          finalDetailValues[i] = baseValues[i]; // baseValues is derived from scenarioData.data here

                          // Add to monthly total for the rubro using this final value
                          calculated.totalGastoRubroMes[rubro][i] += finalDetailValues[i];
                     }
                     calculated.gastoAjustado[rubro][detail] = finalDetailValues; // Store the final values


                 });

                 // Sum monthly totals for the rubro to overall monthly/annual totals
                 for (let i = 0; i < 12; i++) {
                     const monthTotalRubro = calculated.totalGastoRubroMes[rubro]?.[i] || 0;
                     calculated.totalGastoProyectadoMes[i] += monthTotalRubro;
                     calculated.annualTotals.gastos[rubro] += monthTotalRubro;
                 }
             });
             calculated.annualTotals.gastos.__TOTAL__ = calculated.totalGastoProyectadoMes.reduce((a, b) => a + (b || 0), 0);


             // 2. Ingresos Ajustados & Totales & Expensa Real Base Extraction
             const unidades = parseInt(cantidadUnidades) || 1;
             // Use scenario-specific rubro order if available, otherwise process all in data that are in global settings
             const ingresoRubrosToProcess = (Array.isArray(rubroOrder?.ingresos) && rubroOrder.ingresos.length > 0
                                            ? rubroOrder.ingresos
                                            : Object.keys(data?.ingresos || {}))
                                            .filter(rubro => settings.rubros.ingresos.includes(rubro)); // Filter by global settings


             ingresoRubrosToProcess.forEach(rubro => {
                  // Ensure data structure exists for this rubro
                  if (!data.ingresos || !data.ingresos[rubro]) {
                     console.warn(`Data missing for ingreso rubro "${rubro}" during calculation.`);
                     return;
                  }

                 calculated.ingresoAjustado[rubro] = {}; // Stores BASE values for detail display
                 calculated.totalIngresoRubroMes[rubro] = Array(12).fill(0); // Stores FINAL calculated value (incl. UF mult)
                 calculated.annualTotals.ingresos[rubro] = 0;

                 // Use scenario-specific detail order if available, otherwise process all in data
                 const detailOrder = (Array.isArray(data.ingresos[rubro].detailOrder) && data.ingresos[rubro].detailOrder.length > 0
                                     ? data.ingresos[rubro].detailOrder
                                     : Object.keys(data.ingresos[rubro].detailsData || {}))
                                     .filter(detail => data.ingresos[rubro].detailsData[detail] !== undefined); // Ensure detail data exists


                 detailOrder.forEach(detail => {
                      const baseValues = Array.isArray(data.ingresos[rubro].detailsData[detail]) && data.ingresos[rubro].detailsData[detail].length === 12
                                         ? data.ingresos[rubro].detailsData[detail].map(v => parseFloat(v || 0))
                                         : Array(12).fill(0);

                     // Store BASE values in 'ingresoAjustado' for the detail table display
                     calculated.ingresoAjustado[rubro][detail] = baseValues;

                     // Calculate the contribution of this detail's BASE value to the monthly rubro total (before UF mult)
                     for (let i = 0; i < 12; i++) {
                         calculated.totalIngresoRubroMes[rubro][i] += baseValues[i];
                     }
                 });

                 // After summing all details for the rubro, apply multiplication if it's a special rubro
                 if (SPECIAL_INGRESO_RUBROS.includes(rubro)) {
                     for (let i = 0; i < 12; i++) {
                         calculated.totalIngresoRubroMes[rubro][i] *= unidades;
                     }
                 }

                 // Sum the final calculated monthly totals for the rubro to the overall ingreso totals and annuals
                 for (let i = 0; i < 12; i++) {
                     const monthTotalRubroFinal = calculated.totalIngresoRubroMes[rubro]?.[i] || 0;
                     calculated.totalIngresoProyectadoMes[i] += monthTotalRubroFinal;
                     calculated.annualTotals.ingresos[rubro] += monthTotalRubroFinal;
                 }
             });
             calculated.annualTotals.ingresos.__TOTAL__ = calculated.totalIngresoProyectadoMes.reduce((a, b) => a + (b || 0), 0);

            // MODIFICACIÓN INICIO - Cálculo de Expensa Real ($/UF)
             // --- Calcular Expensa Real ($/UF) dividiendo el total del rubro CUOTA_RUBRO_NAME por UF ---
             // Obtener la cantidad de UF desde settings (ya obtenida arriba, pero la re-obtenemos por claridad en el bloque)
             const unidadesParaExpensaReal = parseInt(settings.cantidadUnidades) || 1;

             if (unidadesParaExpensaReal <= 0) {
                  console.warn("Cantidad de Unidades Funcionales es cero o inválida. No se puede calcular Cuota Real Base por UF.");
                  // Si las unidades son cero o menos, la Expensa Real por UF es cero. Asegurar array de 12 ceros.
                 calculated.cuotaRealBaseMes = Array(12).fill(0);
             } else if (calculated.totalIngresoRubroMes?.[CUOTA_RUBRO_NAME]) {
                 // Si el rubro CUOTA_RUBRO_NAME existe y tiene totales calculados (ya multiplicados por UF)...
                 calculated.cuotaRealBaseMes = Array(12); // Reinicializar array para este cálculo
                 for (let i = 0; i < 12; i++) {
                     const totalRubroMes = calculated.totalIngresoRubroMes[CUOTA_RUBRO_NAME][i] || 0;
                     // ... dividir ese total (que ya incluye la mult. por UF) por la cantidad de UF para obtener el valor por UF
                     calculated.cuotaRealBaseMes[i] = totalRubroMes / unidadesParaExpensaReal;
                 }
             } else {
                 // Si el rubro CUOTA_RUBRO_NAME no existe, la Expensa Real por UF es cero. Asegurar array de 12 ceros.
                 calculated.cuotaRealBaseMes = Array(12).fill(0);
             }

             // Calcular el total anual para la Expensa Real por UF (basado en los valores mensuales recién calculados)
             calculated.annualTotals.cuotaRealBase = calculated.cuotaRealBaseMes.reduce((a,b)=>a+(b||0),0);
            // MODIFICACIÓN FIN


             // 3. Fondo Reserva
             // Ensure reserveFund values array is 12 elements (validated in initialize, but check again for safety)
              const reserveValues = Array.isArray(reserveFund?.values) && reserveFund.values.length === 12
                                     ? reserveFund.values.map(v => parseFloat(v || 0))
                                     : Array(12).fill(reserveFund?.type === 'fixed' ? 0 : 5);

             for (let i = 0; i < 12; i++) {
                 const reserveValueInput = reserveValues[i];
                 calculated.fondoReservaMes[i] = reserveFund?.type === 'percent'
                     ? (calculated.totalGastoProyectadoMes[i] || 0) * (reserveValueInput / 100)
                     : reserveValueInput;
             }
             calculated.annualTotals.fondoReserva = calculated.fondoReservaMes.reduce((a, b) => a + (b || 0), 0);


             // 4. Cuota Sobre Gastos (Gasto + Fondo / UF)
             const unidadesParaCuotaSobreGastos = parseInt(settings.cantidadUnidades) || 1;
             for (let i = 0; i < 12; i++) {
                 const totalGastoYFondo = (calculated.totalGastoProyectadoMes[i] || 0) + (calculated.fondoReservaMes[i] || 0);
                 calculated.cuotaSobreGastosMes[i] = unidadesParaCuotaSobreGastos > 0 ? totalGastoYFondo / unidadesParaCuotaSobreGastos : 0;
             }
             calculated.annualTotals.cuotaSobreGastos = calculated.cuotaSobreGastosMes.reduce((a,b)=>a+(b||0),0);


             // 5. Cuota IPC usando Expensa Real ($/UF) de Enero como base y acumulando IPC mes a mes
             // Este bloque utiliza calculated.cuotaRealBaseMes que contiene el valor por UF
             {
                 const baseEnero = (calculated.cuotaRealBaseMes?.[0] || 0); // Usa el valor de Enero de la columna "Expensa Real ($/UF)"
                  // Ensure ipcManual snapshot is a valid array of 12 numbers (percentages)
                  const ipcSnapshot = (Array.isArray(calculated.ipcManual) && calculated.ipcManual.length === 12)
                                      ? calculated.ipcManual.map(v => parseFloat(v || 0))
                                      : Array(12).fill(0); // Default to 0%

                 const ipcEnero  = ipcSnapshot[0];
                 // --- MODIFICACIÓN FIX: Apply IPC as cumulative multiplier ---
                 calculated.cuotaIpcMes[0] = baseEnero * (1 + ipcEnero / 100);
                 for (let i = 1; i < 12; i++) {
                     const ipc = ipcSnapshot[i];
                      calculated.cuotaIpcMes[i] = (calculated.cuotaIpcMes[i - 1] || 0) * (1 + ipc / 100); // Acumula sobre el mes anterior
                 }
                  // --- END MODIFICACIÓN FIX ---
             }
             // 6. Calculate Annual Totals for new/modified columns
             calculated.annualTotals.cuotaIpc = calculated.cuotaIpcMes.reduce((a, b) => a + (b || 0), 0);


             console.log("Recálculo Finalizado.", calculated);
             saveState(); // Save state after successful calculation
             updateUI(); // Update the display
             showSnackbar("Cálculos actualizados correctamente.", false, 'success');
        }

        // --- Recalcular Estimados (ACUMULATIVO) ---
        
function recalculateEstimates() {
    const scenarioData = getCurrentScenarioData();
    if (!scenarioData) { showSnackbar("No hay escenario activo.", true, 'error'); return; }
    const { data, monthStatus } = scenarioData;
    const { rubroConfig = {}, coefficientTypes = {} } = appState.settings;
    const resolveCoef=(k)=>{if(!k)k='None';if(coefficientTypes[k])return (coefficientTypes[k].values||[]).map(toNumber);const f=Object.keys(coefficientTypes).find(x=>(coefficientTypes[x].name||'').toLowerCase()===k.toLowerCase());return f?(coefficientTypes[f].values||[]).map(toNumber):Array(12).fill(0);};
    const isReal=s=>(s||'').toString().trim().toUpperCase()==='REAL';
    let upd=0;
    for(const rubro in (data.gastos||{})){
        const rubroData=data.gastos[rubro];
        if(!rubroData||!rubroData.detailsData)continue;
        const coefKey=(rubroConfig[rubro]?.coefficientType)||'None';
        const coefVals=resolveCoef(coefKey);
        for(const det in rubroData.detailsData){
            const vals=rubroData.detailsData[det];
            const statRow=(monthStatus.gastos&&monthStatus.gastos[rubro]&&monthStatus.gastos[rubro][det])?monthStatus.gastos[rubro][det]:Array(12).fill('ESTIMADO');
            let lastReal=-1;
            for(let i=11;i>=0;i--){if(isReal(statRow[i])&&toNumber(vals[i])>0){lastReal=i;break;}}
            if(lastReal===-1||lastReal===11)continue;
            let prev=toNumber(vals[lastReal]);
            for(let m=lastReal+1;m<12;m++){
                if(isReal(statRow[m])){prev=toNumber(vals[m]);continue;}
                let newVal;
                if(coefKey==='None'||coefKey.toLowerCase().includes('sin coef')){ newVal=prev; }
                else{
                    const pct=toNumber(coefVals[m]);
                    const mult=1+pct/100;
                    newVal= prev*mult;
                }
                if(!isFinite(newVal)) newVal=prev;
                vals[m]=newVal;
                prev=newVal;
                upd++;
            }
        }
    }
    if(upd){showSnackbar(`Estimados recalculados: ${upd} celdas.`,false,'success');saveState();updateUI();}
    else{showSnackbar('No se proyectó nada.',false,'info');}
}



// --- Sincroniza coeficientes que contengan 'ipc' con índices IPC ----
function syncIPCToCoefficient() {
    const ipcVals = (appState?.settings?.ipcManual)||[];
    if (!Array.isArray(ipcVals) || ipcVals.length!==12) return;
    Object.keys(appState.settings.coefficientTypes).forEach(k=>{
        const ct = appState.settings.coefficientTypes[k];
        const name = (ct.name||k).toLowerCase();
        if (name.includes('ipc')) {
            ct.values = ipcVals.map(v=>parseFloat(v||0));
            ct.isDefault = true; // bloqueado
        }
    });
}

// hacer un sync inicial al cargar
document.addEventListener('DOMContentLoaded', ()=> {
    try{ syncIPCToCoefficient(); }catch(e){ console.warn('syncIPC init:',e); }
});

// --- Reemplazo completo de recalculateEstimates ---
function recalculateEstimates() {
    const scenarioData = getCurrentScenarioData();
    if (!scenarioData) { showSnackbar("No hay escenario activo.", true, 'error'); return; }
    const { data, monthStatus } = scenarioData;
    const { rubroConfig = {}, coefficientTypes = {} } = appState.settings;
    const resolveCoef = (key) => {
        if (!key) key='None';
        if (coefficientTypes[key]) return (coefficientTypes[key].values||[]).map(toNumber);
        const foundKey = Object.keys(coefficientTypes).find(k=> (coefficientTypes[k].name||'').toLowerCase() === key.toLowerCase());
        return foundKey ? (coefficientTypes[foundKey].values||[]).map(toNumber) : Array(12).fill(0);
    };
    const isReal = s => (s||'').toString().trim().toUpperCase()==='REAL';
    let updated = 0;

    for (const rubro of Object.keys(data.gastos||{})) {
        const rubroData = data.gastos[rubro];
        if (!rubroData || !rubroData.detailsData) continue;
        const coefKey = (rubroConfig[rubro]?.coefficientType)||'None';
        const coefVals = resolveCoef(coefKey);
        for (const detail of Object.keys(rubroData.detailsData)) {
            const vals = rubroData.detailsData[detail];
            const statRow = (monthStatus.gastos && monthStatus.gastos[rubro] && monthStatus.gastos[rubro][detail]) ? monthStatus.gastos[rubro][detail] : Array(12).fill('ESTIMADO');
            // buscar último real con valor numérico >0
            let lastRealIdx = -1;
            for (let i = 11; i >=0; i--) {
                if (isReal(statRow[i]) && toNumber(vals[i])!==0) { lastRealIdx = i; break; }
            }
            if (lastRealIdx === -1 || lastRealIdx === 11) continue;
            let prev = toNumber(vals[lastRealIdx]);
            for (let m = lastRealIdx+1; m<12; m++) {
                if (isReal(statRow[m])) { prev = toNumber(vals[m]); continue; }
                let newVal;
                if (coefKey==='None' || coefKey.toLowerCase().includes('sin coef')) {
                    newVal = prev;
                } else {
                    const mult = 1 + (toNumber(coefVals[m])/100);
                    newVal = prev * mult;
                }
                vals[m] = newVal;
                prev = newVal;
                updated++;
            }
        }
    }

    if (updated) {
        showSnackbar(`Estimados recalculados: ${updated} celdas.`, false, 'success');
        saveState(); updateUI();
    } else {
        showSnackbar('No se proyectó nada.', false,'info');
    }
}
</script>
<!-- CUSTOM PATCH END -->

</body>
</html>
